spec:
  module: business_manager
  version: 0.1.0
  created: 2026-01-14T13:00:00Z
  updated: 2026-01-14T13:00:00Z
  language: rust
  complexity: medium
  estimated_loc: 400
  is_state_machine: false

plan:
  - item: Comprehend and Analyze TDLib Implementation
  - item: Implement Business Manager Structure
  - item: Implement Connected Bot Management
  - item: Implement Business Chat Link Management
  - item: Implement Business Settings (Location, Work Hours, Messages)
  - item: Write Comprehensive Tests and Documentation
  - item: Review and Verify Module Compliance

success_criteria:
  code_quality:
    max_clippy_warnings: 0
    production_unwrap_calls: 0
    max_cyclomatic_complexity: 15
  
  test_coverage:
    min_tests: 50
    min_line_coverage: 80
  
  documentation:
    public_api_docs_percent: 100
    examples_required: true
  
  tdlib_alignment:
    api_compatibility: strict

dependency_matrix:
  - type: DialogId
    source: rustgram-dialog-id
    constructor: new(i64) -> DialogId
    location: dialog_id/src/lib.rs:108-110
    verified: true
  
  - type: UserId
    source: rustgram-types
    constructor: new(i64) -> Result<UserId, TypeError>
    location: types/src/ids.rs:40-51
    verified: true
  
  - type: BusinessConnectedBot
    source: rustgram-business-connected-bot
    constructor: new(UserId, BusinessRecipients, BusinessBotRights)
    location: business_connected_bot/src/lib.rs
    verified: true
  
  - type: InputBusinessChatLink
    source: rustgram-input-business-chat-link
    constructor: new(FormattedText, String)
    location: input_business_chat_link/src/lib.rs
    verified: true
  
  - type: DialogLocation
    source: rustgram-dialog-location
    constructor: new(f64, f64, Option<String>)
    location: dialog-location/src/lib.rs:66-72
    verified: true
  
  - type: BusinessWorkHours
    source: STUB REQUIRED
    constructor: TBD
    location: Create local stub or check for existing crate
    verified: false
  
  - type: BusinessGreetingMessage
    source: rustgram-business-greeting-message
    constructor: TBD
    location: business_greeting_message/src/lib.rs
    verified: true
  
  - type: BusinessAwayMessage
    source: rustgram-business-away-message
    constructor: TBD
    location: business_away_message/src/lib.rs
    verified: true
  
  - type: BusinessIntro
    source: rustgram-business-intro
    constructor: new() -> BusinessIntro
    location: business_intro/src/lib.rs:141-147
    verified: true

risk_register:
  - id: R1
    type: MISSING_DEPENDENCY
    dependency: BusinessWorkHours
    mitigation: Check if crate exists, otherwise create stub struct with schedule fields
    impact: MEDIUM
    status: NEEDS_VERIFICATION
  
  - id: R2
    type: MISSING_DEPENDENCY
    dependency: BusinessChatLinkInfo
    mitigation: Create stub with link, view_count, and click_count fields
    impact: LOW
    status: MITIGATED
  
  - id: R3
    type: THREAD_SAFETY
    dependency: Concurrent settings updates
    mitigation: Use Arc<RwLock<T>> for manager state
    impact: MEDIUM
    status: MITIGATED
  
  - id: R4
    type: STATE_COMPLEXITY
    dependency: Dialog pause state tracking
    mitigation: Use HashSet<DialogId> for pause tracking
    impact: LOW
    status: MITIGATED

reference:
  tdlib_header: references/td/td/telegram/BusinessManager.h
  tdlib_impl: references/td/td/telegram/BusinessManager.cpp
  connected_bot: references/td/td/telegram/BusinessConnectedBot.h
  chat_link: references/td/td/telegram/BusinessChatLink.h

type_definitions:
  BusinessChatLink:
    docs: |
      A business chat link that can be shared with users.
      
      Contains the link URL, title, and statistics.
    fields:
      - name: link
        type: String
        docs: The URL fragment for the link
      - name: title
        type: String
        docs: The link title
      - name: view_count
        type: i32
        docs: Number of times the link was viewed
      - name: click_count
        type: i32
        docs: Number of times the link was clicked

  BusinessChatLinkInfo:
    docs: |
      Information about a business chat link.
      
      Stub type for link details.
    fields:
      - name: link
        type: String
        docs: The full link URL
      - name: created_date
        type: i32
        docs: When the link was created
      - name: click_count
        type: i32
        docs: Number of clicks

  BusinessWorkHours:
    docs: |
      Business working hours schedule.
      
      STUB: Full implementation requires time range types.
    fields:
      - name: time_zone
        type: String
        docs: IANA time zone identifier
      - name: schedule
        type: Vec<DaySchedule>
        docs: Weekly schedule (stub)
    stub_reason: |
      Requires comprehensive time/schedule types.
      For now, provide basic structure.

api_methods:
  - name: get_business_connected_bot
    signature: |
      get_business_connected_bot(
      ) -> impl Future<Output = Result<BusinessConnectedBot, Error>>
    docs: |
      Get the currently connected business bot.
      
      Returns error if no bot is connected.
    returns: Future yielding connected bot info
    thread_safety: Thread-safe (read-only)

  - name: set_business_connected_bot
    signature: |
      set_business_connected_bot(
          bot: BusinessConnectedBot,
      ) -> impl Future<Output = Result<(), Error>>
    docs: |
      Connect or update a business bot.
      
      Replaces any existing connected bot.
    params:
      - name: bot
        type: BusinessConnectedBot
        docs: Bot configuration with recipients and rights
    returns: Future completing when bot is set
    thread_safety: Thread-safe with mutex

  - name: delete_business_connected_bot
    signature: |
      delete_business_connected_bot(
          bot_user_id: UserId,
      ) -> impl Future<Output = Result<(), Error>>
    docs: |
      Disconnect a business bot.
    params:
      - name: bot_user_id
        type: UserId
        docs: The bot to disconnect
    returns: Future completing when bot is removed
    thread_safety: Thread-safe

  - name: toggle_business_connected_bot_dialog_is_paused
    signature: |
      toggle_business_connected_bot_dialog_is_paused(
          dialog_id: DialogId,
          is_paused: bool,
      ) -> impl Future<Output = Result<(), Error>>
    docs: |
      Pause or resume bot responses in a specific dialog.
      
      When paused, the connected bot will not respond in this dialog.
    params:
      - name: dialog_id
        type: DialogId
        docs: The dialog to modify
      - name: is_paused
        type: bool
        docs: Whether to pause (true) or resume (false)
    returns: Future completing when state is updated
    thread_safety: Thread-safe

  - name: remove_business_connected_bot_from_dialog
    signature: |
      remove_business_connected_bot_from_dialog(
          dialog_id: DialogId,
      ) -> impl Future<Output = Result<(), Error>>
    docs: |
      Remove the business bot from a specific dialog.
      
      The bot will no longer have access to this dialog.
    params:
      - name: dialog_id
        type: DialogId
        docs: The dialog to remove bot from
    returns: Future completing when bot is removed
    thread_safety: Thread-safe

  - name: get_business_chat_links
    signature: |
      get_business_chat_links(
      ) -> impl Future<Output = Result<BusinessChatLinks, Error>>
    docs: |
      Get all business chat links for the account.
    returns: Future yielding list of chat links
    thread_safety: Thread-safe (read-only)

  - name: create_business_chat_link
    signature: |
      create_business_chat_link(
          link_info: InputBusinessChatLink,
      ) -> impl Future<Output = Result<BusinessChatLink, Error>>
    docs: |
      Create a new business chat link.
      
      Generates a unique link URL from the provided info.
    params:
      - name: link_info
        type: InputBusinessChatLink
        docs: Link configuration with text and title
    returns: Future yielding created link info
    thread_safety: Thread-safe

  - name: edit_business_chat_link
    signature: |
      edit_business_chat_link(
          link: String,
          link_info: InputBusinessChatLink,
      ) -> impl Future<Output = Result<BusinessChatLink, Error>>
    docs: |
      Edit an existing business chat link.
    params:
      - name: link
        type: String
        docs: The link URL to edit
      - name: link_info
        type: InputBusinessChatLink
        docs: New link configuration
    returns: Future yielding updated link info
    thread_safety: Thread-safe

  - name: delete_business_chat_link
    signature: |
      delete_business_chat_link(
          link: String,
      ) -> impl Future<Output = Result<(), Error>>
    docs: |
      Delete a business chat link.
      
      The link will no longer work.
    params:
      - name: link
        type: String
        docs: The link URL to delete
    returns: Future completing when link is deleted
    thread_safety: Thread-safe

  - name: get_business_chat_link_info
    signature: |
      get_business_chat_link_info(
          link: String,
      ) -> impl Future<Output = Result<BusinessChatLinkInfo, Error>>
    docs: |
      Get information and statistics for a business chat link.
    params:
      - name: link
        type: String
        docs: The link URL to query
    returns: Future yielding link info with statistics
    thread_safety: Thread-safe (read-only)

  - name: set_business_location
    signature: |
      set_business_location(
          location: DialogLocation,
      ) -> impl Future<Output = Result<(), Error>>
    docs: |
      Set the business location displayed on the profile.
    params:
      - name: location
        type: DialogLocation
        docs: Geographic location with optional address
    returns: Future completing when location is set
    thread_safety: Thread-safe

  - name: set_business_work_hours
    signature: |
      set_business_work_hours(
          work_hours: BusinessWorkHours,
      ) -> impl Future<Output = Result<(), Error>>
    docs: |
      Set business working hours.
      
      When set, the profile shows when the business is available.
    params:
      - name: work_hours
        type: BusinessWorkHours
        docs: Weekly schedule with time zone
    returns: Future completing when schedule is set
    thread_safety: Thread-safe

  - name: set_business_greeting_message
    signature: |
      set_business_greeting_message(
          greeting_message: BusinessGreetingMessage,
      ) -> impl Future<Output = Result<(), Error>>
    docs: |
      Set the automatic greeting message for new chats.
      
      Sent to users when they first message the business.
    params:
      - name: greeting_message
        type: BusinessGreetingMessage
        docs: Greeting message configuration
    returns: Future completing when greeting is set
    thread_safety: Thread-safe

  - name: set_business_away_message
    signature: |
      set_business_away_message(
          away_message: BusinessAwayMessage,
      ) -> impl Future<Output = Result<(), Error>>
    docs: |
      Set the automatic away message for outside work hours.
      
      Sent when the business is closed.
    params:
      - name: away_message
        type: BusinessAwayMessage
        docs: Away message configuration with schedule
    returns: Future completing when away message is set
    thread_safety: Thread-safe

  - name: set_business_intro
    signature: |
      set_business_intro(
          intro: BusinessIntro,
      ) -> impl Future<Output = Result<(), Error>>
    docs: |
      Set the business introduction/start page.
      
      Shown when users first open the business profile.
    params:
      - name: intro
        type: BusinessIntro
        docs: Introduction with title, description, optional sticker
    returns: Future completing when intro is set
    thread_safety: Thread-safe

test_plan:
  unit_tests:
    - test_manager_new
    - test_get_connected_bot_when_set
    - test_get_connected_bot_when_none
    - test_set_connected_bot
    - test_set_connected_bot_replace_existing
    - test_delete_connected_bot
    - test_delete_connected_bot_not_found
    - test_toggle_dialog_paused
    - test_toggle_dialog_resumed
    - test_remove_bot_from_dialog
    - test_get_chat_links_empty
    - test_get_chat_links_with_links
    - test_create_chat_link
    - test_edit_chat_link
    - test_edit_chat_link_not_found
    - test_delete_chat_link
    - test_delete_chat_link_not_found
    - test_get_chat_link_info
    - test_get_chat_link_info_not_found
    - test_set_business_location
    - test_set_business_work_hours
    - test_set_business_greeting_message
    - test_set_business_away_message
    - test_set_business_intro
    - test_concurrent_settings_updates
    - test_pause_multiple_dialogs

  edge_cases:
    - Empty chat link text
    - Chat link URL already exists
    - Edit non-existent chat link
    - Remove bot from already paused dialog
    - Set empty work hours
    - Set greeting message with empty text
    - Set location with invalid coordinates
    - Concurrent updates to same setting

tdlib_deviations:
  - description: Actor pattern replaced with async/await
    rationale: Rust async ecosystem prefers async/await over actor model
    impact: API remains compatible, internal implementation differs
  
  - description: BusinessWorkHours as stub
    rationale: Full time/schedule types not yet implemented
    impact: Can still set basic hours, full implementation later
  
  - description: BusinessChatLinkInfo as stub
    rationale: Statistics fields only, no complex query logic needed
    impact: None, matches TDLib structure
