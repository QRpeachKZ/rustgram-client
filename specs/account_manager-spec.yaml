spec:
  module: account_manager
  version: 0.1.0
  created: 2025-01-14T00:00:00Z
  updated: 2025-
  lifetime: 1800-2200
  is_state_machine: false

plan:
  - item: Comprehend and Analyze TDLib Implementation
  - item: Implement Core Types (Session, ConnectedWebsite, UnconfirmedAuthorization)
  - item: Implement SessionType Enum
  - item: Implement AccountManager Structure with Storage
  - item: Implement Network Query Handlers (11+ queries)
  - item: Implement Binlog Event Handlers (9 event types)
  - item: Implement Age Verification Parameters Handling
  - item: Implement Unconfirmed Authorization Management
  - item: Write Comprehensive Tests and Documentation
  - item: Review and Verify Module Compliance

success_criteria:
  code_quality:
    max_clippy_warnings: 0
    production_unwrap_calls: 0
    max_cyclomatic_complexity: 15

  test_coverage:
    min_tests: 70
    min_line_coverage: 80

  documentation:
    public_api_docs_percent: 100
    examples_required: true

  tdlib_alignment:
    api_compatibility: strict

dependency_matrix:
  - type: AgeVerificationParameters
    source: rustgram-age_verification_parameters
    constructor: with_params(bool, &str, &str, i32) -> Option<Self>
    location: age_verification_parameters/src/lib.rs:87-128
    verified: true

  - type: UserId
    source: rustgram-types
    constructor: new(i64) -> Result<UserId, TypeError>
    location: types/src/ids.rs:40-51
    verified: true

  - type: authorization
    source: TL STUB REQUIRED
    constructor: TBD
    location: Create in tl.rs module
    verified: false

  - type: webAuthorization
    source: TL STUB REQUIRED
    constructor: TBD
    location: Create in tl.rs module
    verified: false

  - type: BinlogEvent
    source: EXTERNAL SYSTEM
    constructor: Provided by storage layer
    location: Will be stubbed for current implementation
    verified: false

risk_register:
  - id: R1
    type: MISSING_DEPENDENCY
    dependency: TL types (authorization, webAuthorization)
    mitigation: Create TL stub enums in tl.rs module with all required variants
    impact: MEDIUM
    status: MITIGATED

  - id: R2
    type: SERIALIZATION
    dependency: Binlog event serialization
    mitigation: Implement store/parse methods for all log event types
    impact: MEDIUM
    status: MITIGATED

  - id: R3
    type: THREAD_SAFETY
    dependency: Concurrent session updates
    mitigation: Use Arc<RwLock<T>> for unconfirmed authorizations
    impact: MEDIUM
    status: MITIGATED

  - id: R4
    type: STATE_COMPLEXITY
    dependency: Unconfirmed authorization timeout management
    mitigation: Use tokio::time::timeout for auto-expiration
    impact: LOW
    status: MITIGATED

  - id: R5
    type: MISSING_DEPENDENCY
    dependency: UserId conversion for connected websites
    mitigation: Use UserId type from rustgram-types
    impact: LOW
    status: MITIGATED

  - id: R6
    type: NETWORK_QUERY
    dependency: 11+ different network query handlers
    mitigation: Create separate handler types for each query
    impact: MEDIUM
    status: MITIGATED

reference:
  tdlib_header: references/td/td/telegram/AccountManager.h
  tdlib_impl: references/td/td/telegram/AccountManager.cpp
  age_verification: references/td/td/telegram/AgeVerificationParameters.h
  tdlib_api: references/td/td/generate/scheme/td_api.tl

type_definitions:
  SessionType:
    docs: |
      Represents the type of device/browser for a session.

      Determined from device_model, platform, and system_version strings.
    variants:
      - name: Android
        docs: Session running on Android device

      - name: Apple
        docs: Session running on generic Apple device

      - name: Iphone
        docs: Session running on iPhone

      - name: Ipad
        docs: Session running on iPad

      - name: Mac
        docs: Session running on Mac

      - name: Windows
        docs: Session running on Windows

      - name: Linux
        docs: Session running on Linux

      - name: Ubuntu
        docs: Session running on Ubuntu

      - name: Chrome
        docs: Session running on Chrome browser

      - name: Firefox
        docs: Session running on Firefox browser

      - name: Safari
        docs: Session running on Safari browser

      - name: Edge
        docs: Session running on Edge browser

      - name: Opera
        docs: Session running on Opera browser

      - name: Vivaldi
        docs: Session running on Vivaldi browser

      - name: Brave
        docs: Session running on Brave browser

      - name: Xbox
        docs: Session running on Xbox console

      - name: Unknown
        docs: Session type could not be determined

  Session:
    docs: |
      Contains information about one session in a Telegram application.

      Sessions must be shown to the user in the returned order.
    fields:
      - name: id
        type: i64
        docs: Session identifier (authorization hash)

      - name: is_current
        type: bool
        docs: True if this is the current session

      - name: is_password_pending
        type: bool
        docs: True if 2FA password is needed to complete authorization

      - name: is_unconfirmed
        type: bool
        docs: True if session wasn't confirmed from another session

      - name: can_accept_secret_chats
        type: bool
        docs: True if incoming secret chats can be accepted

      - name: can_accept_calls
        type: bool
        docs: True if incoming calls can be accepted

      - name: session_type
        type: SessionType
        docs: Type of session based on system and application version

      - name: api_id
        type: i32
        docs: Telegram API identifier provided by application

      - name: application_name
        type: String
        docs: Name of application provided by application

      - name: application_version
        type: String
        docs: Version of application provided by application

      - name: is_official_application
        type: bool
        docs: True if official application or uses official api_id

      - name: device_model
        type: String
        docs: Model of device application runs on

      - name: platform
        type: String
        docs: Operating system application runs on

      - name: system_version
        type: String
        docs: Version of operating system

      - name: log_in_date
        type: i32
        docs: Unix timestamp when user logged in

      - name: last_active_date
        type: i32
        docs: Unix timestamp when session was last used

      - name: ip_address
        type: String
        docs: IP address from which session was created

      - name: location
        type: String
        docs: Human-readable description of country and region

  ConnectedWebsite:
    docs: |
      Contains information about one website the user is logged into.

      Websites use Telegram login widget for authorization.
    fields:
      - name: id
        type: i64
        docs: Website identifier (authorization hash)

      - name: domain_name
        type: String
        docs: Domain name of the website

      - name: bot_user_id
        type: UserId
        docs: User identifier of bot linked with website

      - name: browser
        type: String
        docs: Version of browser used to log in

      - name: platform
        type: String
        docs: Operating system browser is running on

      - name: log_in_date
        type: i32
        docs: Unix timestamp when user was logged in

      - name: last_active_date
        type: i32
        docs: Unix timestamp when authorization was last used

      - name: ip_address
        type: String
        docs: IP address from which user logged in

      - name: location
        type: String
        docs: Human-readable country and region description

  UnconfirmedAuthorization:
    docs: |
      Contains information about an unconfirmed session.

      Sessions need confirmation when logged in from new device.
    fields:
      - name: hash
        type: i64
        docs: Session identifier

      - name: date
        type: i32
        docs: Unix timestamp when user logged in

      - name: device
        type: String
        docs: Model of device used for session creation

      - name: location
        type: String
        docs: Human-readable description of location

  AccountTTL:
    docs: |
      Account time-to-live settings.

      Determines when account will be deleted due to inactivity.
    fields:
      - name: days
        type: i32
        docs: Number of days before account deletion (1-366)

  Sessions:
    docs: |
      Contains list of all active sessions.
    fields:
      - name: sessions
        type: Vec<Session>
        docs: List of active sessions

      - name: inactive_session_ttl_days
        type: i32
        docs: Days of inactivity before auto-termination (1-366)

  ConnectedWebsites:
    docs: |
      Contains list of connected websites.
    fields:
      - name: websites
        type: Vec<ConnectedWebsite>
        docs: List of connected websites

  UserLink:
    docs: |
      Contains HTTPS URL for user information.
    fields:
      - name: url
        type: String
        docs: The URL

      - name: expires_in
        type: i32
        docs: Seconds until link expires (0 for permanent username link)

api_methods:
  - name: set_default_message_ttl
    signature: |
      set_default_message_ttl(
          message_ttl: i32,
      ) -> impl Future<Output = Result<(), Error>>
    docs: |
      Sets default message TTL for new chats.

      TTL is in seconds. 0 means no auto-delete.
    params:
      - name: message_ttl
        type: i32
        docs: Message auto-delete time in seconds
    returns: Future completing when TTL is set
    thread_safety: Thread-safe
    tdlib_method: messages_setDefaultHistoryTTL

  - name: get_default_message_ttl
    signature: |
      get_default_message_ttl(
      ) -> impl Future<Output = Result<i32, Error>>
    docs: |
      Gets current default message TTL.

      Returns TTL in seconds. 0 means no auto-delete.
    returns: Future yielding TTL value
    thread_safety: Thread-safe (read-only)
    tdlib_method: messages_getDefaultHistoryTTL

  - name: set_account_ttl
    signature: |
      set_account_ttl(
          account_ttl: i32,
      ) -> impl Future<Output = Result<(), Error>>
    docs: |
      Sets account time-to-live.

      Account will be deleted after this many days of inactivity.
    params:
      - name: account_ttl
        type: i32
        docs: Days before account deletion
    returns: Future completing when TTL is set
    thread_safety: Thread-safe
    tdlib_method: account_setAccountTTL

  - name: get_account_ttl
    signature: |
      get_account_ttl(
      ) -> impl Future<Output = Result<i32, Error>>
    docs: |
      Gets current account TTL.

      Returns number of days of inactivity before deletion.
    returns: Future yielding TTL value
    thread_safety: Thread-safe (read-only)
    tdlib_method: account_getAccountTTL

  - name: confirm_qr_code_authentication
    signature: |
      confirm_qr_code_authentication(
          link: String,
      ) -> impl Future<Output = Result<Session, Error>>
    docs: |
      Confirms QR code authentication from another session.

      Link format: tg://login?token=<base64_token>
    params:
      - name: link
        type: String
        docs: QR code authentication link
    returns: Future yielding confirmed session info
    thread_safety: Thread-safe
    tdlib_method: auth_acceptLoginToken

  - name: get_active_sessions
    signature: |
      get_active_sessions(
      ) -> impl Future<Output = Result<Sessions, Error>>
    docs: |
      Gets all active sessions for the account.

      Returns sessions sorted by relevance.
    returns: Future yielding list of sessions
    thread_safety: Thread-safe (read-only)
    tdlib_method: account_getAuthorizations

  - name: terminate_session
    signature: |
      terminate_session(
          session_id: i64,
      ) -> impl Future<Output = Result<(), Error>>
    docs: |
      Terminates a specific session.

      Cannot terminate current session.
    params:
      - name: session_id
        type: i64
        docs: Session identifier to terminate
    returns: Future completing when session is terminated
    thread_safety: Thread-safe
    tdlib_method: account_resetAuthorization

  - name: terminate_all_other_sessions
    signature: |
      terminate_all_other_sessions(
      ) -> impl Future<Output = Result<(), Error>>
    docs: |
      Terminates all sessions except the current one.

      Also clears unconfirmed authorizations.
    returns: Future completing when sessions are terminated
    thread_safety: Thread-safe
    tdlib_method: auth_resetAuthorizations

  - name: confirm_session
    signature: |
      confirm_session(
          session_id: i64,
      ) -> impl Future<Output = Result<(), Error>>
    docs: |
      Confirms an unconfirmed session.

      Removes session from unconfirmed list.
    params:
      - name: session_id
        type: i64
        docs: Session identifier to confirm
    returns: Future completing when session is confirmed
    thread_safety: Thread-safe
    tdlib_method: account_changeAuthorizationSettings

  - name: toggle_session_can_accept_calls
    signature: |
      toggle_session_can_accept_calls(
          session_id: i64,
          can_accept_calls: bool,
      ) -> impl Future<Output = Result<(), Error>>
    docs: |
      Toggles whether a session can accept calls.

      session_id=0 modifies current session setting.
    params:
      - name: session_id
        type: i64
        docs: Session identifier (0 for current)
      - name: can_accept_calls
        type: bool
        docs: Whether calls can be accepted
    returns: Future completing when setting is updated
    thread_safety: Thread-safe
    tdlib_method: account_changeAuthorizationSettings

  - name: toggle_session_can_accept_secret_chats
    signature: |
      toggle_session_can_accept_secret_chats(
          session_id: i64,
          can_accept_secret_chats: bool,
      ) -> impl Future<Output = Result<(), Error>>
    docs: |
      Toggles whether a session can accept secret chats.
    params:
      - name: session_id
        type: i64
        docs: Session identifier
      - name: can_accept_secret_chats
        type: bool
        docs: Whether secret chats can be accepted
    returns: Future completing when setting is updated
    thread_safety: Thread-safe
    tdlib_method: account_changeAuthorizationSettings

  - name: set_inactive_session_ttl_days
    signature: |
      set_inactive_session_ttl_days(
          authorization_ttl_days: i32,
      ) -> impl Future<Output = Result<(), Error>>
    docs: |
      Sets TTL for inactive sessions.

      Sessions inactive for this many days will be auto-terminated.
    params:
      - name: authorization_ttl_days
        type: i32
        docs: Days before auto-termination (1-366)
    returns: Future completing when TTL is set
    thread_safety: Thread-safe
    tdlib_method: account_setAuthorizationTTL

  - name: get_connected_websites
    signature: |
      get_connected_websites(
      ) -> impl Future<Output = Result<ConnectedWebsites, Error>>
    docs: |
      Gets all websites where user is logged in via Telegram.
    returns: Future yielding list of connected websites
    thread_safety: Thread-safe (read-only)
    tdlib_method: account_getWebAuthorizations

  - name: disconnect_website
    signature: |
      disconnect_website(
          website_id: i64,
      ) -> impl Future<Output = Result<(), Error>>
    docs: |
      Disconnects a specific website.
    params:
      - name: website_id
        type: i64
        docs: Website identifier to disconnect
    returns: Future completing when website is disconnected
    thread_safety: Thread-safe
    tdlib_method: account_resetWebAuthorization

  - name: disconnect_all_websites
    signature: |
      disconnect_all_websites(
      ) -> impl Future<Output = Result<(), Error>>
    docs: |
      Disconnects all connected websites.
    returns: Future completing when all websites are disconnected
    thread_safety: Thread-safe
    tdlib_method: account_resetWebAuthorizations

  - name: get_user_link
    signature: |
      get_user_link(
      ) -> impl Future<Output = Result<UserLink, Error>>
    docs: |
      Gets a link to the user's account.

      Returns username link if available, otherwise creates temporary link.
    returns: Future yielding user link
    thread_safety: Thread-safe (read-only)
    tdlib_method: contacts_exportContactToken

  - name: import_contact_token
    signature: |
      import_contact_token(
          token: String,
      ) -> impl Future<Output = Result<User, Error>>
    docs: |
      Imports a contact token to add a user.

      Token obtained from get_user_link of another user.
    params:
      - name: token
        type: String
        docs: Contact token to import
    returns: Future yielding imported user info
    thread_safety: Thread-safe
    tdlib_method: contacts_importContactToken

  - name: invalidate_authentication_codes
    signature: |
      invalidate_authentication_codes(
          authentication_codes: Vec<String>,
      )
    docs: |
      Invalidates authentication codes sent to user.

      Used when codes are no longer valid (e.g., new code requested).
    params:
      - name: authentication_codes
        type: Vec<String>
        docs: List of codes to invalidate
    returns: None (fire-and-forget)
    thread_safety: Thread-safe
    tdlib_method: account_invalidateSignInCodes

network_query_types:
  SetDefaultHistoryTtlQuery:
    docs: |
      Handler for setting default message TTL.
      Sends messages_setDefaultHistoryTTL query.

  GetDefaultHistoryTtlQuery:
    docs: |
      Handler for getting default message TTL.
      Sends messages_getDefaultHistoryTTL query.

  SetAccountTtlQuery:
    docs: |
      Handler for setting account TTL.
      Sends account_setAccountTTL query.

  GetAccountTtlQuery:
    docs: |
      Handler for getting account TTL.
      Sends account_getAccountTTL query.

  AcceptLoginTokenQuery:
    docs: |
      Handler for confirming QR code authentication.
      Sends auth_acceptLoginToken query.

  GetAuthorizationsQuery:
    docs: |
      Handler for getting active sessions.
      Sends account_getAuthorizations query.

  ResetAuthorizationQuery:
    docs: |
      Handler for terminating a session.
      Sends account_resetAuthorization query.

  ResetAuthorizationsQuery:
    docs: |
      Handler for terminating all other sessions.
      Sends auth_resetAuthorizations query.

  ChangeAuthorizationSettingsQuery:
    docs: |
      Handler for modifying session settings.
      Sends account_changeAuthorizationSettings query.

  SetAuthorizationTtlQuery:
    docs: |
      Handler for setting inactive session TTL.
      Sends account_setAuthorizationTTL query.

  GetWebAuthorizationsQuery:
    docs: |
      Handler for getting connected websites.
      Sends account_getWebAuthorizations query.

  ResetWebAuthorizationQuery:
    docs: |
      Handler for disconnecting a website.
      Sends account_resetWebAuthorization query.

  ResetWebAuthorizationsQuery:
    docs: |
      Handler for disconnecting all websites.
      Sends account_resetWebAuthorizations query.

  ExportContactTokenQuery:
    docs: |
      Handler for getting user link.
      Sends contacts_exportContactToken query.

  ImportContactTokenQuery:
    docs: |
      Handler for importing contact token.
      Sends contacts_importContactToken query.

  InvalidateSignInCodesQuery:
    docs: |
      Handler for invalidating authentication codes.
      Sends account_invalidateSignInCodes query.

binlog_event_types:
  SetDefaultHistoryTtlOnServerLogEvent:
    docs: |
      Logs default message TTL changes.
      Fields: message_ttl (i32)

  SetAccountTtlOnServerLogEvent:
    docs: |
      Logs account TTL changes.
      Fields: account_ttl (i32)

  ChangeAuthorizationSettingsOnServerLogEvent:
    docs: |
      Logs session setting changes.
      Fields: hash (i64), set_encrypted_requests_disabled (bool),
              encrypted_requests_disabled (bool),
              set_call_requests_disabled (bool),
              call_requests_disabled (bool), confirm (bool)

  InvalidateSignInCodesOnServerLogEvent:
    docs: |
      Logs authentication code invalidation.
      Fields: authentication_codes (Vec<String>)

  ResetAuthorizationOnServerLogEvent:
    docs: |
      Logs session termination.
      Fields: hash (i64)

  ResetAuthorizationsOnServerLogEvent:
    docs: |
      Logs termination of all sessions.
      Fields: (none)

  SetAuthorizationTtlOnServerLogEvent:
    docs: |
      Logs inactive session TTL changes.
      Fields: authorization_ttl_days (i32)

  ResetWebAuthorizationOnServerLogEvent:
    docs: |
      Logs website disconnection.
      Fields: hash (i64)

  ResetWebAuthorizationsOnServerLogEvent:
    docs: |
      Logs disconnection of all websites.
      Fields: (none)

tl_stubs_required:
  authorization:
    docs: |
      TL type for authorization/session info from Telegram server.

      Stub should include: hash, current, password_pending, unconfirmed,
      encrypted_requests_disabled, call_requests_disabled, api_id, app_name,
      app_version, official_app, device_model, platform, system_version,
      date_created, date_active, ip, country.

  webAuthorization:
    docs: |
      TL type for web authorization info.

      Stub should include: hash, domain, bot_id, browser, platform,
      date_created, date_active, ip, region.

state_structures:
  UnconfirmedAuthorizations:
    docs: |
      Container for unconfirmed session authorizations.

      Manages sorted list of pending confirmations with auto-expiration.
    fields:
      - name: authorizations
        type: Vec<UnconfirmedAuthorization>
        docs: Sorted list of unconfirmed sessions (by date ascending)
    behavior:
      - Adds new authorizations in date order
      - Tracks first authorization separately for update priority
      - Auto-expires old authorizations (default 7 days)
      - Emits updateUnconfirmedSession when first changes
    thread_safety: Requires Arc<RwLock<T>>

age_verification_handling:
  docs: |
    Age verification parameters manage content restrictions in certain jurisdictions.

  storage:
    - Key: "age_verification" in binlog PMC
    - Only stored if need_verification is true
    - Sent via updateAgeVerificationParameters when loaded

  updates:
    - updateAgeVerificationParameters sent when parameters change
    - Only sent if need_verification is true
    - Used by client to enforce age restrictions

unconfirmed_authorization_handling:
  docs: |
    Manages sessions that require confirmation from another device.

  storage:
    - Key: "new_authorizations" in binlog PMC
    - Serialized list of UnconfirmedAuthorization objects
    - Loaded on startup, expired entries removed

  auto_confirm:
    - Sessions auto-confirm after authorization_autoconfirm_period (default 7 days)
    - Timeout set to earliest expiration date
    - Periodic cleanup on timeout and get_active_sessions

  updates:
    - updateUnconfirmedSession sent when first authorization changes
    - Contains only the first (oldest) unconfirmed session
    - Sent with null when list becomes empty

test_plan:
  unit_tests:
    # SessionType enum tests (15+ tests)
    - test_session_type_android_from_device_model
    - test_session_type_ios_from_device_model
    - test_session_type_mac_from_device_model
    - test_session_type_windows_from_platform
    - test_session_type_linux_from_platform
    - test_session_type_ubuntu_from_platform
    - test_session_type_chrome_from_web
    - test_session_type_firefox_from_web
    - test_session_type_safari_from_web
    - test_session_type_edge_from_web
    - test_session_type_opera_from_web
    - test_session_type_brave_from_web
    - test_session_type_vivaldi_from_web
    - test_session_type_xbox_from_device_model
    - test_session_type_unknown_when_no_match

    # Session struct tests (10+ tests)
    - test_session_new
    - test_session_from_authorization_tl
    - test_session_serialization
    - test_session_current_first_sorting
    - test_session_is_password_pending
    - test_session_can_accept_secret_chats
    - test_session_can_accept_calls
    - test_session_dates_valid
    - test_session_display_format

    # ConnectedWebsite tests (8+ tests)
    - test_connected_website_new
    - test_connected_website_from_web_authorization_tl
    - test_connected_website_serialization
    - test_connected_website_bot_user_id_valid
    - test_connected_website_domain_not_empty

    # UnconfirmedAuthorization tests (10+ tests)
    - test_unconfirmed_authorization_new
    - test_unconfirmed_authorization_with_valid_params
    - test_unconfirmed_authorization_hash_nonzero
    - test_unconfirmed_authorization_date_not_future
    - test_unconfirmed_authorization_serialization
    - test_unconfirmed_authorization_get_hash
    - test_unconfirmed_authorization_get_date
    - test_unconfirmed_authorization_to_object

    # UnconfirmedAuthorizations container tests (12+ tests)
    - test_unconfirmed_authorizations_empty_initially
    - test_unconfirmed_authorizations_add_first
    - test_unconfirmed_authorizations_add_multiple_sorted
    - test_unconfirmed_authorizations_add_duplicate_fails
    - test_unconfirmed_authorizations_delete_existing
    - test_unconfirmed_authorizations_delete_nonexistent_fails
    - test_unconfirmed_authorizations_delete_expired
    - test_unconfirmed_authorizations_get_first
    - test_unconfirmed_authorizations_is_empty_check
    - test_unconfirmed_authorizations_serialize
    - test_unconfirmed_authorizations_deserialize

    # AccountTTL tests (5+ tests)
    - test_account_ttl_days_valid_range
    - test_account_ttl_days_minimum
    - test_account_ttl_days_maximum
    - test_account_ttl_serialization

    # AccountManager API tests (20+ tests)
    - test_set_default_message_ttl
    - test_get_default_message_ttl
    - test_set_account_ttl
    - test_get_account_ttl
    - test_confirm_qr_code_authentication_valid
    - test_confirm_qr_code_authentication_invalid_token
    - test_get_active_sessions
    - test_terminate_session
    - test_terminate_session_not_found
    - test_terminate_all_other_sessions
    - test_confirm_session
    - test_toggle_session_can_accept_calls
    - test_toggle_session_can_accept_secret_chats
    - test_set_inactive_session_ttl_days
    - test_get_connected_websites
    - test_disconnect_website
    - test_disconnect_all_websites
    - test_get_user_link_with_username
    - test_get_user_link_without_username
    - test_import_contact_token

    # Age verification tests (5+ tests)
    - test_age_verification_parameters_update
    - test_age_verification_parameters_storage
    - test_age_verification_parameters_update_emitted
    - test_age_verification_parameters_load_from_storage

    # Binlog event tests (10+ tests)
    - test_set_default_history_ttl_log_event
    - test_set_account_ttl_log_event
    - test_change_authorization_settings_log_event
    - test_invalidate_sign_in_codes_log_event
    - test_reset_authorization_log_event
    - test_reset_authorizations_log_event
    - test_set_authorization_ttl_log_event
    - test_reset_web_authorization_log_event
    - test_reset_web_authorizations_log_event
    - test_binlog_events_replay_on_startup

    # Edge case tests (10+ tests)
    - test_empty_qr_code_link
    - test_invalid_qr_code_token
    - test_terminate_current_session_fails
    - test_confirm_already_confirmed_session
    - test_concurrent_session_termination
    - test_empty_unconfirmed_authorizations
    - test_authorization_autoconfirm_timeout
    - test_disconnect_nonexistent_website
    - test_import_invalid_contact_token
    - test_zero_inactive_session_ttl

  edge_cases:
    - QR code link with invalid base64 token
    - QR code link without tg://login prefix
    - Terminating current session (should fail)
    - Confirming already confirmed session
    - Setting TTL values outside valid range
    - Auto-confirmation of expired sessions
    - Concurrent updates to session settings
    - Empty connected websites list
    - Unconfirmed authorization with hash=0
    - Authorization date in the future
    - Age verification with empty bot username
    - Age verification with invalid country code

tdlib_deviations:
  - description: Actor pattern replaced with async/await
    rationale: Rust async ecosystem prefers async/await over actor model
    impact: API remains compatible, internal implementation differs

  - description: TL types as stubs
    rationale: Full TL layer not yet implemented in Rustgram
    impact: Stub types with all required fields, can be replaced later

  - description: Binlog events simplified
    rationale: Complex binlog system not fully ported
    impact: Events tracked in memory, persistence simplified

  - description: Promise<T> replaced with Future<Output = Result<T, Error>>
    rationale: idiomatic Rust error handling
    impact: More ergonomic API, consistent with Rust ecosystem

  - description: Authorization autoconfirm period as constant
    rationale: Option manager not yet integrated
    impact: Uses default 7-day period, can be made configurable later

implementation_notes:
  session_type_detection:
    - Platform detection from platform and system_version fields
    - Browser detection from device_model when app_name contains "Web"
    - Case-insensitive matching for all strings
    - Order: Xbox > Web browsers > Mobile platforms > Desktop > Unknown

  session_sorting:
    - Current session first
    - Password pending sessions next
    - Unconfirmed sessions next
    - Others sorted by last_active_date descending

  unconfirmed_authorization_timeout:
    - Uses tokio::time::sleep_until for expiration
    - Timeout recalculated when first authorization changes
    - Maximum timeout 1 hour to force periodic cleanup

  storage_keys:
    - "age_verification" for AgeVerificationParameters
    - "new_authorizations" for UnconfirmedAuthorizations

  thread_safety:
    - Arc<RwLock<T>> for all mutable state
    - Read operations use read() lock
    - Write operations use write() lock
    - No unwrap() in production code
