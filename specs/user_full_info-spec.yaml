# Specification: UserFullInfo Module
# Epic: User Management (user_full_info crate)
# Version: 1.0.0
# Date: 2025-01-15

metadata:
  crate_name: rustgram-user-full-info
  epic: "Epic-21 - User Management"
  priority: "high"
  complexity: "medium"
  tdlib_reference: "td/telegram/UserManager.h (UserFullInfo)"
  tl_schema: "userFullInfo@2116"

overview: |
  UserFullInfo represents comprehensive information about a Telegram user,
  including profile photos, contact settings, business info, bot details,
  and various flags about user capabilities and restrictions.

  This module provides the UserFullInfo struct with 26 fields covering
  personal photos, communication settings, paid message features,
  business accounts, and bot verification.

dependencies:
  required_crates:
    - path: "rustgram-types"
      types: ["UserId"]
      status: "exists"
    
    - path: "rustgram-formatted-text"
      types: ["FormattedText"]
      status: "exists"
    
    - path: "rustgram-birthdate"
      types: ["Birthdate"]
      status: "exists"
    
    - path: "rustgram-block-list-id"
      types: ["BlockListId"]
      status: "exists"
    
    - path: "rustgram-profile-tab"
      types: ["ProfileTab"]
      status: "exists"
    
    - path: "rustgram-bot-verification"
      types: ["BotVerification"]
      status: "exists"
    
    - path: "rustgram-business-info"
      types: ["BusinessInfo"]
      status: "exists"
    
    - path: "rustgram-star-rating"
      types: ["StarRating"]
      status: "exists"
    
    - path: "rustgram-star-gift-settings"
      types: ["StarGiftSettings"]
      status: "exists"
    
    - path: "rustgram-bot-info-manager"
      types: ["BotInfo"]
      status: "exists" # As actor-based manager
  
  missing_types:
    - name: "ChatPhoto"
      action: "create_placeholder"
      reason: "Type does not exist yet. Use Option<placeholder> for now."
      tl_schema: "chatPhoto id:int64 added_date:int32 ..."
    
    - name: "Audio"
      action: "use_file_id"
      reason: "Full audio type is complex. Use FileId as placeholder."
      tl_schema: "audio duration:int32 title:string ..."
    
    - name: "BlockList (full)"
      action: "use_block_list_id"
      reason: "Only BlockListId enum exists. Use that directly."
      tl_schema: "blockList main:Bool stories:Bool"

public_api:
  struct: UserFullInfo
  visibility: "pub"
  derive: ["Debug", "Clone", "PartialEq", "Eq"]
  fields:
    # Photo fields (3)
    - name: "personal_photo"
      type: "Option<ChatPhoto>"
      tl: "chatPhoto"
      nullable: true
      description: "Personal profile photo of the user"
    
    - name: "photo"
      type: "Option<ChatPhoto>"
      tl: "chatPhoto"
      nullable: true
      description: "Profile photo of the user"
    
    - name: "public_photo"
      type: "Option<ChatPhoto>"
      tl: "chatPhoto"
      nullable: true
      description: "Public photo of the user"
    
    # Block list (1)
    - name: "block_list"
      type: "BlockListId"
      tl: "BlockList"
      nullable: false
      description: "Block list the user is in"
    
    # Communication flags (3)
    - name: "can_be_called"
      type: "bool"
      tl: "Bool"
      default: "false"
      description: "True, if the user can be called"
    
    - name: "supports_video_calls"
      type: "bool"
      tl: "Bool"
      default: "false"
      description: "True, if the user supports video calls"
    
    - name: "has_private_calls"
      type: "bool"
      tl: "Bool"
      default: "false"
      description: "True, if the user has private calls"
    
    # Privacy flags (4)
    - name: "has_private_forwards"
      type: "bool"
      tl: "Bool"
      default: "false"
      description: "True, if the user has private forwards enabled"
    
    - name: "has_restricted_voice_and_video_note_messages"
      type: "bool"
      tl: "Bool"
      default: "false"
      description: "True, if voice/video notes are restricted"
    
    - name: "has_posted_to_profile_stories"
      type: "bool"
      tl: "Bool"
      default: "false"
      description: "True, if user posted to profile stories"
    
    - name: "has_sponsored_messages_enabled"
      type: "bool"
      tl: "Bool"
      default: "false"
      description: "True, if sponsored messages are enabled"
    
    # Privacy exception (1)
    - name: "need_phone_number_privacy_exception"
      type: "bool"
      tl: "Bool"
      default: "false"
      description: "True, if phone number privacy exception needed"
    
    # Chat background (1)
    - name: "set_chat_background"
      type: "bool"
      tl: "Bool"
      default: "false"
      description: "True, if chat background is set"
    
    # Bio (1)
    - name: "bio"
      type: "FormattedText"
      tl: "formattedText"
      nullable: false
      description: "User biography"
    
    # Birthdate (1)
    - name: "birthdate"
      type: "Option<Birthdate>"
      tl: "birthdate"
      nullable: true
      description: "User birthdate"
    
    # Personal chat (1)
    - name: "personal_chat_id"
      type: "i64"
      tl: "int53"
      default: "0"
      description: "Personal chat ID"
    
    # Gift info (1)
    - name: "gift_count"
      type: "i32"
      tl: "int32"
      default: "0"
      description: "Number of gifts received"
    
    # Groups in common (1)
    - name: "group_in_common_count"
      type: "i32"
      tl: "int32"
      default: "0"
      description: "Number of groups in common"
    
    # Paid message star counts (2)
    - name: "incoming_paid_message_star_count"
      type: "i64"
      tl: "int53"
      default: "0"
      description: "Incoming paid message star count"
    
    - name: "outgoing_paid_message_star_count"
      type: "i64"
      tl: "int53"
      default: "0"
      description: "Outgoing paid message star count"
    
    # Gift settings (1)
    - name: "gift_settings"
      type: "StarGiftSettings"
      tl: "giftSettings"
      nullable: false
      description: "Gift settings"
    
    # Bot verification (1)
    - name: "bot_verification"
      type: "Option<BotVerification>"
      tl: "botVerification"
      nullable: true
      description: "Bot verification info"
    
    # Profile tab (1)
    - name: "main_profile_tab"
      type: "ProfileTab"
      tl: "ProfileTab"
      nullable: false
      description: "Main profile tab"
    
    # First profile audio (1)
    - name: "first_profile_audio"
      type: "Option<Audio>"
      tl: "audio"
      nullable: true
      description: "First profile audio"
    
    # Rating (2)
    - name: "rating"
      type: "Option<StarRating>"
      tl: "userRating"
      nullable: true
      description: "Current user rating"
    
    - name: "pending_rating"
      type: "Option<StarRating>"
      tl: "userRating"
      nullable: true
      description: "Pending user rating"
    
    - name: "pending_rating_date"
      type: "i32"
      tl: "int32"
      default: "0"
      description: "Pending rating date (unix timestamp)"
    
    # Note (1)
    - name: "note"
      type: "FormattedText"
      tl: "formattedText"
      nullable: false
      description: "User note"
    
    # Business info (1)
    - name: "business_info"
      type: "Option<BusinessInfo>"
      tl: "businessInfo"
      nullable: true
      description: "Business account info"
    
    # Bot info (1)
    - name: "bot_info"
      type: "Option<BotInfo>"
      tl: "botInfo"
      nullable: true
      description: "Bot information"

constructors:
  - name: "new"
    visibility: "pub"
    returns: "Self"
    description: "Creates a new empty UserFullInfo with default values"
    example: |
      let info = UserFullInfo::new();
      assert!(!info.can_be_called());

  - name: "with_basic_info"
    visibility: "pub"
    parameters:
      - name: "bio"
        type: "FormattedText"
      - name: "note"
        type: "FormattedText"
    returns: "Self"
    description: "Creates UserFullInfo with basic bio and note"

getters:
  - name: "personal_photo"
    returns: "Option<&ChatPhoto>"
    const: true
    
  - name: "photo"
    returns: "Option<&ChatPhoto>"
    const: true
    
  - name: "public_photo"
    returns: "Option<&ChatPhoto>"
    const: true
    
  - name: "block_list"
    returns: "BlockListId"
    const: true
    
  - name: "can_be_called"
    returns: "bool"
    const: true
    
  - name: "supports_video_calls"
    returns: "bool"
    const: true
    
  - name: "has_private_calls"
    returns: "bool"
    const: true
    
  - name: "has_private_forwards"
    returns: "bool"
    const: true
    
  - name: "has_restricted_voice_and_video_note_messages"
    returns: "bool"
    const: true
    
  - name: "has_posted_to_profile_stories"
    returns: "bool"
    const: true
    
  - name: "has_sponsored_messages_enabled"
    returns: "bool"
    const: true
    
  - name: "need_phone_number_privacy_exception"
    returns: "bool"
    const: true
    
  - name: "set_chat_background"
    returns: "bool"
    const: true
    
  - name: "bio"
    returns: "&FormattedText"
    const: true
    
  - name: "birthdate"
    returns: "Option<&Birthdate>"
    const: true
    
  - name: "personal_chat_id"
    returns: "i64"
    const: true
    
  - name: "gift_count"
    returns: "i32"
    const: true
    
  - name: "group_in_common_count"
    returns: "i32"
    const: true
    
  - name: "incoming_paid_message_star_count"
    returns: "i64"
    const: true
    
  - name: "outgoing_paid_message_star_count"
    returns: "i64"
    const: true
    
  - name: "gift_settings"
    returns: "&StarGiftSettings"
    const: true
    
  - name: "bot_verification"
    returns: "Option<&BotVerification>"
    const: true
    
  - name: "main_profile_tab"
    returns: "ProfileTab"
    const: true
    
  - name: "first_profile_audio"
    returns: "Option<&Audio>"
    const: true
    
  - name: "rating"
    returns: "Option<&StarRating>"
    const: true
    
  - name: "pending_rating"
    returns: "Option<&StarRating>"
    const: true
    
  - name: "pending_rating_date"
    returns: "i32"
    const: true
    
  - name: "note"
    returns: "&FormattedText"
    const: true
    
  - name: "business_info"
    returns: "Option<&BusinessInfo>"
    const: true
    
  - name: "bot_info"
    returns: "Option<&BotInfo>"
    const: true

setters:
  - name: "set_bio"
    parameters:
      - name: "bio"
        type: "FormattedText"
    returns: "bool"
    description: "Sets bio, returns true if changed"
    
  - name: "set_note"
    parameters:
      - name: "note"
        type: "FormattedText"
    returns: "bool"
    description: "Sets note, returns true if changed"
    
  - name: "set_birthdate"
    parameters:
      - name: "birthdate"
        type: "Option<Birthdate>"
    returns: "bool"
    description: "Sets birthdate, returns true if changed"

methods:
  - name: "is_empty"
    returns: "bool"
    const: true
    description: "Returns true if all optional fields are None and counts are zero"
    
  - name: "is_bot"
    returns: "bool"
    const: true
    description: "Returns true if bot_info is Some"
    
  - name: "is_business"
    returns: "bool"
    const: true
    description: "Returns true if business_info is Some"
    
  - name: "can_receive_paid_messages"
    returns: "bool"
    const: true
    description: "Returns true if incoming_paid_message_star_count > 0"
    
  - name: "has_rating"
    returns: "bool"
    const: true
    description: "Returns true if rating is Some"

implementation_notes:
  - "Use placeholder types for ChatPhoto and Audio until those crates are created"
  - "BlockList uses BlockListId enum directly (not full BlockList type)"
  - "BotInfo should be an alias to BotInfoManager's BotInfo or similar"
  - "All optional photo fields default to None"
  - "All bool flags default to false"
  - "All counts default to 0"
  - "FormattedText fields should use FormattedText::new() for empty values"

testing:
  unit_tests:
    - name: "test_new_creates_empty"
      description: "Verify new() creates empty UserFullInfo"
    
    - name: "test_default_creates_empty"
      description: "Verify Default trait implementation"
    
    - name: "test_with_basic_info"
      description: "Test constructor with bio and note"
    
    - name: "test_all_getters"
      description: "Test all getter methods return correct values"
    
    - name: "test_all_setters"
      description: "Test all setter methods update values"
    
    - name: "test_is_empty"
      description: "Test is_empty() detection"
    
    - name: "test_is_bot"
      description: "Test is_bot() when bot_info is set"
    
    - name: "test_is_business"
      description: "Test is_business() when business_info is set"
    
    - name: "test_can_receive_paid_messages"
      description: "Test paid message detection"
    
    - name: "test_has_rating"
      description: "Test rating presence detection"
    
    - name: "test_clone"
      description: "Test Clone trait"
    
    - name: "test_equality"
      description: "Test PartialEq"
    
    - name: "test_debug"
      description: "Test Debug output"

  integration_tests:
    - name: "test_from_td_api"
      description: "Test construction from TD API values"
    
    - name: "test_to_td_api"
      description: "Test conversion to TD API format"

acceptance_criteria:
  - "Compiles without warnings"
  - "All 26 fields present with correct types"
  - "All getters return correct values"
  - "All setters update values correctly"
  - "is_empty(), is_bot(), is_business() work correctly"
  - "Clone and PartialEq implemented correctly"
  - "Unit tests pass with 80%+ coverage"
  - "Integration tests for TD API conversion pass"
