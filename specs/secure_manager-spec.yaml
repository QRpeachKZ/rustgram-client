# Specification: SecureManager
module: secure_manager
crate: rustgram-secure-manager
tdlib_reference: references/td/td/telegram/SecureManager.h
complexity: HIGH
module_type: Manager Type (NetQueryCallback)
estimated_loc: 1200-1800
estimated_tests: 50-70

description: |
  Manager for passport/secure value operations.

  SecureManager handles all secure value operations including:
  - Getting and setting passport secure values
  - Managing passport authorization forms
  - Encrypting/decrypting secure data
  - Coordinating with Telegram's passport system

  This manager processes secure values used for Telegram Passport,
  which allows users to upload identity documents for verification.

types:
  - name: SecureManager
    description: |
      Manager for passport secure values.

      Maintains cache of secure values, coordinates encryption,
      manages authorization forms for bots requesting passport data.
    fields:
      - name: parent
        type: ActorShared<()>
        description: Parent actor for lifecycle
        optional: false
      - name: refcnt
        type: i32
        description: Reference count for lifecycle
        optional: false
      - name: set_secure_value_queries
        type: HashMap<SecureValueType, ActorOwn<()>>
        description: Pending set value queries
        optional: false
      - name: secure_value_cache
        type: HashMap<SecureValueType, SecureValueWithCredentials>
        description: Cached secure values
        optional: false
      - name: authorization_forms
        type: FlatHashMap<i32, AuthorizationForm>
        description: Active authorization forms
        optional: false
      - name: max_authorization_form_id
        type: i32
        description: Next authorization form ID
        optional: false
      - name: container
        type: Container<Promise<NetQueryPtr>>
        description: Promise container for queries
        optional: false

  - name: AuthorizationForm
    description: Passport authorization form for bot
    fields:
      - name: bot_user_id
        type: UserId
        description: Bot requesting passport
        optional: false
      - name: scope
        type: String
        description: Request scope
        optional: false
      - name: public_key
        type: String
        description: Bot's public key
        optional: false
      - name: nonce
        type: String
        description: Request nonce
        optional: false
      - name: is_received
        type: bool
        description: Whether form is received
        optional: false
      - name: is_decrypted
        type: bool
        description: Whether form is decrypted
        optional: false
      - name: options
        type: HashMap<SecureValueType, SuitableSecureValue>
        description: Suitable values for each type
        optional: false
      - name: values
        type: Vec<secureValue>
        description: Form values from Telegram
        optional: false
      - name: errors
        type: Vec<SecureValueError>
        description: Form errors
        optional: false

external_dependencies:
  # Core types
  - type: UserId
    crate: rustgram-types
    constructor: new(i64)
    verified: true

  # Actor framework
  - type: ActorShared
    crate: rustgram-actor
    constructor: new(ActorId<T>)
    verified: true

  - type: ActorOwn
    crate: rustgram-actor
    constructor: new(ActorId<T>)
    verified: false
    notes: |
      CRITICAL: Not yet implemented. See secret_chats_manager spec.

  # Promise types
  - type: Promise
    crate: rustgram-promise
    constructor: new()
    verified: true

  # Network
  - type: NetQuery
    crate: rustgram-net
    constructor: various
    verified: true

  - type: NetQueryCallback
    crate: rustgram-net
    verified: false
    notes: |
      Need trait for net query callbacks.
      Stub location: crates/net/src/callback.rs

  - type: NetQueryPtr
    crate: rustgram-net
    verified: true

  # Secure storage
  - type: SecureStorage
    crate: rustgram-secure-storage
    verified: true

  - type: Secret
    crate: rustgram-secure-storage
    constructor: create_new()
    verified: true

  # Secure values (need stubs)
  - type: SecureValue
    crate: rustgram-secure-value
    verified: false
    notes: |
      CRITICAL: Entire crate missing. Need comprehensive stub
      with all passport types (PersonalDetails, Passport, etc.)
      Stub location: crates/secure_value/src/lib.rs

  - type: SecureValueType
    crate: rustgram-secure-value
    verified: false
    notes: |
      Enum of all passport types.
      Part of rustgram-secure-value crate.

  - type: SecureValueWithCredentials
    crate: rustgram-secure-value
    verified: false
    notes: |
      Secure value with encrypted credentials.
      Part of rustgram-secure-value crate.

  - type: SuitableSecureValue
    crate: rustgram-secure-value
    verified: false
    notes: |
      Suitable value for authorization form.
      Part of rustgram-secure-value crate.

  - type: SecureData
    crate: rustgram-secure-value
    verified: false
    notes: |
      Encrypted secure data.
      Part of rustgram-secure-value crate.

  - type: SecureFile
    crate: rustgram-secure-value
    verified: false
    notes: |
      Secure file reference.
      Part of rustgram-secure-value crate.

  - type: SecurePlainData
    crate: rustgram-secure-value
    verified: false
    notes: |
      Plain secure data.
      Part of rustgram-secure-value crate.

  - type: SecureCredentials
    crate: rustgram-secure-value
    verified: false
    notes: |
      Encrypted credentials.
      Part of rustgram-secure-value crate.

  # TL types (need stubs)
  - type: InputUser
    crate: TL stub
    verified: false
    notes: Create in src/tl.rs

  - type: secureValue
    crate: TL stub
    verified: false
    notes: Create in src/tl.rs

  - type: SecureValueError
    crate: TL stub
    verified: false
    notes: Create in src/tl.rs

  - type: passportElements
    crate: TL stub
    verified: false
    notes: Create in src/tl.rs

  - type: passportElementsWithErrors
    crate: TL stub
    verified: false
    notes: Create in src/tl.rs

  - type: passportAuthorizationForm
    crate: TL stub
    verified: false
    notes: Create in src/tl.rs

  - type: account_authorizationForm
    crate: TL stub
    verified: false
    notes: Create in src/tl.rs

  # Utilities
  - type: Container
    crate: rustgram-utils
    verified: false
    notes: |
      Generic promise container. Use Vec-based stub.
      Stub location: crates/utils/src/container.rs

  - type: FlatHashMap
    crate: std/external
    verified: true
    notes: Use rustc_hash::FxHashMap or std::collections::HashMap

  - type: Status
    crate: std
    verified: true
    notes: Use std::result::Result<T, E>

  - type: Unit
    crate: std
    verified: true
    notes: Use () directly

constructors:
  - name: new
    description: Creates new SecureManager
    parameters:
      - name: parent
        type: ActorShared<()>
    returns: Self

methods (public_api):
  # Secure value operations
  - name: get_secure_value
    description: Get single secure value by type
    parameters:
      - name: password
        type: String
      - name: type
        type: SecureValueType
      - name: promise
        type: Promise<TdApiSecureValue>
    returns: ()

  - name: get_all_secure_values
    description: Get all secure values for user
    parameters:
      - name: password
        type: String
      - name: promise
        type: Promise<TdApiSecureValues>
    returns: ()

  - name: set_secure_value
    description: Set/update secure value
    parameters:
      - name: password
        type: String
      - name: secure_value
        type: SecureValue
      - name: promise
        type: Promise<TdApiSecureValue>
    returns: ()

  - name: delete_secure_value
    description: Delete secure value
    parameters:
      - name: type
        type: SecureValueType
      - name: promise
        type: Promise<Unit>
    returns: ()

  - name: set_secure_value_errors
    description: Report errors in secure value
    parameters:
      - name: td
        type: &Td
      - name: input_user
        type: InputUser
      - name: errors
        type: Vec<InputPassportElementError>
      - name: promise
        type: Promise<Unit>
    returns: ()

  - name: on_get_secure_value
    description: Handle received secure value
    parameters:
      - name: value
        type: SecureValueWithCredentials
    returns: ()

  # Authorization forms
  - name: get_passport_authorization_form
    description: Get authorization form for bot
    parameters:
      - name: bot_user_id
        type: UserId
      - name: scope
        type: String
      - name: public_key
        type: String
      - name: nonce
        type: String
      - name: promise
        type: Promise<TdApiAuthorizationForm>
    returns: ()

  - name: get_passport_authorization_form_available_elements
    description: Get available elements for form
    parameters:
      - name: authorization_form_id
        type: i32
      - name: password
        type: String
      - name: promise
        type: Promise<TdApiSecureValuesWithErrors>
    returns: ()

  - name: send_passport_authorization_form
    description: Submit authorization form
    parameters:
      - name: authorization_form_id
        type: i32
      - name: types
        type: Vec<SecureValueType>
      - name: promise
        type: Promise<()>
    returns: ()

  # Utilities
  - name: get_preferred_country_language
    description: Get preferred language for country
    parameters:
      - name: country_code
        type: String
      - name: promise
        type: Promise<td_api::text>
    returns: ()

methods (private):
  - name: send_with_promise
    description: Send net query with promise callback
    parameters:
      - name: query
        type: NetQueryPtr
      - name: promise
        type: Promise<NetQueryPtr>
    returns: ()

  - name: dec_refcnt
    description: Decrement reference count
    parameters: []
    returns: ()

  - name: on_delete_secure_value
    description: Handle delete secure value result
    parameters:
      - name: type
        type: SecureValueType
      - name: promise
        type: Promise<Unit>
      - name: result
        type: Result<Unit>
    returns: ()

  - name: on_get_passport_authorization_form
    description: Handle authorization form response
    parameters:
      - name: authorization_form_id
        type: i32
      - name: promise
        type: Promise<TdApiAuthorizationForm>
      - name: r_authorization_form
        type: Result<account_authorizationForm>
    returns: ()

  - name: on_get_passport_authorization_form_secret
    description: Handle secret decryption for form
    parameters:
      - name: authorization_form_id
        type: i32
      - name: promise
        type: Promise<TdApiSecureValuesWithErrors>
      - name: r_secret
        type: Result<Secret>
    returns: ()

traits:
  - NetQueryCallback (from rustgram-net)

tl_stubs_required:
  - name: InputUser
    description: |
      ```rust
      #[derive(Debug, Clone, PartialEq)]
      pub enum InputUser {
          Empty,
          Self_,
          User { user_id: i64, access_hash: i64 },
          // TODO: all variants
      }
      ```

  - name: secureValue
    description: |
      ```rust
      #[derive(Debug, Clone, PartialEq)]
      pub struct secureValue {
          pub type_: SecureValueType,
          pub data: Option<SecureData>,
          pub front_side: Option<SecureFile>,
          pub reverse_side: Option<SecureFile>,
          pub selfie: Option<SecureFile>,
          pub translation: Vec<SecureFile>,
          pub files: Vec<SecureFile>,
          pub plain_data: Option<SecurePlainData>,
          pub hash: Vec<u8>,
          pub encrypted_secret: Vec<u8>,
      }
      ```

  - name: SecureValueError
    description: |
      ```rust
      #[derive(Debug, Clone, PartialEq)]
      pub struct SecureValueError {
          pub type_: SecureValueType,
          pub source: SecureValueErrorSource,
          pub text: String,
      }
      ```

  - name: InputPassportElementError
    description: |
      ```rust
      #[derive(Debug, Clone, PartialEq)]
      pub enum InputPassportElementError {
          // TODO: all variants
      }
      ```

missing_types_stubs:
  - name: SecureValue crate
    location: crates/secure_value/src/lib.rs
    priority: CRITICAL
    description: |
      Complete crate for passport secure values.

      ```rust
      /// Secure value for passport data.
      #[derive(Debug, Clone, PartialEq)]
      pub struct SecureValue {
          pub type_: SecureValueType,
          pub data: Option<SecureData>,
          pub front_side: Option<SecureFile>,
          pub reverse_side: Option<SecureFile>,
          pub selfie: Option<SecureFile>,
          pub translation: Vec<SecureFile>,
          pub files: Vec<SecureFile>,
          pub plain_data: Option<SecurePlainData>,
      }

      /// Secure value type.
      #[derive(Debug, Clone, Copy, PartialEq, Eq, Hash)]
      pub enum SecureValueType {
          PersonalDetails,
          Passport,
          DriverLicense,
          IdentityCard,
          InternalPassport,
          Address,
          UtilityBill,
          BankStatement,
          RentalAgreement,
          PassportRegistration,
          TemporaryRegistration,
          PhoneNumber,
          Email,
      }

      /// Encrypted secure data.
      #[derive(Debug, Clone, PartialEq)]
      pub struct SecureData {
          pub data: Vec<u8>,
          pub hash: Vec<u8>,
          pub secret: Vec<u8>,
      }

      /// Secure file reference.
      #[derive(Debug, Clone, PartialEq)]
      pub struct SecureFile {
          pub id: String,
          pub access_hash: i64,
          pub file_size: i64,
          pub dc_id: i32,
      }

      /// Plain secure data.
      #[derive(Debug, Clone, PartialEq)]
      pub enum SecurePlainData {
          PersonalDetails(PersonalDetails),
          // TODO: all variants
      }

      /// Secure value with credentials.
      #[derive(Debug, Clone, PartialEq)]
      pub struct SecureValueWithCredentials {
          pub value: SecureValue,
          pub credentials: SecureCredentials,
      }

      /// Encrypted credentials.
      #[derive(Debug, Clone)]
      pub struct SecureCredentials {
          pub data: Vec<u8>,
          pub hash: Vec<u8>,
          pub secret: Vec<u8>,
      }

      /// Suitable secure value for form.
      #[derive(Debug, Clone, PartialEq)]
      pub struct SuitableSecureValue {
          pub type_: SecureValueType,
          pub is_native: bool,
          pub can_be_saved: bool,
      }
      ```

  - name: NetQueryCallback
    location: crates/net/src/callback.rs
    priority: HIGH
    description: |
      ```rust
      /// Callback for net query results.
      pub trait NetQueryCallback {
          fn on_result(&mut self, query: NetQueryPtr);
      }
      ```

  - name: Container
    location: crates/utils/src/container.rs
    priority: MEDIUM
    description: |
      ```rust
      /// Generic promise container.
      pub struct Container<T> {
          items: Vec<T>,
      }

      impl<T> Container<T> {
          pub fn new() -> Self {
              Self { items: Vec::new() }
          }

          pub fn push(&mut self, item: T) {
              self.items.push(item);
          }
      }
      ```

test_plan:
  unit_tests: 50
  doc_tests: 8

  test_categories:
    - name: manager_creation
      cases:
        - test_new_manager
        - test_refcnt_lifecycle
        - test_hangup

    - name: secure_values
      cases:
        - test_get_secure_value
        - test_get_all_secure_values
        - test_set_secure_value
        - test_delete_secure_value
        - test_secure_value_cache

    - name: authorization_forms
      cases:
        - test_get_authorization_form
        - test_get_available_elements
        - test_send_authorization_form
        - test_form_id_generation

    - name: encryption
      cases:
        - test_encrypt_secure_value
        - test_decrypt_secure_value
        - test_password_validation

    - name: errors
      cases:
        - test_set_secure_value_errors
        - test_invalid_password
        - test_network_error_handling

    - name: utilities
      cases:
        - test_get_preferred_country_language
        - test_send_with_promise
        - test_on_result_callback

risk_register:
  - id: R1
    type: MISSING_DEPENDENCY
    description: SecureValue crate not implemented
    mitigation: Create comprehensive rustgram-secure-value crate with all passport types
    impact: HIGH
    status: TBD

  - id: R2
    type: MISSING_DEPENDENCY
    description: NetQueryCallback trait not implemented
    mitigation: Add trait to rustgram-net crate
    impact: MEDIUM
    status: TBD

  - id: R3
    type: CRYPTO_COMPLEXITY
    description: Passport encryption is complex
    mitigation: Use rustgram-secure-storage for crypto operations
    impact: HIGH
    status: TBD

  - id: R4
    type: TL_INCOMPLETE
    description: TL passport types incomplete
    mitigation: Create comprehensive TL stubs
    impact: HIGH
    status: TBD

  - id: R5
    type: CONTAINER_MISSING
    description: Container<T> not implemented
    mitigation: Create Vec-based stub
    impact: MEDIUM
    status: TBD

  - id: R6
    type: CONCURRENCY
    description: Concurrent form access
    mitigation: Use Arc<RwLock<T>> for forms cache
    impact: MEDIUM
    status: TBD

implementation_notes: |
  Key Design Decisions:

  1. Secure Value Caching:
     - Cache decrypted values by SecureValueType
     - Use SecureValueWithCredentials for encrypted storage
     - Invalidate cache on updates

  2. Authorization Forms:
     - Generate unique IDs for each form
     - Track received/decrypted state
     - Store suitable options for each type

  3. Encryption:
     - Reuse rustgram-secure-storage for crypto
     - Derive keys from password using KDF
     - Encrypt credentials separately

  4. Query Coordination:
     - Use Container<Promise<NetQueryPtr>> for pending queries
     - Implement NetQueryCallback trait for responses
     - Route responses to appropriate promises

  5. Reference Counting:
     - Use refcnt for lifecycle management
     - Decrement on hangup
     - Clean up when refcnt reaches 0

  Implementation Order:
  1. Create rustgram-secure-value crate with all types
  2. Add NetQueryCallback trait to rustgram-net
  3. Create Container<T> stub in rustgram-utils
  4. Implement SecureManager struct with basic fields
  5. Implement secure value CRUD operations
  6. Implement authorization form management
  7. Implement net query callback handling
  8. Add comprehensive tests

  Testing Strategy:
  - Test secure value encryption/decryption
  - Test authorization form lifecycle
  - Test password validation
  - Test network error handling
  - Test concurrent access patterns
  - Test cache invalidation

references:
  - td/telegram/SecureManager.h (primary)
  - td/telegram/SecureManager.cpp (implementation)
  - td/telegram/SecureValue.h (secure value types)
  - td/telegram/SecureStorage.h (encryption)
