# Specification: SecretChatsManager
module: secret_chats_manager
crate: rustgram-secret-chats-manager
tdlib_reference: references/td/td/telegram/SecretChatsManager.h
complexity: HIGH
module_type: Manager Type (Actor Coordinator)
estimated_loc: 1500-2000
estimated_tests: 60-80

description: |
  Manager for all secret chats in the system.

  SecretChatsManager coordinates multiple SecretChatActor instances,
  routing requests to the appropriate actor and managing lifecycle
  of all secret chats. Acts as a facade/proxy for secret chat operations.

  Key responsibilities:
  - Create and destroy SecretChatActor instances
  - Route updates and messages to appropriate actors
  - Manage binlog replay for secret chat events
  - Handle online/offline state for pending updates
  - Coordinate actor lifecycle with parent

types:
  - name: SecretChatsManager
    description: |
      Manager coordinating all secret chat actors.

      Maintains a map of secret_chat_id -> SecretChatActor,
      routing requests to the appropriate actor. Handles
      binlog replay and pending chat updates with online/offline
      processing.
    fields:
      - name: parent
        type: ActorShared<()>
        description: Parent actor for lifecycle management
        optional: false
      - name: use_secret_chats
        type: bool
        description: Whether secret chats are enabled
        optional: false
      - name: binlog_replay_finish_flag
        type: bool
        description: Whether binlog replay is complete
        optional: false
      - name: close_flag
        type: bool
        description: Whether manager is closing
        optional: false
      - name: is_online
        type: bool
        description: Online status for update processing
        optional: false
      - name: id_to_actor
        type: HashMap<i32, ActorOwn<SecretChatActor>>
        description: Map of chat ID to actor
        optional: false
      - name: pending_chat_updates
        type: Vec<PendingChatUpdate>
        description: Updates pending online/offline processing
        optional: false

  - name: PendingChatUpdate
    description: Chat update with online/offline processing times
    fields:
      - name: online_process_time
        type: Timestamp
        description: When to process if online
        optional: false
      - name: offline_process_time
        type: Timestamp
        description: When to process if offline
        optional: false
      - name: update
        type: updateEncryption
        description: The chat update
        optional: false

external_dependencies:
  # Core types
  - type: SecretChatId
    crate: rustgram-types
    constructor: new(i32)
    verified: true

  - type: UserId
    crate: rustgram-types
    constructor: new(i64)
    verified: true

  - type: MessageId
    crate: rustgram-types
    constructor: from_server_id(i32)
    verified: true

  # Actor framework
  - type: Actor
    crate: rustgram-actor
    verified: true

  - type: ActorShared
    crate: rustgram-actor
    constructor: new(ActorId<T>)
    verified: true

  - type: ActorId
    crate: rustgram-actor
    constructor: new(u64)
    verified: true

  - type: ActorOwn
    crate: rustgram-actor
    constructor: new(ActorId<T>)
    verified: false
    notes: |
      CRITICAL: Not yet implemented in actor crate.
      Add ActorOwn<T> struct with lifecycle management.
      Stub location: crates/actor/src/own.rs

  - type: Promise
    crate: rustgram-promise
    constructor: new()
    verified: true

  # Secret chat actors
  - type: SecretChatActor
    crate: rustgram-secret-chat-actor
    constructor: new(id, db, can_be_empty)
    verified: true

  - type: SecretChatDb
    crate: rustgram-secret-chat-db
    constructor: new(storage, chat_id)
    verified: true

  # Log events
  - type: BinlogEvent
    crate: rustgram-logevent
    verified: false
    notes: |
      CRITICAL: Not implemented. Need BinlogEvent struct
      with id, type, data, flags fields.
      Stub location: crates/logevent/src/binlog.rs

  - type: InboundSecretMessage
    crate: rustgram-logevent
    constructor: parse()
    verified: true

  - type: OutboundSecretMessage
    crate: rustgram-logevent
    constructor: parse()
    verified: true

  - type: CloseSecretChat
    crate: rustgram-logevent
    constructor: parse()
    verified: true

  - type: CreateSecretChat
    crate: rustgram-logevent
    constructor: parse()
    verified: true

  # TL types (need stubs)
  - type: updateEncryption
    crate: TL stub
    verified: false
    notes: Create in src/tl.rs

  - type: EncryptedMessage
    crate: TL stub
    verified: false
    notes: Create in src/tl.rs

  - type: decryptedMessage
    crate: TL stub
    verified: false
    notes: Create in src/tl.rs

  - type: InputEncryptedFile
    crate: TL stub
    verified: false
    notes: Create in src/tl.rs

  - type: SendMessageAction
    crate: TL stub
    verified: false
    notes: Create in src/tl.rs

  # Utilities
  - type: Timestamp
    crate: rustgram-utils
    verified: false
    notes: |
      Need Timestamp utility with now(), is_in_past(), is_in_future().
      Stub location: crates/timestamp/src/lib.rs or crates/utils/src/time.rs

  - type: Unit
    crate: std
    verified: true
    notes: Use () directly

constructors:
  - name: new
    description: Creates new SecretChatsManager
    parameters:
      - name: parent
        type: ActorShared<()>
      - name: use_secret_chats
        type: bool
    returns: Self

methods (public_api):
  # Chat lifecycle
  - name: create_chat
    description: Create new secret chat with user
    parameters:
      - name: user_id
        type: UserId
      - name: user_access_hash
        type: i64
      - name: promise
        type: Promise<SecretChatId>
    returns: ()

  - name: cancel_chat
    description: Cancel/close secret chat
    parameters:
      - name: secret_chat_id
        type: SecretChatId
      - name: delete_history
        type: bool
      - name: promise
        type: Promise<()>
    returns: ()

  # Message operations
  - name: send_message
    description: Send encrypted message
    parameters:
      - name: secret_chat_id
        type: SecretChatId
      - name: message
        type: decryptedMessage
      - name: file
        type: InputEncryptedFile
      - name: promise
        type: Promise<()>
    returns: ()

  - name: send_message_action
    description: Send typing/action notification
    parameters:
      - name: secret_chat_id
        type: SecretChatId
      - name: action
        type: SendMessageAction
    returns: ()

  - name: send_read_history
    description: Send read confirmation
    parameters:
      - name: secret_chat_id
        type: SecretChatId
      - name: date
        type: i32
      - name: promise
        type: Promise<()>
    returns: ()

  - name: send_open_message
    description: Send open message notification
    parameters:
      - name: secret_chat_id
        type: SecretChatId
      - name: random_id
        type: i64
      - name: promise
        type: Promise<()>
    returns: ()

  # Delete operations
  - name: delete_messages
    description: Delete specific messages
    parameters:
      - name: secret_chat_id
        type: SecretChatId
      - name: random_ids
        type: Vec<i64>
      - name: promise
        type: Promise<()>
    returns: ()

  - name: delete_all_messages
    description: Delete all messages in chat
    parameters:
      - name: secret_chat_id
        type: SecretChatId
      - name: promise
        type: Promise<()>
    returns: ()

  # Notifications
  - name: notify_screenshot_taken
    description: Notify that screenshot was taken
    parameters:
      - name: secret_chat_id
        type: SecretChatId
      - name: promise
        type: Promise<()>
    returns: ()

  - name: send_set_ttl_message
    description: Update message TTL
    parameters:
      - name: secret_chat_id
        type: SecretChatId
      - name: ttl
        type: i32
      - name: random_id
        type: i64
      - name: promise
        type: Promise<()>
    returns: ()

  # Update handlers
  - name: on_update_chat
    description: Handle chat update from server
    parameters:
      - name: update
        type: updateEncryption
    returns: ()

  - name: on_new_message
    description: Handle new encrypted message
    parameters:
      - name: message
        type: EncryptedMessage
      - name: promise
        type: Promise<Unit>
    returns: ()

methods (binlog):
  - name: replay_binlog_event
    description: Replay binlog event
    parameters:
      - name: binlog_event
        type: BinlogEvent
    returns: ()

  - name: binlog_replay_finish
    description: Mark binlog replay complete
    parameters: []
    returns: ()

methods (private):
  - name: get_chat_actor
    description: Get actor for chat, creating if needed
    parameters:
      - name: id
        type: i32
    returns: ActorId<SecretChatActor>

  - name: create_chat_actor
    description: Create new chat actor
    parameters:
      - name: id
        type: i32
    returns: ActorId<SecretChatActor>

  - name: create_chat_actor_impl
    description: Implementation of chat actor creation
    parameters:
      - name: id
        type: i32
      - name: can_be_empty
        type: bool
    returns: ActorId<SecretChatActor>

  - name: make_secret_chat_context
    description: Create context for secret chat actor
    parameters:
      - name: id
        type: i32
    returns: Box<SecretChatActor::Context>

  - name: flush_pending_chat_updates
    description: Process pending updates based on online state
    parameters: []
    returns: ()

  - name: do_update_chat
    description: Apply chat update
    parameters:
      - name: update
        type: updateEncryption
    returns: ()

  - name: on_online
    description: Handle online status change
    parameters:
      - name: is_online
        type: bool
    returns: ()

traits:
  - Actor (from rustgram-actor)

tl_stubs_required:
  - name: updateEncryption
    description: |
      ```rust
      #[derive(Debug, Clone, PartialEq)]
      pub struct updateEncryption {
          pub chat_id: i32,
          pub date: i32,
          // TODO: full fields
      }
      ```

  - name: EncryptedMessage
    description: |
      ```rust
      #[derive(Debug, Clone, PartialEq)]
      pub struct EncryptedMessage {
          pub random_id: i64,
          pub chat_id: i32,
          pub date: i32,
          pub bytes: Vec<u8>,
          // TODO: full fields
      }
      ```

  - name: decryptedMessage
    description: |
      ```rust
      #[derive(Debug, Clone, PartialEq)]
      pub struct decryptedMessage {
          pub random_id: i64,
          pub message: String,
          // TODO: full fields
      }
      ```

  - name: InputEncryptedFile
    description: |
      ```rust
      #[derive(Debug, Clone, PartialEq)]
      pub enum InputEncryptedFile {
          Empty,
          // TODO: all variants
      }
      ```

  - name: SendMessageAction
    description: |
      ```rust
      #[derive(Debug, Clone, PartialEq)]
      pub enum SendMessageAction {
          Typing,
          // TODO: all variants
      }
      ```

missing_types_stubs:
  - name: ActorOwn
    location: crates/actor/src/own.rs
    priority: CRITICAL
    description: |
      ```rust
      use std::marker::PhantomData;

      /// Owned actor reference with lifecycle management.
      pub struct ActorOwn<T> {
          id: ActorId<T>,
          _phantom: PhantomData<T>,
      }

      impl<T> ActorOwn<T> {
          pub fn new(id: ActorId<T>) -> Self {
              Self { id, _phantom: PhantomData }
          }

          pub fn id(&self) -> ActorId<T> {
              self.id
          }
      }
      ```

  - name: BinlogEvent
    location: crates/logevent/src/binlog.rs
    priority: CRITICAL
    description: |
      ```rust
      /// Binlog event for persistence.
      #[derive(Debug, Clone)]
      pub struct BinlogEvent {
          pub id: u64,
          pub type_: BinlogEventType,
          pub data: Vec<u8>,
          pub flags: i32,
      }

      #[derive(Debug, Clone, Copy, PartialEq, Eq)]
      pub enum BinlogEventType {
          SecretChatInbound,
          SecretChatOutbound,
          SecretChatClose,
          SecretChatCreate,
      }
      ```

  - name: Timestamp
    location: crates/timestamp/src/lib.rs
    priority: HIGH
    description: |
      ```rust
      /// Timestamp utility.
      #[derive(Debug, Clone, Copy, PartialEq)]
      pub struct Timestamp {
          pub seconds: f64,
      }

      impl Timestamp {
          pub fn now() -> Self {
              // TODO: actual time
              Self { seconds: 0.0 }
          }

          pub fn is_in_past(&self) -> bool {
              self.seconds < 0.0
          }

          pub fn is_in_future(&self) -> bool {
              self.seconds > 0.0
          }
      }
      ```

test_plan:
  unit_tests: 60
  doc_tests: 10

  test_categories:
    - name: actor_creation
      cases:
        - test_new_manager
        - test_create_chat_actor
        - test_get_existing_actor
        - test_actor_lifecycle

    - name: chat_operations
      cases:
        - test_create_chat
        - test_cancel_chat
        - test_send_message
        - test_delete_messages
        - test_delete_all_messages

    - name: update_handling
      cases:
        - test_on_update_chat
        - test_on_new_message
        - test_pending_updates_online
        - test_pending_updates_offline
        - test_flush_pending_updates

    - name: binlog_replay
      cases:
        - test_replay_inbound_message
        - test_replay_outbound_message
        - test_replay_close_chat
        - test_replay_create_chat
        - test_binlog_replay_finish

    - name: notifications
      cases:
        - test_notify_screenshot_taken
        - test_send_read_history
        - test_send_open_message
        - test_send_set_ttl_message

    - name: online_state
      cases:
        - test_online_offline_transitions
        - test_is_online_flag
        - test_update_scheduling_by_state

risk_register:
  - id: R1
    type: MISSING_DEPENDENCY
    description: ActorOwn not implemented
    mitigation: Add ActorOwn<T> to rustgram-actor crate
    impact: HIGH
    status: TBD

  - id: R2
    type: MISSING_DEPENDENCY
    description: BinlogEvent not implemented
    mitigation: Create stub in rustgram-logevent or new crate
    impact: HIGH
    status: TBD

  - id: R3
    type: MISSING_DEPENDENCY
    description: TL layer incomplete
    mitigation: Create TL stubs in src/tl.rs
    impact: HIGH
    status: TBD

  - id: R4
    type: MISSING_DEPENDENCY
    description: Timestamp utility missing
    mitigation: Create rustgram-timestamp crate or add to utils
    impact: MEDIUM
    status: TBD

  - id: R5
    type: ACTOR_LIFECYCLE
    description: Complex actor lifecycle management
    mitigation: Comprehensive tests for actor creation/destruction
    impact: MEDIUM
    status: TBD

  - id: R6
    type: CONCURRENCY
    description: Concurrent actor access
    mitigation: Use Arc<RwLock<T>> for actor map
    impact: MEDIUM
    status: TBD

implementation_notes: |
  Key Design Decisions:

  1. Actor Management:
     - Use HashMap<i32, ActorOwn<SecretChatActor>> for actor storage
     - Create actors on-demand via get_chat_actor()
     - Lazy initialization pattern

  2. Pending Updates:
     - Maintain separate online/offline processing times
     - Flush updates based on current online state
     - Prevents redundant processing

  3. Binlog Replay:
     - Replay events before processing new updates
     - Set binlog_replay_finish_flag when complete
     - Route replayed events to appropriate actors

  4. Thread Safety:
     - Use Arc<RwLock<HashMap>> for id_to_actor
     - ActorOwn provides owned reference semantics
     - No shared mutable state without synchronization

  Implementation Order:
  1. Create stub types (ActorOwn, BinlogEvent, Timestamp, TL stubs)
  2. Implement SecretChatsManager struct with basic fields
  3. Implement actor lifecycle methods (get_chat_actor, create_chat_actor)
  4. Implement public API methods (create_chat, cancel_chat, etc.)
  5. Implement binlog replay methods
  6. Implement update handling with pending queue
  7. Add comprehensive tests

  Testing Strategy:
  - Test actor creation and lifecycle
  - Test message routing to correct actors
  - Test binlog replay event handling
  - Test online/offline update processing
  - Test concurrent access patterns
  - Test error handling and edge cases

references:
  - td/telegram/SecretChatsManager.h (primary)
  - td/telegram/SecretChatsManager.cpp (implementation)
  - td/telegram/SecretChatActor.h (coordinated actor)
  - td/telegram/logevent/SecretChatEvent.h (binlog events)
