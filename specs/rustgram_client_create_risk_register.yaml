# Risk Register: RustgramClient::create() Implementation
## Task: rustgram-client-ufz.2

```yaml
register:
  # Type 1: Technical Implementation Risk
  - id: "R1"
    type: "Technical Implementation"
    title: "ClientActor::new() may panic instead of returning Result"
    description: |
      Current ClientActor::new() takes ClientActorOptions and returns Self.
      If NetQueryDispatcher::new() or other internal initialization fails,
      it could panic rather than returning a Result.
    probability: "Low"
    impact: "High"
    risk_level: "Medium"
    status: "OPEN"
    mitigation:
      strategy: "Prevention"
      actions:
        - "Review ClientActor::new() implementation for potential panics"
        - "Add try_new() method if new() can fail"
        - "Document that new() is infallible or add Result return"
      owner: "developer"
      deadline: "Before implementation start"
    contingency:
      - "If new() can fail, wrap in catch_unwind for create()"
      - "Document panic scenario in crate docs"

  - id: "R2"
    type: "Technical Implementation"
    title: "Global registry may cause memory leaks if destroy() not called"
    description: |
      GLOBAL_REGISTRY stores Arc<ClientActor> permanently.
      If users never call destroy(), ClientActor instances accumulate.
    probability: "Medium"
    impact: "Medium"
    risk_level: "Medium"
    status: "MITIGATED"
    mitigation:
      strategy: "Accept + Monitor"
      actions:
        - "Document destroy() requirement clearly"
        - "Add warning to docs if destroy() not called"
        - "Consider adding cleanup on Drop for RustgramClient (not applicable to create())"
        - "Add max_clients limit to registry with error when exceeded"
      owner: "developer"
      deadline: "Implementation phase"
    contingency:
      - "Add registry.clear() method for emergency cleanup"
      - "Consider weak registry if memory becomes issue"

  - id: "R3"
    type: "Technical Implementation"
    title: "TDLib ClientConfig field mismatch may cause confusion"
    description: |
      TDLib has additional config fields (use_test_dc, use_message_database,
      use_secret_chats, etc.) not in our ClientConfig.
    probability: "Medium"
    impact: "Low"
    risk_level: "Low"
    status: "MITIGATED"
    mitigation:
      strategy: "Documentation"
      actions:
        - "Document supported fields in ClientConfig docs"
        - "Add #[non_exhaustive] to ClientConfig"
        - "Add TODO comment for missing TDLib fields"
        - "Document that defaults are used for unsupported fields"
      owner: "developer"
      deadline: "Implementation phase"
    contingency:
      - "Add missing fields in future PR"
      - "Accept partial TDLib compatibility for MVP"

  # Type 2: API Compatibility Risk
  - id: "R4"
    type: "API Compatibility"
    title: "Async create() may not match paper-plane's sync expectations"
    description: |
      paper-plane's client_manager.rs calls tdlib::create_client() which is sync.
      Our create() is async due to registry.register().
      This may cause integration issues.
    probability: "Low"
    impact: "Medium"
    risk_level: "Low"
    status: "OPEN"
    mitigation:
      strategy: "Design"
      actions:
        - "Document async requirement clearly"
        - "Provide example of calling from glib main thread"
        - "Consider wrapper if paper-plane needs sync API"
        - "Verify paper-plane can handle async FFI boundary"
      owner: "developer"
      deadline: "Before implementation start"
    contingency:
      - "Add create_sync() wrapper that blocks on runtime"
      - "Use spawn_blocking if needed"

  - id: "R5"
    type: "API Compatibility"
    title: "ClientId collision with concurrent create() calls"
    description: |
      ClientRegistry uses AtomicI32 for ID generation.
      With concurrent creates, IDs could theoretically collide
      if fetch_add overflows or wraps.
    probability: "Very Low"
    impact: "High"
    risk_level: "Low"
    status: "MITIGATED"
    mitigation:
      strategy: "Prevention"
      actions:
        - "Use Ordering::SeqCst for fetch_add (already done)"
        - "Document that i32 overflow is extremely unlikely"
        - "Add check for overflow and error if it happens"
        - "Consider switching to AtomicU32 if needed"
      owner: "developer"
      deadline: "Implementation phase"
    contingency:
      - "Accept that 2^31 clients is unreachable in practice"
      - "Add reuse of destroyed client IDs if needed"

  # Type 3: Concurrency Risk
  - id: "R6"
    type: "Concurrency"
    title: "Global OnceLock initialization race condition"
    description: |
      If multiple threads call create() simultaneously before registry init,
      OnceLock should handle it safely, but need to verify.
    probability: "Very Low"
    impact: "Medium"
    risk_level: "Low"
    status: "MITIGATED"
    mitigation:
      strategy: "Review"
      actions:
        - "Verify OnceLock::get_or_init() is thread-safe (it is)"
        - "Add test for concurrent create() calls"
        - "Document thread-safety guarantees"
      owner: "developer"
      deadline: "Testing phase"
    contingency:
      - "OnceLock is std lib primitive, well-tested"
      - "No action needed unless test reveals issue"

  - id: "R7"
    type: "Concurrency"
    title: "Registry RwLock contention under high concurrency"
    description: |
      ClientRegistry uses RwLock for HashMap access.
      Many concurrent create/destroy calls could cause contention.
    probability: "Low"
    impact: "Low"
    risk_level: "Low"
    status: "MITIGATED"
    mitigation:
      strategy: "Monitor"
      actions:
        - "Benchmark concurrent create/destroy"
        - "Document expected concurrency limits"
        - "Add metrics if needed"
      owner: "developer"
      deadline: "Testing phase"
    contingency:
      - "Switch to lock-free HashMap if needed"
      - "Accept that TDLib has similar limitations"

  # Type 4: Testing Risk
  - id: "R8"
    type: "Testing"
    title: "Insufficient test coverage for edge cases"
    description: |
      Need to ensure create() is tested for:
      - Invalid config values
      - Registry overflow (unlikely)
      - Concurrent creates
      - destroy() of non-existent client
    probability: "Medium"
    impact: "Medium"
    risk_level: "Medium"
    status: "OPEN"
    mitigation:
      strategy: "Comprehensive Testing"
      actions:
        - "Add 8+ unit tests per spec"
        - "Add 2+ integration tests"
        - "Add concurrent stress test"
        - "Target 100% coverage for new code"
      owner: "developer"
      deadline: "Implementation phase"
    contingency:
      - "Add tests in follow-up PR if time constrained"
      - "Document test gaps in code"

  - id: "R9"
    type: "Testing"
    title: "ClientActor mock may not be realistic for tests"
    description: |
      Tests use ClientActor::new_with_defaults().
      Real actors may behave differently with actual NetQueryDispatcher.
    probability: "Low"
    impact: "Low"
    risk_level: "Low"
    status: "MITIGATED"
    mitigation:
      strategy: "Accept"
      actions:
        - "Document test limitations"
        - "Add integration test with real network if possible"
      owner: "developer"
      deadline: "Testing phase"
    contingency:
      - "Accept that unit tests use mocked actor"
      - "Integration tests cover real behavior"

  # Type 5: Integration Risk
  - id: "R10"
    type: "Integration"
    title: "paper-plane FFI boundary may not support async"
    description: |
      paper-plane uses glib main thread and may expect sync FFI calls.
      Our async create() requires tokio runtime.
    probability: "Low"
    impact: "High"
    risk_level: "Medium"
    status: "OPEN"
    mitigation:
      strategy: "Research"
      actions:
        - "Review paper-plane FFI implementation"
        - "Check if glib has async support"
        - "Consider threadpool::spawn_blocking wrapper"
      owner: "developer"
      deadline: "Before implementation start"
    contingency:
      - "Create sync wrapper that blocks on tokio runtime"
      - "Require paper-plane changes to support async"

  - id: "R11"
    type: "Integration"
    title: "Config validation mismatch with TDLib"
    description: |
      Our ClientConfig validation may differ from TDLib's.
      paper-plane may pass configs we reject (or vice versa).
    probability: "Medium"
    impact: "Low"
    risk_level: "Low"
    status: "MITIGATED"
    mitigation:
      strategy: "Align with TDLib"
      actions:
        - "Review TDLib's setTdlibParameters validation"
        - "Match TDLib error codes for validation failures"
        - "Document any differences"
      owner: "developer"
      deadline: "Implementation phase"
    contingency:
      - "Accept some differences and document"
      - "Adjust validation based on paper-plane testing"

  # Type 6: Documentation Risk
  - id: "R12"
    type: "Documentation"
    title: "Insufficient documentation for async requirement"
    description: |
      Users may not realize create() is async and requires tokio runtime.
      Could cause confusion and integration issues.
    probability: "Medium"
    impact: "Medium"
    risk_level: "Medium"
    status: "OPEN"
    mitigation:
      strategy: "Comprehensive Documentation"
      actions:
        - "Add prominent async requirement in docs"
        - "Provide example of calling from sync context"
        - "Add #[cfg(doctest)] example"
        - "Document in crate-level docs"
      owner: "developer"
      deadline: "Implementation phase"
    contingency:
      - "Add user FAQ if questions arise"
      - "Add compile-time error message if possible"

# Risk Summary
summary:
  total_risks: 12
  by_level:
    high: 0
    medium: 6
    low: 6
  by_status:
    open: 5
    mitigated: 7
    blocked: 0
  
  top_risks:
    - rank: 1
      id: "R4"
      reason: "API compatibility with paper-plane is critical"
    - rank: 2
      id: "R10"
      reason: "FFI boundary mismatch could block integration"
    - rank: 3
      id: "R1"
      reason: "ClientActor panic would be catastrophic"

# Risk Review Process
review_process:
  frequency: "Daily during implementation"
  participants:
    - "developer"
    - "client_actor crate owner"
  update_actions:
    - "Close risks when mitigations are implemented"
    - "Escalate if new risks emerge"
    - "Create GitHub issues for tracking"

# Exit Criteria
exit_criteria:
  all_risks_must_be:
    - status: "MITIGATED" or "CLOSED"
    - have_mitigation: "documented"
    - have_owner: "assigned"
  
  before_merging:
    - "No OPEN high risks"
    - "All medium risks have mitigations in place"
    - "Tests pass for all mitigated risks"
