module: paper_plane_adapter::mapper
file: crates/paper_plane_adapter/src/mapper.rs
spec:
  struct RequestMapper:
    fields:
      - name: dialog_manager
        type: DialogManager
        purpose: Manages dialog/chat operations (getChats, getChat)
        required: true
      
      - name: messages_manager
        type: Option<Arc<MessagesManager>>
        purpose: Manages message sending operations (sendMessage)
        required: false
      
      - name: user_manager
        type: Option<Arc<UserManager>>
        purpose: Manages user information (getMe, getUser, getUserFull)
        required: false
      
      - name: auth_manager
        type: Option<Arc<AuthManager>>
        purpose: Manages authentication flow (setAuthenticationPhoneNumber, checkAuthenticationCode, checkAuthenticationPassword)
        required: false
        note: NEW FIELD - must be added
      
      - name: dialog_network_client
        type: Option<Arc<DialogNetworkClient>>
        purpose: Network client for dialog operations
        required: false

    methods:
      - name: new
        visibility: public
        params:
          - name: dialog_manager
            type: DialogManager
          - name: messages_manager
            type: Option<Arc<MessagesManager>>
          - name: user_manager
            type: Option<Arc<UserManager>>
          - name: auth_manager
            type: Option<Arc<AuthManager>>
            note: NEW PARAMETER - must be added
          - name: dialog_network_client
            type: Option<Arc<DialogNetworkClient>>
        returns: Self
        async: false
        doc: Creates a new request mapper with all manager dependencies

      - name: process_request
        visibility: public
        params:
          - name: request
            type: &Request
          - name: request_id
            type: u64
        returns: Result<Response>
        async: true
        doc: |
          Processes a TDLib JSON request and routes to appropriate manager.
          
          ## Request Mapping
          
          | Request Type | Manager Called | Method |
          |--------------|----------------|--------|
          | GetMe | user_manager | get_me() |
          | GetUser { user_id } | user_manager | get_user(user_id) |
          | GetUserFull { user_id } | user_manager | fetch_full_user(user_id) |
          | GetChats { limit } | dialog_manager | load_dialogs(limit) |
          | GetChat { chat_id } | dialog_manager | get_chat(chat_id) |
          | SendMessage { chat_id, text } | messages_manager | send_text(chat_id, text, None) |
          | SetAuthenticationPhoneNumber { phone_number } | auth_manager | set_phone_number(phone_number) |
          | CheckAuthenticationCode { code } | auth_manager | check_code(code, None) |
          | CheckAuthenticationPassword { password } | auth_manager | check_password(password) |
          | GetAuthorizationState | auth_manager | get_state() |
          
          ## Error Mapping
          
          - `Option::None` → `Response::Error { code: 404, message: "Not found" }`
          - `Err(NetworkError)` → `Response::Error { code: 500, message: ... }`
          - `Err(MessagesManagerError)` → `Response::Error { code: 500, message: ... }`
          - `Err(AuthManagerError)` → `Response::Error { code: 400, message: ... }`

    request_handlers:
      - name: GetMe
        current_implementation: |
          ```rust
          Request::GetMe => {
              info!("getMe request - returning stub user");
              Ok(Response::ok())
          }
          ```
        target_implementation: |
          ```rust
          Request::GetMe => {
              debug!("getMe request");
              match &self.user_manager {
                  Some(manager) => {
                      match manager.get_me().await {
                          Some(user) => {
                              Ok(Response::user(user))
                          }
                          None => Ok(Response::error(404, "User not found"))
                      }
                  }
                  None => Ok(Response::error(500, "UserManager not available"))
              }
          }
          ```
        estimated_loc: 12

      - name: GetUser
        current_implementation: |
          ```rust
          Request::GetUser { user_id } => {
              debug!("getUser request for {} - returning stub", user_id);
              Ok(Response::ok())
          }
          ```
        target_implementation: |
          ```rust
          Request::GetUser { user_id } => {
              debug!("getUser request for {}", user_id);
              match &self.user_manager {
                  Some(manager) => {
                      match UserId::new(*user_id) {
                          Ok(uid) => {
                              match manager.get_user(uid).await {
                                  Some(user) => Ok(Response::user(user)),
                                  None => Ok(Response::error(404, "User not found"))
                              }
                          }
                          Err(_) => Ok(Response::error(400, "Invalid user_id"))
                      }
                  }
                  None => Ok(Response::error(500, "UserManager not available"))
              }
          }
          ```
        estimated_loc: 15

      - name: GetUserFull
        current_implementation: |
          ```rust
          Request::GetUserFull { user_id } => {
              debug!("getUserFull request for {} - returning stub", user_id);
              Ok(Response::ok())
          }
          ```
        target_implementation: |
          ```rust
          Request::GetUserFull { user_id } => {
              debug!("getUserFull request for {}", user_id);
              match &self.user_manager {
                  Some(manager) => {
                      match UserId::new(*user_id) {
                          Ok(uid) => {
                              match manager.fetch_full_user(uid).await {
                                  Ok(Some(full_user)) => Ok(Response::user_full(full_user)),
                                  Ok(None) => Ok(Response::error(404, "User not found")),
                                  Err(e) => Ok(Response::error(500, format!("Network error: {}", e)))
                              }
                          }
                          Err(_) => Ok(Response::error(400, "Invalid user_id"))
                      }
                  }
                  None => Ok(Response::error(500, "UserManager not available"))
              }
          }
          ```
        estimated_loc: 18

      - name: GetChats
        current_implementation: |
          ```rust
          Request::GetChats { limit } => {
              debug!("getChats request (limit: {}) - returning empty list", limit);
              Ok(Response::Chats {
                  chat_ids: vec![],
                  total_count: 0,
              })
          }
          ```
        target_implementation: |
          ```rust
          Request::GetChats { limit } => {
              debug!("getChats request (limit: {})", limit);
              // Note: DialogManager.load_dialogs is async
              // For now, return cached dialogs or use network client
              match &self.dialog_network_client {
                  Some(client) => {
                      // Use network client to load dialogs
                      // This would require implementing load_dialogs
                      Ok(Response::Chats {
                          chat_ids: vec![],  // TODO: Load from network
                          total_count: 0,
                      })
                  }
                  None => Ok(Response::error(500, "Network client not available"))
              }
          }
          ```
        estimated_loc: 15

      - name: GetChat
        current_implementation: |
          ```rust
          Request::GetChat { chat_id } => {
              debug!("getChat request for {} - returning stub", chat_id);
              Ok(Response::ok())
          }
          ```
        target_implementation: |
          ```rust
          Request::GetChat { chat_id } => {
              debug!("getChat request for {}", chat_id);
              match DialogId::from_encoded(*chat_id) {
                  Ok(dialog_id) => {
                      // Check if dialog exists in manager
                      if self.dialog_manager.has_dialog(dialog_id) {
                          // TODO: Convert dialog metadata to Response
                          Ok(Response::chat(/* dialog info */))
                      } else {
                          Ok(Response::error(404, "Chat not found"))
                      }
                  }
                  Err(_) => Ok(Response::error(400, "Invalid chat_id"))
              }
          }
          ```
        estimated_loc: 12

      - name: SendMessage
        current_implementation: |
          ```rust
          Request::SendMessage { chat_id, text } => {
              debug!(
                  "sendMessage request to {} (text: {:?}) - returning stub",
                  chat_id, text
              );
              Ok(Response::message_sent(1))
          }
          ```
        target_implementation: |
          ```rust
          Request::SendMessage { chat_id, text } => {
              debug!("sendMessage request to {} (text: {:?})", chat_id, text);
              match (&self.messages_manager, &text) {
                  (Some(manager), Some(msg_text)) => {
                      match DialogId::from_encoded(*chat_id) {
                          Ok(dialog_id) => {
                              match manager.send_text(dialog_id, msg_text.clone(), None).await {
                                  Ok(msg_id) => Ok(Response::message_sent(msg_id, dialog_id, msg_text)),
                                  Err(e) => Ok(Response::error(500, format!("Send error: {}", e)))
                              }
                          }
                          Err(_) => Ok(Response::error(400, "Invalid chat_id"))
                      }
                  }
                  (None, _) => Ok(Response::error(500, "MessagesManager not available")),
                  (_, None) => Ok(Response::error(400, "Message text is required")),
              }
          }
          ```
        estimated_loc: 18

      - name: SetAuthenticationPhoneNumber
        current_implementation: |
          ```rust
          Request::SetAuthenticationPhoneNumber { phone_number } => {
              debug!("setAuthenticationPhoneNumber for {} - returning ok", phone_number);
              Ok(Response::ok())
          }
          ```
        target_implementation: |
          ```rust
          Request::SetAuthenticationPhoneNumber { phone_number } => {
              debug!("setAuthenticationPhoneNumber for {}", phone_number);
              match &self.auth_manager {
                  Some(manager) => {
                      match manager.set_phone_number(phone_number.clone()).await {
                          Ok(()) => Ok(Response::authorization_state(manager.get_state())),
                          Err(e) => Ok(Response::error(400, format!("Auth error: {}", e)))
                      }
                  }
                  None => Ok(Response::error(500, "AuthManager not available"))
              }
          }
          ```
        estimated_loc: 12

      - name: CheckAuthenticationCode
        current_implementation: |
          ```rust
          Request::CheckAuthenticationCode { code: _ } => {
              debug!("checkAuthenticationCode - returning ok");
              Ok(Response::ok())
          }
          ```
        target_implementation: |
          ```rust
          Request::CheckAuthenticationCode { code } => {
              debug!("checkAuthenticationCode");
              match &self.auth_manager {
                  Some(manager) => {
                      match manager.check_code(code.clone(), None).await {
                          Ok(()) => Ok(Response::authorization_state(manager.get_state())),
                          Err(e) => Ok(Response::error(400, format!("Invalid code: {}", e)))
                      }
                  }
                  None => Ok(Response::error(500, "AuthManager not available"))
              }
          }
          ```
        estimated_loc: 12

      - name: CheckAuthenticationPassword
        current_implementation: |
          ```rust
          Request::CheckAuthenticationPassword { password: _ } => {
              debug!("checkAuthenticationPassword - returning ok");
              Ok(Response::ok())
          }
          ```
        target_implementation: |
          ```rust
          Request::CheckAuthenticationPassword { password } => {
              debug!("checkAuthenticationPassword");
              match &self.auth_manager {
                  Some(manager) => {
                      match manager.check_password(password.clone()).await {
                          Ok(()) => Ok(Response::authorization_state(manager.get_state())),
                          Err(e) => Ok(Response::error(400, format!("Invalid password: {}", e)))
                      }
                  }
                  None => Ok(Response::error(500, "AuthManager not available"))
              }
          }
          ```
        estimated_loc: 12

      - name: GetAuthorizationState
        current_implementation: |
          ```rust
          Request::GetAuthorizationState => {
              debug!("getAuthorizationState - returning WaitPhoneNumber");
              Ok(Response::authorization_state_waiting())
          }
          ```
        target_implementation: |
          ```rust
          Request::GetAuthorizationState => {
              debug!("getAuthorizationState");
              match &self.auth_manager {
                  Some(manager) => {
                      Ok(Response::authorization_state(manager.get_state()))
                  }
                  None => Ok(Response::authorization_state_waiting())
              }
          }
          ```
        estimated_loc: 8

    response_types_required:
      - name: Response::user
        variant: User
        fields:
          - name: id
            type: i64
          - name: first_name
            type: String
          - name: last_name
            type: String
          - name: username
            type: String
          - name: phone_number
            type: String
        serialization: TDLib format with @type: "user"
        estimated_loc: 15

      - name: Response::user_full
        variant: UserFull
        fields:
          - user: Response::user
          - bio: Option<String>
          - profile_photo: Option<ProfilePhoto>
        serialization: TDLib format with @type: "userFull"
        estimated_loc: 20

      - name: Response::chat
        variant: Chat
        fields:
          - name: id
            type: i64
          - name: title
            type: String
          - name: type
            type: ChatType (enum)
        serialization: TDLib format with @type: "chat"
        estimated_loc: 15

      - name: Response::authorization_state
        variant: AuthorizationState
        states:
          - WaitPhoneNumber
          - WaitCode
          - WaitPassword
          - Ok
          - NetworkError(String)
        serialization: TDLib format with @type: "authorizationState..."
        estimated_loc: 20

      - name: Response::error
        variant: Error
        fields:
          - code: i32
          - message: String
        serialization: TDLib format with @type: "error"
        estimated_loc: 10
        note: Already exists but needs TDLib format

    error_mapping:
      UserManager:
        Option::None -> Response::Error { code: 404, message: "User not found" }
        NetworkError::NoClient -> Response::Error { code: 500, message: "Network client not configured" }
        NetworkError::Timeout -> Response::Error { code: 408, message: "Request timeout" }

      MessagesManager:
        MessagesManagerError::DialogNotFound -> Response::Error { code: 404, message: "Chat not found" }
        MessagesManagerError::Validation(msg) -> Response::Error { code: 400, message: msg }
        MessagesManagerError::Network(err) -> Response::Error { code: 500, message: format!("Network error: {}", err) }

      AuthManager:
        AuthManagerError::InvalidPhoneNumber(_) -> Response::Error { code: 400, message: "PHONE_NUMBER_INVALID" }
        AuthManagerError::InvalidCode(_) -> Response::Error { code: 400, message: "CODE_INVALID" }
        AuthManagerError::EmptyPassword -> Response::Error { code: 400, message: "PASSWORD_EMPTY" }
        AuthManagerError::NotAuthenticated -> Response::Error { code: 401, message: "UNAUTHORIZED" }
        AuthManagerError::InvalidState(_) -> Response::Error { code: 400, message: "INVALID_STATE" }
        AuthManagerError::Failed { code, message } -> Response::Error { code, message }

estimated_total_loc: 119
implementation_order:
  - phase_1:
    - Add auth_manager field to RequestMapper
    - Update RequestMapper::new() signature
    - Update InternalClientConfig in lib.rs
  - phase_2:
    - Implement GetMe handler (simplest)
    - Implement GetUser handler
    - Implement GetUserFull handler
  - phase_3:
    - Implement SendMessage handler
    - Implement GetChats handler
  - phase_4:
    - Implement auth handlers (SetAuthenticationPhoneNumber, CheckAuthenticationCode, CheckAuthenticationPassword, GetAuthorizationState)
  - phase_5:
    - Add Response variants (User, UserFull, Chat, extended AuthorizationState)
    - Update error mapping
  - phase_6:
    - Update tests to use real manager calls
    - Add mock manager setup helpers
