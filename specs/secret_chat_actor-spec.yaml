# Specification: SecretChatActor
module: secret_chat_actor
crate: rustgram-secret-chat-actor
tdlib_reference: references/td/td/telegram/SecretChatActor.h
complexity: HIGH
module_type: Manager Type (Actor with State Machine)
estimated_loc: 2000-3000
estimated_tests: 70-100

types:
  - name: SecretChatActor
    description: |
      Actor managing a single secret chat.
      
      Handles the entire lifecycle of a secret chat including:
      - Key exchange (DH handshake)
      - Message encryption/decryption
      - Layer negotiation
      - State persistence
      - Message sequencing and acknowledgments
    fields:
      - name: id
        type: i32
        description: Secret chat ID
        optional: false
      - name: context
        type: Box<Context>
        description: Context for dependencies (dh_callback, binlog, etc.)
        optional: false
      - name: state
        type: SecretChatState
        description: Current state of the chat
        optional: false
      - name: config_state
        type: ConfigState
        description: Configuration (layers, TTL)
        optional: false
      - name: seq_no_state
        type: SeqNoState
        description: Message sequencing state
        optional: false
      - name: auth_key
        type: Option<AuthKey>
        description: Authentication key for encryption
        optional: true

  - name: SecretChatState
    description: State machine for secret chat
    variants:
      - Empty
      - SendRequest
      - SendAccept
      - WaitRequestResponse
      - WaitAcceptResponse
      - Ready
      - Closed

  - name: SeqNoState
    description: Message sequencing state
    fields:
      - name: message_id
        type: i32
        description: Current message ID
      - name: my_in_seq_no
        type: i32
        description: My incoming sequence number
      - name: my_out_seq_no
        type: i32
        description: My outgoing sequence number
      - name: his_in_seq_no
        type: i32
        description: His incoming sequence number
      - name: his_layer
        type: i32
        description: His layer version
      - name: resend_end_seq_no
        type: i32
        description: End sequence number for resend

  - name: ConfigState
    description: Configuration state
    fields:
      - name: his_layer
        type: i32
        description: His layer (default 8)
      - name: my_layer
        type: i32
        description: My layer (default 8)
      - name: ttl
        type: i32
        description: Time to live for messages

  - name: Context
    description: Trait for secret chat dependencies
    methods:
      - dh_callback
      - binlog
      - secret_chat_db
      - net_query_creator
      - dh_config
      - set_dh_config
      - get_config_option_boolean
      - unix_time
      - close_flag
      - send_net_query
      - on_update_secret_chat
      - on_inbound_message
      - on_delete_messages
      - on_flush_history
      - on_read_message
      - on_screenshot_taken
      - on_set_ttl
      - on_send_message_ack
      - on_send_message_ok
      - on_send_message_error

external_dependencies:
  - type: SecretChatId
    crate: rustgram-types
    constructor: new()
    verified: true
  - type: UserId
    crate: rustgram-types
    constructor: new()
    verified: true
  - type: MessageId
    crate: rustgram-types
    constructor: new()
    verified: true
  - type: DhConfig
    crate: rustgram-dh-config
    verified: false # STUB NEEDED
  - type: AuthKey
    crate: rustgram-mtproto
    verified: false # STUB NEEDED
  - type: SecretChatDb
    crate: rustgram-secret-chat-db
    verified: false # Already exists, need to check API
  - type: SecretChatLayer
    crate: rustgram-secret-chat-layer
    verified: false # Already exists, need to check API

constructors:
  - name: new
    description: Creates new SecretChatActor
    parameters:
      - name: id
        type: i32
      - name: context
        type: Box<Context>
      - name: can_be_empty
        type: bool
    returns: Self

methods (lifecycle):
  - name: update_chat
    description: Update chat from server response
  - name: create_chat
    description: Create new secret chat
    parameters:
      - name: user_id
        type: UserId
      - name: user_access_hash
        type: i64
      - name: random_id
        type: i32
      - name: promise
        type: Promise<SecretChatId>
  - name: cancel_chat
    description: Cancel/close the chat
    parameters:
      - name: delete_history
        type: bool
      - name: is_already_discarded
        type: bool
      - name: promise
        type: Promise<()>

methods (inbound):
  - name: add_inbound_message
    description: Add inbound message
  - name: replay_inbound_message
    description: Replay inbound message from binlog

methods (outbound):
  - name: send_message
    description: Send encrypted message
  - name: send_message_action
    description: Send typing action
  - name: send_read_history
    description: Send read history confirmation
  - name: delete_message
    description: Delete a message
  - name: delete_messages
    description: Delete multiple messages
  - name: delete_all_messages
    description: Delete all messages
  - name: notify_screenshot_taken
    description: Notify that screenshot was taken
  - name: send_set_ttl_message
    description: Send TTL update

traits:
  - Actor (custom trait)

test_plan:
  unit_tests: 70
  doc_tests: 12

notes: |
  This is one of the most complex actors in TDLib.
  Key challenges:
  1. State machine with 7 states
  2. DH handshake for key exchange
  3. Message encryption/decryption
  4. Layer negotiation
  5. Sequence number management
  6. Binlog integration for persistence
  
  For the Rust implementation:
  1. Create simplified Context trait with stub methods
  2. Implement state machine transitions
  3. Create stubs for DH and encryption
  4. Focus on state transitions rather than full crypto
  
  MAX_RESEND_COUNT is 1000 - limit resend operations.
  
  SecretChatLayer and SecretChatDb already exist - need to verify their APIs.
