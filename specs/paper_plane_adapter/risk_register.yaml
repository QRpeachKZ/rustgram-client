# Risk Register: paper_plane_adapter - Update Channel Bridge
# Version: 1.0.0
# Date: 2026-01-21
# Epic: rustgram-client-zwh.2

# Risk Assessment Summary
risk_summary:
  total_risks: 10
  open: 3
  mitigated: 5
  blocked: 0
  accepted: 2

# Risk Definitions
risk_types:
  API_MISMATCH: "Update format incompatible with TDLib or paper-plane expectations"
  DEADLOCK: "Thread synchronization causing deadlock"
  DATA_LOSS: "Updates dropped due to buffer overflow or channel closure"
  PERFORMANCE: "Bridge becomes bottleneck causing update delivery delays"
  MISSING_DEPENDENCY: "Required dependency not available or incompatible"

# Risk Register
risks:
  - id: "R1"
    type: "API_MISMATCH"
    title: "Update JSON format mismatch with TDLib schema"
    description: |
      client_actor::Update uses serde_json::Value but the exact format may not match
      what paper-plane expects. TDLib has specific @type naming and field naming conventions.
    
    likelihood: "MEDIUM"
    impact: "HIGH"
    severity: "HIGH"
    
    status: "OPEN"
    
    indicators:
      - "paper-plane fails to parse update JSON"
      - "Missing @type field"
      - "Wrong field name casing (camelCase vs snake_case)"
    
    mitigation_strategy: |
      1. Verify JSON format against TDLib documentation
      2. Add conversion layer if format differs
      3. Use #[serde(rename)] attributes for field mapping
      4. Reference paper-plane's expected format in references/paper-plane/src/model/
    
    owner: "Phase 3 Developer"
    due_date: "2026-01-25"
    
    references:
      - "specs/paper_plane_adapter/update_bridge_spec.yaml:140-160"
      - "crates/client_actor/src/lib.rs:97-128"

  - id: "R2"
    type: "DEADLOCK"
    title: "Deadlock between tokio task and glib thread"
    description: |
      Potential deadlock if:
      1. tokio task holds buffer lock and waits for async_channel
      2. glib thread holds async_channel lock and waits for buffer
      
      Using mutexes across different runtime threads can cause priority inversion.
    
    likelihood: "LOW"
    impact: "CRITICAL"
    severity: "MEDIUM"
    
    status: "MITIGATED"
    
    indicators:
      - "Application freezes on update receive"
      - "Stack traces show lock acquisition"
      - "No updates delivered after initial burst"
    
    mitigation_strategy: |
      1. Use try_send() instead of send() for async_channel (non-blocking)
      2. Use try_lock() with timeout for buffer access
      3. Keep critical sections minimal (only push/pop, no processing)
      4. Consider lock-free structures (crossbeam) if needed
      
      Reference: parking_lot::Mutex is deadlock-safe for simple cases
    
    owner: "Phase 3 Developer"
    completed_date: "2026-01-21"
    
    references:
      - "specs/paper_plane_adapter/update_bridge_spec.yaml:240-260"

  - id: "R3"
    type: "DATA_LOSS"
    title: "Update buffer overflow causing dropped updates"
    description: |
      If glib thread consumes updates slower than tokio produces them, buffer
      will grow unbounded or drop oldest updates when capacity limit reached.
      
      Critical updates (authorization state) should not be dropped.
    
    likelihood: "MEDIUM"
    impact: "MEDIUM"
    severity: "MEDIUM"
    
    status: "OPEN"
    
    indicators:
      - "Buffer capacity warnings in logs"
      - "User misses messages or state changes"
      - "Authorization updates delayed"
    
    mitigation_strategy: |
      1. Set reasonable buffer capacity (1000 updates)
      2. Prioritize updates (authorization > messages > typing)
      3. Log warnings when dropping updates
      4. Consider priority queue for critical updates
      5. Metrics to monitor buffer health
      
      Alternative: Use unbounded buffer with memory limit monitoring
    
    owner: "Phase 3 Developer"
    due_date: "2026-01-25"
    
    references:
      - "specs/paper_plane_adapter/update_bridge_spec.yaml:280-290"

  - id: "R4"
    type: "PERFORMANCE"
    title: "JSON serialization overhead"
    description: |
      Converting every update to JSON string adds latency. If update rate is high
      (e.g., message storm), serialization may become bottleneck.
    
    likelihood: "LOW"
    impact: "MEDIUM"
    severity: "LOW"
    
    status: "MITIGATED"
    
    indicators:
      - "Update latency > 100ms"
      - "High CPU usage during message bursts"
      - "JSON serialization dominates profiling"
    
    mitigation_strategy: |
      1. client_actor::Update already contains serde_json::Value (pre-serialized)
      2. Extract inner Value directly (no re-serialization)
      3. Only add @type if missing (usually present from serde tag)
      4. Use serde_json::to_string() only when Value needs modification
      
      Pre-validated: Update enum has #[serde(tag = "@type")] attribute
    
    owner: "N/A"
    completed_date: "2026-01-21"
    
    references:
      - "crates/client_actor/src/lib.rs:99"

  - id: "R5"
    type: "MISSING_DEPENDENCY"
    title: "async-channel not in workspace dependencies"
    description: |
      async-channel is not currently listed in Cargo.toml workspace dependencies.
      Must be added for this component.
    
    likelihood: "LOW"
    impact: "MEDIUM"
    severity: "LOW"
    
    status: "MITIGATED"
    
    indicators:
      - "Cargo fails to resolve async-channel"
      - "Version conflicts with existing dependencies"
    
    mitigation_strategy: |
      1. Add async-channel = "2.0" to workspace [workspace.dependencies]
      2. Already verified: paper-plane uses async-channel 2.0
      3. Compatible with tokio 1.35 and parking_lot 0.12
      
      Version 2.0 is stable and widely adopted (24M+ downloads)
    
    owner: "Phase 3 Developer"
    completed_date: "2026-01-21"
    
    action_required: |
      Add to workspace Cargo.toml:
      async-channel = "2.0"
    
    references:
      - "specs/paper_plane_adapter/dependency_matrix.md:80-120"

  - id: "R6"
    type: "DATA_LOSS"
    title: "ClientActor stops sending updates"
    description: |
      If ClientActor is stopped or its update_sender closed, bridge will silently
      fail. GTK application won't know updates have stopped.
    
    likelihood: "LOW"
    impact: "HIGH"
    severity: "MEDIUM"
    
    status: "OPEN"
    
    indicators:
      - "No updates received after some time"
      - "Bridge.is_running() returns false"
      - "mpsc::recv() returns None"
    
    mitigation_strategy: |
      1. Detect when update channel closes (recv() returns None)
      2. Emit error update to GTK: {"@type": "error", "message": "Update channel closed"}
      3. Provide UpdateBridge::is_running() method for polling
      4. Log error when channel closes
      
      GTK application can show "Connection lost" UI
    
    owner: "Phase 3 Developer"
    due_date: "2026-01-25"
    
    references:
      - "specs/paper_plane_adapter/update_bridge_spec.yaml:300-310"

  - id: "R7"
    type: "PERFORMANCE"
    title: "Busy-wait in glib main loop"
    description: |
      If receive() is called in tight loop without delay, it will consume 100% CPU
      when no updates available.
    
    likelihood: "MEDIUM"
    impact: "MEDIUM"
    severity: "MEDIUM"
    
    status: "ACCEPTED"
    
    indicators:
      - "High CPU usage when idle"
      - "Profiling shows glib loop dominates"
    
    mitigation_strategy: |
      1. Document that caller must use timeout/delay
      2. Example in documentation:
         ```rust
         glib::timeout_future_seconds(0.01).await; // 10ms delay
         ```
      3. Alternative: Provide async_channel::Receiver for event-driven model
      
      Accepted: Caller's responsibility to use proper delay (documented)
    
    owner: "Documentation"
    completed_date: "2026-01-21"
    
    references:
      - "specs/paper_plane_adapter/update_bridge_spec.yaml:320-330"

  - id: "R8"
    type: "DEADLOCK"
    title: "Task spawn deadlock during shutdown"
    description: |
      If tokio runtime is shutting down while UpdateBridge::create() is spawning
      the forwarder task, the task may never start or return.
    
    likelihood: "LOW"
    impact: "MEDIUM"
    severity: "LOW"
    
    status: "MITIGATED"
    
    indicators:
      - "create() hangs during shutdown"
      - "Task never returns JoinHandle"
    
    mitigation_strategy: |
      1. Use tokio::spawn() with timeout
      2. Return error if runtime not available
      3. Provide async create() method (caller must have runtime)
      4. Document that tokio runtime must be running
      
      Validate: ClientActor requires tokio runtime, so caller always has one
    
    owner: "N/A"
    completed_date: "2026-01-21"
    
    references:
      - "specs/paper_plane_adapter/update_bridge_spec.yaml:170-180"

  - id: "R9"
    type: "API_MISMATCH"
    title: "ClientId type mismatch with paper-plane"
    description: |
      paper-plane uses its own ClientId type (wrapper around tdlib's type).
      Our ClientId must be compatible or convertible.
    
    likelihood: "LOW"
    impact: "MEDIUM"
    severity: "LOW"
    
    status: "ACCEPTED"
    
    indicators:
      - "Type conversion errors in bindings"
      - "Paper-plane rejects our ClientId"
    
    mitigation_strategy: |
      1. ClientId is newtype around i32 (both paper-plane and rustgram)
      2. Provide ClientId::as_i32() and ClientId::from_i32() methods
      3. Document mapping between rustgram and paper-plane IDs
      
      Accepted: Paper-plane adapter crate handles translation
    
    owner: "Phase 3 Developer"
    completed_date: "2026-01-21"
    
    references:
      - "specs/paper_plane_adapter.yaml:101-106"

  - id: "R10"
    type: "MISSING_DEPENDENCY"
    title: "ClientActor not available in current workspace"
    description: |
      paper_plane_adapter crate does not exist yet. Depends on zwh.1 to create
      the crate structure before UpdateBridge can be implemented.
    
    likelihood: "HIGH"
    impact: "BLOCKER"
    severity: "CRITICAL"
    
    status: "MITIGATED"
    
    indicators:
      - "Cargo cannot find rustgram-paper-plane-adapter"
      - "crate directory does not exist"
    
    mitigation_strategy: |
      1. Create crate skeleton in Phase zwh.1 (Crate Structure)
      2. Add to workspace members in Cargo.toml
      3. Create basic Cargo.toml and src/lib.rs
      4. Then implement UpdateBridge as part of zwh.2
      
      Dependencies: zwh.1 must complete before zwh.2
    
    owner: "Phase Planning"
    completed_date: "2026-01-21"
    
    references:
      - "specs/paper_plane_adapter.yaml:267-311"

# Risk Severity Matrix
severity_matrix:
  CRITICAL:
    - "R10" # Missing crate (MITIGATED)
  
  HIGH:
    - "R1"  # API mismatch (OPEN)
    - "R2"  # Deadlock (MITIGATED)
    - "R6"  # Channel closure (OPEN)
  
  MEDIUM:
    - "R3"  # Buffer overflow (OPEN)
    - "R4"  # JSON overhead (MITIGATED)
    - "R7"  # Busy-wait (ACCEPTED)
    - "R9"  # ClientId type (ACCEPTED)
  
  LOW:
    - "R5"  # async-channel dep (MITIGATED)
    - "R8"  # Shutdown deadlock (MITIGATED)

# Open Risks Requiring Action
open_risks:
  - id: "R1"
    action: "Verify JSON format matches TDLib schema"
    priority: "HIGH"
    assignee: "Phase 3 Developer"
    
  - id: "R3"
    action: "Implement buffer capacity limits and monitoring"
    priority: "MEDIUM"
    assignee: "Phase 3 Developer"
    
  - id: "R6"
    action: "Add channel closure detection and error propagation"
    priority: "HIGH"
    assignee: "Phase 3 Developer"

# Risk Monitoring Metrics
metrics:
  - name: "buffer_utilization"
    description: "Percentage of buffer capacity used"
    threshold_warning: "70%"
    threshold_critical: "90%"
    
  - name: "update_latency"
    description: "Time from ClientActor to GTK delivery"
    threshold_warning: "100ms"
    threshold_critical: "500ms"
    
  - name: "dropped_updates"
    description: "Count of updates dropped due to buffer overflow"
    threshold_warning: "10/minute"
    threshold_critical: "100/minute"
    
  - name: "conversion_errors"
    description: "Count of JSON conversion failures"
    threshold_warning: "1/minute"
    threshold_critical: "10/minute"

# Contingency Plans
contingency_plans:
  scenario_1: "Buffer overflow continues despite capacity limit"
    plan: |
      1. Implement priority queue (authorization > messages)
      2. Add backpressure (slow down ClientActor)
      3. Use unbounded buffer with memory monitoring
  
  scenario_2: "JSON format incompatible with paper-plane"
    plan: |
      1. Add translation layer in UpdateConverter
      2. Map field names using serde attributes
      3. Test with actual paper-plane client
  
  scenario_3: "Deadlock detected in production"
    plan: |
      1. Switch to lock-free data structures (crossbeam)
      2. Add deadlock detection (timeout on lock acquisition)
      3. Consider single-threaded model (glib only)

# Risk Review Process
review_process:
  frequency: "Weekly during Phase 3"
  participants:
    - "Phase 3 Developer"
    - "Tech Lead"
  actions:
    - "Update risk status"
    - "Add new risks as discovered"
    - "Review mitigation effectiveness"
    - "Escalate if severity increases"

---

**Document Version:** 1.0.0  
**Last Updated:** 2026-01-21  
**Next Review:** After Phase 3 implementation begins  
**Risk Owner:** Phase 3 Developer
