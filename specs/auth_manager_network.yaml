# Technical Specification: AuthManager Network Integration
**Epic**: rustgram-client-ff7.2
**Version**: 1.0
**Date**: 2026-01-20
**Status**: Phase 2 - Analysis & Spec

---

## 1. Overview

### 1.1 Purpose
This specification defines the technical requirements for implementing comprehensive test coverage and validating the existing network integration methods in `rustgram-auth-manager`. The authentication manager already has functional network methods (`send_code`, `sign_in`, `send_log_out`) but lacks adequate test coverage (7% vs 70% target).

### 1.2 Scope
- **In Scope**: Testing existing network methods (lines 876-1096 in lib.rs)
- **In Scope**: Mock NetQueryDispatcher for unit testing
- **In Scope**: Integration tests for authentication flow
- **Out of Scope**: State persistence (deferred to future epic)
- **Out of Scope**: Architecture refactoring (keep direct NetQueryDispatcher pattern)

### 1.3 Context
Based on TDLib's `AuthManager` class, the AuthManager coordinates authentication flow using MTProto network operations. Current implementation uses direct `NetQueryDispatcher` calls with callback-based response handling.

---

## 2. Public API Surface

### 2.1 Public Methods (Existing)

| Method | Signature | Lines | Purpose |
|--------|-----------|-------|---------|
| `new()` | `fn new(i32, String, NetQueryDispatcher) -> Self` | 295-317 | Create manager |
| `set_phone_number()` | `pub async fn set_phone_number(String) -> Result<(), Error>` | 384-412 | Start phone auth |
| `check_code()` | `pub async fn check_code(String, Option<EmailVerification>) -> Result<(), Error>` | 449-495 | Verify auth code |
| `check_password()` | `pub async fn check_password(String) -> Result<(), Error>` | 525-543 | Verify 2FA |
| `check_bot_token()` | `pub async fn check_bot_token(String) -> Result<(), Error>` | 572-585 | Bot token auth |
| `log_out()` | `pub async fn log_out() -> Result<(), Error>` | 649-666 | Logout session |
| `is_authorized()` | `pub async fn is_authorized() -> bool` | 729-732 | Check auth status |
| `get_state()` | `pub fn get_state() -> State` | 750-758 | Get current state |
| `user_id()` | `pub async fn user_id() -> Option<UserId>` | 771-773 | Get user ID |

### 2.2 Network Methods (Private - Require Testing)

| Method | Signature | Lines | TL Constructor | Response Type |
|--------|-----------|-------|----------------|---------------|
| `send_code()` | `async fn send_code(String) -> Result<(), Error>` | 876-948 | `0xa677244f` | `SentCode` |
| `sign_in()` | `async fn sign_in(String, String, Option<EmailVerification>) -> Result<(), Error>` | 951-1040 | `0x8d52a951` | `Authorization` |
| `send_log_out()` | `async fn send_log_out() -> Result<(), Error>` | 1043-1096 | `0x3e72ba19` | `LoggedOut` |

### 2.3 Callback Types (Internal)

| Type | Purpose |
|------|---------|
| `AuthQueryCallback` | Handles SendCode response (lines 1246-1270) |
| `SignInQueryCallback` | Handles SignIn response (lines 1274-1297) |
| `LogOutQueryCallback` | Handles LogOut response (lines 1300-1320) |

---

## 3. State Machine Definition

### 3.1 State Transitions

```mermaid
stateDiagram-v2
    [*] --> None: Initial
    None --> WaitPhoneNumber: set_phone_number()
    WaitPhoneNumber --> WaitCode: send_code() success
    WaitCode --> WaitPassword: sign_in() requires 2FA
    WaitCode --> Ok: sign_in() success
    WaitPassword --> Ok: check_password() success
    Ok --> LoggingOut: log_out()
    LoggingOut --> Closing: send_log_out() success
    Closing --> [*]
    
    WaitCode --> NetworkError: Network error
    WaitPassword --> NetworkError: Network error
    NetworkError --> WaitingRetry: Retryable error
    WaitingRetry --> WaitCode: Retry timeout
    WaitingRetry --> WaitPassword: Retry timeout
```

### 3.2 State Definitions

| State | Description | Valid Next States |
|-------|-------------|-------------------|
| `None` | No authentication started | `WaitPhoneNumber`, `WaitCode` (bot) |
| `WaitPhoneNumber` | Waiting for phone number | `WaitCode`, `NetworkError` |
| `WaitCode` | Waiting for SMS/email code | `WaitPassword`, `Ok`, `NetworkError` |
| `WaitPassword` | Waiting for 2FA password | `Ok`, `NetworkError` |
| `Ok` | Fully authenticated | `LoggingOut` |
| `LoggingOut` | Logout in progress | `Closing` |
| `Closing` | Connection closing | `None` (after reset) |
| `WaitingRetry` | Waiting before retry | `WaitCode`, `WaitPassword` |
| `NetworkError` | Network operation failed | `WaitingRetry`, `None` |

### 3.3 State Queries

```rust
impl State {
    pub const fn is_waiting(&self) -> bool { /* ... */ }
    pub const fn is_authorized(&self) -> bool { /* ... */ }
    pub const fn is_closing(&self) -> bool { /* ... */ }
    pub const fn is_error(&self) -> bool { /* ... */ }
}
```

---

## 4. Network Request/Response Mapping

### 4.1 SendCode Flow

**Request**: `auth.sendCode#0xa677244f`

```rust
SendCodeRequest {
    phone_number: String,      // From set_phone_number()
    api_id: i32,               // From AuthManager::api_id
    api_hash: String,          // From AuthManager::api_hash
    settings: CodeSettings,    // Default settings
}
```

**Response**: `auth.SentCode`

```rust
SentCode {
    phone_registered: bool,
    type: SentCodeType,
    next_type: Option<SentCodeType>,
    timeout: i32,
}
```

**State Transition**: `WaitPhoneNumber` → `WaitCode`
**Error Handling**: 
- 400 PHONE_NUMBER_INVALID → `AuthManagerError::InvalidPhoneNumber`
- Network errors → Retry with exponential backoff

### 4.2 SignIn Flow

**Request**: `auth.signIn#0x8d52a951`

```rust
SignInRequest {
    phone_number: String,           // Stored from set_phone_number()
    phone_code_hash: String,        // From SentCode response
    phone_code: String,             // From check_code()
    email_verification: Option<EmailVerification>,  // From check_code()
}
```

**Response**: `auth.Authorization`

```rust
enum Authorization {
    Success {
        user: User,
        // ... other fields
    },
    SignUpRequired {
        terms_of_service: TermsOfService,
    },
}
```

**State Transitions**:
- `WaitCode` → `Ok` (success)
- `WaitCode` → `WaitPassword` (2FA required)
- `WaitCode` → `NetworkError` (failure)

**Error Handling**:
- 400 PHONE_CODE_INVALID → `AuthManagerError::InvalidCode`
- 400 SESSION_PASSWORD_NEEDED → Transition to `WaitPassword`
- Network errors → Retry with exponential backoff

### 4.3 LogOut Flow

**Request**: `auth.logOut#0x3e72ba19`

```rust
// Empty request
```

**Response**: `auth.LoggedOut`

```rust
LoggedOut {
    success: bool,
    // ... other fields
}
```

**State Transition**: `Ok` → `LoggingOut` → `Closing`

**Error Handling**:
- 401 SESSION_PASSWORD_REQUIRED → Ignore (already logged out)
- Network errors → Log but proceed to `Closing`

---

## 5. Error Handling Strategy

### 5.1 Error Types

```rust
pub enum AuthManagerError {
    InvalidPhoneNumber(String),
    InvalidCode(String),
    InvalidEmailVerification,
    InvalidBotToken(String),
    EmptyPassword,
    NotAuthenticated,
    InvalidState(State),
    Failed { code: i32, message: String },
}
```

### 5.2 Error Mapping (TL → AuthManagerError)

| TL Error Code | Error Message | AuthManagerError | Retry |
|---------------|---------------|------------------|-------|
| 400 | PHONE_NUMBER_INVALID | `InvalidPhoneNumber` | No |
| 400 | PHONE_CODE_INVALID | `InvalidCode` | No |
| 400 | SESSION_PASSWORD_NEEDED | Transition to WaitPassword | No |
| 400 | API_ID_INVALID | `Failed { code: 400, message }` | No |
| 500 | Internal Server Error | `Failed { code: 500, message }` | Yes (3x) |
| 502 | Bad Gateway | `Failed { code: 502, message }` | Yes (3x) |
| 429 | Too Many Requests | `Failed { code: 429, message }` | Yes (with delay) |
| Timeout | Request timeout | `Failed { code: 408, message }` | Yes (3x) |

### 5.3 Retry Strategy

```rust
const MAX_RETRY_ATTEMPTS: u32 = 3;
const BASE_RETRY_DELAY: Duration = Duration::from_secs(1);

// Exponential backoff: 1s, 2s, 4s
let delay = BASE_RETRY_DELAY * 2u32.pow(retry_count);
```

**Retryable Errors**:
- Network timeouts
- 500 Internal Server Error
- 502 Bad Gateway
- 429 Too Many Requests (with retry-after delay)

**Non-Retryable Errors**:
- 400 Bad Request (client errors)
- 401 Unauthorized (auth errors)
- 403 Forbidden (permission errors)

### 5.4 State on Error

```rust
// Retryable error
State::WaitingRetry {
    attempts: current_attempt + 1,
    delay: BASE_RETRY_DELAY * 2u32.pow(current_attempt),
}

// Non-retryable error
State::NetworkError(error_message)
```

---

## 6. Testing Requirements

### 6.1 Test Coverage Targets

| Category | Current | Target | Gap |
|----------|---------|--------|-----|
| Unit Tests | 7% | 70% | +63% |
| Integration Tests | 0% | 3+ tests | +3 |
| Total Tests | ~15 | 15+ | ~0 |

### 6.2 Required Unit Tests

#### 6.2.1 Network Method Tests

**Test: `send_code` success**
```rust
#[tokio::test]
async fn test_send_code_success() {
    // Mock NetQueryDispatcher returning SentCode
    // Verify state transition to WaitCode
    // Verify phone_code_hash is set
}
```

**Test: `send_code` invalid phone**
```rust
#[tokio::test]
async fn test_send_code_invalid_phone() {
    // Mock NetQueryDispatcher returning 400 error
    // Verify InvalidPhoneNumber error
}
```

**Test: `sign_in` success**
```rust
#[tokio::test]
async fn test_sign_in_success() {
    // Setup: manager in WaitCode state with phone_code_hash
    // Mock NetQueryDispatcher returning Authorization::Success
    // Verify state transition to Ok
    // Verify user_id is set
}
```

**Test: `sign_in` wrong code**
```rust
#[tokio::test]
async fn test_sign_in_wrong_code() {
    // Mock NetQueryDispatcher returning 400 PHONE_CODE_INVALID
    // Verify InvalidCode error
}
```

**Test: `sign_in` password required**
```rust
#[tokio::test]
async fn test_sign_in_password_required() {
    // Mock NetQueryDispatcher returning Authorization with 2FA flag
    // Verify state transition to WaitPassword
}
```

**Test: `log_out` success**
```rust
#[tokio::test]
async fn test_log_out_success() {
    // Setup: manager in Ok state
    // Mock NetQueryDispatcher returning LoggedOut
    // Verify state transition to Closing
}
```

#### 6.2.2 Callback Tests

**Test: AuthQueryCallback success**
```rust
#[tokio::test]
async fn test_auth_callback_success() {
    // Create callback with test channels
    // Trigger on_result with successful NetQuery
    // Verify state transition and phone_code_hash
}
```

**Test: AuthQueryCallback error**
```rust
#[tokio::test]
async fn test_auth_callback_error() {
    // Trigger on_result with error NetQuery
    // Verify state transition to NetworkError
}
```

#### 6.2.3 State Machine Tests

**Test: State transition validation**
```rust
#[tokio::test]
async fn test_state_transitions() {
    // Test all valid state transitions
    // Test invalid transitions are blocked
}
```

**Test: Retry logic**
```rust
#[tokio::test]
async fn test_retry_exponential_backoff() {
    // Mock network errors requiring retry
    // Verify exponential backoff delays
    // Verify max retry limit
}
```

#### 6.2.4 Error Handling Tests

**Test: Error mapping**
```rust
#[tokio::test]
async fn test_error_mapping() {
    // Test all TL error codes map correctly
    // Verify retryable vs non-retryable errors
}
```

### 6.3 Required Integration Tests

**Test: Full authentication flow**
```rust
#[tokio::test]
async fn test_full_auth_flow() {
    // set_phone_number() → check_code() → (check_password()?) → Ok
    // Verify state machine transitions correctly
}
```

**Test: Bot token authentication**
```rust
#[tokio::test]
async fn test_bot_token_auth() {
    // check_bot_token() → verify state transitions
}
```

**Test: Logout flow**
```rust
#[tokio::test]
async fn test_logout_flow() {
    // Setup authenticated state
    // log_out() → verify Closing state
}
```

### 6.4 Mock Infrastructure

**Mock NetQueryDispatcher**

```rust
struct MockNetQueryDispatcher {
    responses: Arc<Mutex<HashMap<QueryId, Result<Bytes, QueryError>>>>,
}

impl MockNetQueryDispatcher {
    fn mock_response(&self, query_id: QueryId, response: Result<Bytes, QueryError>) {
        self.responses.lock().insert(query_id, response);
    }
}

impl NetQueryDispatcher for MockNetQueryDispatcher {
    fn dispatch(&self, query: NetQuery) -> Result<(), QueryError> {
        // Store query and trigger callback with mocked response
    }
}
```

### 6.5 Coverage Validation

```bash
# Run coverage analysis
cargo llvm-cov -p auth_manager --html --output-dir coverage

# Verify thresholds
# - Line coverage: >= 70%
# - Region coverage: >= 65%
# - Function coverage: >= 80%
```

---

## 7. Dependencies

### 7.1 Internal Dependencies

| Crate | Purpose | Status |
|-------|---------|--------|
| `rustgram-types` | TL types (SendCodeRequest, SignInRequest, etc.) | ✅ Existing |
| `rustgram-net` | NetQuery, NetQueryDispatcher, QueryError | ✅ Existing |
| `rustgram-auth` | PasswordInfo, QrCodeLogin | ✅ Existing |
| `rustgram-terms-of-service` | TermsOfService type | ✅ Existing |

### 7.2 External Dependencies

| Crate | Purpose | Feature Flags |
|-------|---------|---------------|
| `tokio` | Async runtime | `sync`, `time`, `macros`, `test-util` |
| `serde` | Serialization | `derive` |
| `bytes` | Byte buffers | - |
| `async-trait` | Async trait support | - |
| `tracing` | Logging | - |
| `parking_lot` | Fast mutexes | - |
| `thiserror` | Error derive | - |

### 7.3 Test Dependencies

| Crate | Purpose |
|-------|---------|
| `tokio-test` | Async test utilities |
| `cargo-llvm-cov` | Coverage analysis |

---

## 8. Non-Functional Requirements

### 8.1 Performance

| Metric | Target | Measurement |
|--------|--------|-------------|
| Request timeout | 60s | Configurable via `with_timeout()` |
| Retry delay | 1-8s | Exponential backoff |
| State query latency | <1ms | In-memory lock |

### 8.2 Reliability

| Requirement | Target |
|-------------|--------|
| Error handling | 100% of errors map to AuthManagerError |
| State consistency | No invalid state transitions |
| Thread safety | All shared state protected by Arc<RwLock> |

### 8.3 Code Quality

| Metric | Target |
|--------|--------|
| Clippy warnings | 0 |
| Production unwrap() | 0 |
| Cyclomatic complexity | ≤15 per function |
| Public API documentation | 100% |
| Test coverage | ≥70% |

---

## 9. Security Considerations

### 9.1 Data Protection

| Asset | Protection Mechanism |
|-------|---------------------|
| API hash | Stored as `Arc<str>` (immutable) |
| Phone number | Cleared after authentication |
| Auth code | Never persisted, only in memory |
| Password | Never logged, cleared after use |

### 9.2 Authentication Security

| Requirement | Implementation |
|-------------|----------------|
| AuthFlag | Always `On` for authenticated requests |
| Code validation | Server-side verification via TL |
| Rate limiting | Respects server 429 responses |
| Timeout | Requests timeout after 60s |

### 9.3 State Security

| Risk | Mitigation |
|------|------------|
| State manipulation | All state changes go through validated methods |
| Race conditions | Arc<RwLock<T>> protects shared state |
| Callback attacks | Callbacks are internal, not exposed |

---

## 10. Documentation Requirements

### 10.1 Module Documentation

```rust
//! # Authentication Manager
//!
//! Coordinates authentication flow for Telegram client.
//!
//! ## State Machine
//!
//! ```text
//! None → WaitPhoneNumber → WaitCode → WaitPassword → Ok
//!                                          ↓
//!                                    NetworkError → WaitingRetry
//! ```
//!
//! ## Example
//!
//! ```no_run
//! use rustgram_auth_manager::{AuthManager, State};
//! use rustgram_net::NetQueryDispatcher;
//!
//! #[tokio::main]
//! async fn main() -> Result<(), Box<dyn std::error::Error>> {
//!     let dispatcher = NetQueryDispatcher::new();
//!     let manager = AuthManager::new(12345, "api_hash".to_string(), dispatcher);
//!     
//!     manager.set_phone_number("+1234567890".to_string()).await?;
//!     manager.check_code("12345".to_string(), None).await?;
//!     
//!     assert!(manager.is_authorized().await);
//!     Ok(())
//! }
//! ```
```

### 10.2 Method Documentation

All public methods must have:
- Description
- Error conditions
- Examples
- Panics (if any)

### 10.3 Type Documentation

All public types must have:
- Purpose
- Invariants
- Thread safety guarantees
- Examples

---

## 11. Success Criteria

### 11.1 Functional Requirements

- ✅ All network methods have comprehensive unit tests
- ✅ State machine transitions are fully tested
- ✅ Error handling is tested for all error codes
- ✅ Callback integration is tested
- ✅ Integration tests cover full auth flow

### 11.2 Non-Functional Requirements

- ✅ Test coverage ≥ 70%
- ✅ 0 clippy warnings
- ✅ 0 production unwrap() calls
- ✅ All public APIs documented
- ✅ Cyclomatic complexity ≤ 15

### 11.3 Integration Requirements

- ✅ All tests pass with mock dispatcher
- ✅ Integration tests pass
- ✅ Coverage report generated
- ✅ No breaking changes to public API

---

## 12. Implementation Phases

### Phase 3.1: Testing Foundation (0.5 day)

- [ ] Create `MockNetQueryDispatcher`
- [ ] Set up test fixtures for auth states
- [ ] Add test utilities for TL mocking

### Phase 3.2: Unit Tests (1 day)

- [ ] `send_code()` tests (success, error, state transition)
- [ ] `sign_in()` tests (success, error, 2FA, state transition)
- [ ] `send_log_out()` tests (success, error, state transition)
- [ ] Callback tests (AuthQueryCallback, SignInQueryCallback, LogOutQueryCallback)
- [ ] State machine tests (transitions, retry logic)

### Phase 3.3: Integration Tests (0.5 day)

- [ ] Full authentication flow
- [ ] Bot token authentication
- [ ] Logout flow
- [ ] Error recovery flow

### Phase 4: Coverage Validation (0.5 day)

- [ ] Run `cargo llvm-cov`
- [ ] Verify ≥70% coverage
- [ ] Add tests for uncovered code
- [ ] Generate coverage report

---

## 13. Open Questions

### Q1: Architecture Pattern
**Status**: ANSWERED (keep current pattern)  
**Decision**: Use direct NetQueryDispatcher (no NetworkClient wrapper)

### Q2: State Persistence
**Status**: DEFERRED  
**Decision**: Out of scope for this epic

### Q3: Crash Recovery
**Status**: ANSWERED  
**Decision**: Force restart (user must request new code)

### Q4: Testing Strategy
**Status**: ANSWERED  
**Decision**: Hybrid approach (unit tests with mocks, integration tests with mock dispatcher)

---

## 14. References

- TDLib `AuthManager` class: `references/td/td/telegram/AuthManager.cpp`
- MTProto specification: `references/mtproto.md`
- TL schema: `references/telegram_api.tl`
- DialogManager network integration: `crates/dialog_manager/src/network.rs`

---

**Document Status**: ✅ Complete  
**Next Phase**: Gate 2.5 - Verification  
**Approvals**: Pending
