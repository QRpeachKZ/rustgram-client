# Success Criteria: Phase 2A - Core TL Deserialization
# Epic: rustgram-client-29c
# Phase: Phase 2A
# Version: 1.0
# Date: 2026-01-21
# Status: Draft

---

## Overview

This document defines quantifiable success criteria for Phase 2A: Core TL Deserialization implementation.

---

## Criteria

### compilation

  - id: "SC-001"
    description: "tl_core crate compiles without errors"
    metric: "cargo build --package rustgram-tl-core"
    target: "exit code 0"
    priority: "MUST"
  
  - id: "SC-002"
    description: "Zero clippy warnings"
    metric: "cargo clippy --package rustgram-tl-core -- -D warnings"
    target: "0 warnings"
    priority: "MUST"
  
  - id: "SC-003"
    description: "Code formatting passes"
    metric: "cargo fmt -- --check"
    target: "exit code 0"
    priority: "MUST"

### code_coverage

  - id: "SC-004"
    description: "Minimum test count"
    metric: "cargo test --package rustgram-tl-core | grep 'test result:'"
    target: ">= 200 tests passing"
    priority: "MUST"
  
  - id: "SC-005"
    description: "Code coverage percentage"
    metric: "cargo llvm-cov --package rustgram-tl-core --html"
    target: ">= 80% coverage"
    priority: "MUST"
  
  - id: "SC-006"
    description: "Golden test coverage"
    metric: "Count of golden test files in tl_core/tests/golden/"
    target: ">= 10 golden test files"
    priority: "MUST"

### tl_schema_compliance

  - id: "SC-007"
    description: "Photo constructor IDs verified"
    metric: "Constructor ID verification table"
    target: "All 7 Photo/PhotoSize constructor IDs match telegram_api.tl"
    priority: "MUST"
  
  - id: "SC-008"
    description: "ChatFull constructor ID verified"
    metric: "Constructor ID verification"
    target: "chatFull#2633421b verified"
    priority: "MUST"
  
  - id: "SC-009"
    description: "All implemented types have constructor IDs"
    metric: "Code inspection: TlConstructor trait implemented"
    target: "100% of types implement TlConstructor"
    priority: "MUST"
  
  - id: "SC-010"
    description: "Flag handling correctness"
    metric: "Unit tests for flag bits 0-20"
    target: "All 20+ flag positions tested"
    priority: "MUST"
  
  - id: "SC-011"
    description: "Binary format matches TDLib"
    metric: "Golden test roundtrip with TDLib data"
    target: "100% of golden tests pass"
    priority: "MUST"

### api_completeness

  - id: "SC-012"
    description: "Photo type implementation"
    metric: "Type definition inspection"
    target: "Photo enum with Empty + Photo variants"
    priority: "MUST"
  
  - id: "SC-013"
    description: "PhotoSize variants implementation"
    metric: "Enum variant count"
    target: "All 6 PhotoSize variants implemented"
    priority: "MUST"
  
  - id: "SC-014"
    description: "Peer variants implementation"
    metric: "Enum variant count"
    target: "All 3 Peer variants implemented"
    priority: "MUST"
  
  - id: "SC-015"
    description: "InputPeer variants implementation"
    metric: "Enum variant count"
    target: "All 8 InputPeer variants implemented"
    priority: "MUST"
  
  - id: "SC-016"
    description: "PeerNotifySettings implementation"
    metric: "Struct field count"
    target: "11 fields (all flags) implemented"
    priority: "MUST"
  
  - id: "SC-017"
    description: "ChatFull implementation"
    metric: "Struct field count"
    target: "All 20+ fields from telegram_api.tl:132"
    priority: "MUST"
  
  - id: "SC-018"
    description: "ChatParticipants variants"
    metric: "Enum variant count"
    target: "ChatParticipants + ChatParticipantsForbidden"
    priority: "MUST"
  
  - id: "SC-019"
    description: "ChannelParticipant variants"
    metric: "Enum variant count"
    target: "All 10+ ChannelParticipant variants"
    priority: "MUST"
  
  - id: "SC-020"
    description: "UserFull implementation"
    metric: "Struct field count"
    target: "All 15+ fields from userFull TL schema"
    priority: "MUST"
  
  - id: "SC-021"
    description: "BotInfo implementation"
    metric: "Struct field count"
    target: "All BotInfo fields from TL schema"
    priority: "MUST"

### documentation

  - id: "SC-022"
    description: "Public API documentation"
    metric: "missing_docs lint"
    target: "0 missing_docs warnings"
    priority: "SHOULD"
  
  - id: "SC-023"
    description: "Example code coverage"
    metric: "Doc examples count"
    target: ">= 20 doc examples with runnable code"
    priority: "SHOULD"
  
  - id: "SC-024"
    description: "README completeness"
    metric: "README.md sections"
    target: "Overview, Installation, Usage, Examples, API docs link"
    priority: "MUST"

### error_handling

  - id: "SC-025"
    description: "Error type completeness"
    metric: "TlError enum variant count"
    target: ">= 8 error variants covering all failure modes"
    priority: "MUST"
  
  - id: "SC-026"
    description: "Error context preservation"
    metric: "Error fields inspection"
    target: "All error variants include context fields"
    priority: "MUST"
  
  - id: "SC-027"
    description: "Error conversion to std::error::Error"
    metric: "thiserror macro usage"
    target: "TlError implements std::error::Error"
    priority: "MUST"
  
  - id: "SC-028"
    description: "Production code has no unwrap()"
    metric: "grep -r 'unwrap()' tl_core/src/ | grep -v test"
    target: "0 unwrap() calls in production code"
    priority: "MUST"

### performance

  - id: "SC-029"
    description: "Photo deserialization performance"
    metric: "Criterion benchmark: bench_deserialize_photo"
    target: "< 500Î¼s mean time for 3-5 KB Photo"
    priority: "SHOULD"
  
  - id: "SC-030"
    description: "ChatFull deserialization performance"
    metric: "Criterion benchmark: bench_deserialize_chatfull"
    target: "< 2ms mean time for 10-20 KB ChatFull"
    priority: "SHOULD"
  
  - id: "SC-031"
    description: "UserFull deserialization performance"
    metric: "Criterion benchmark: bench_deserialize_userfull"
    target: "< 1.5ms mean time for 8-15 KB UserFull"
    priority: "SHOULD"
  
  - id: "SC-032"
    description: "Memory efficiency"
    metric: "Heap allocations in deserialization"
    target: "< 10 allocations per KB of data"
    priority: "SHOULD"

### integration

  - id: "SC-033"
    description: "user_manager integration"
    metric: "user_manager uses tl_core for UserFull"
    target: "user_manager/Cargo.toml depends on rustgram-tl-core"
    priority: "MUST"
  
  - id: "SC-034"
    description: "dialog_manager integration"
    metric: "dialog_manager uses tl_core for ChatFull"
    target: "dialog_manager/Cargo.toml depends on rustgram-tl-core"
    priority: "MUST"
  
  - id: "SC-035"
    description: "Backward compatibility"
    metric: "Existing managers still compile"
    target: "cargo build --workspace passes"
    priority: "MUST"
  
  - id: "SC-036"
    description: "Types crate compatibility"
    metric: "tl_core implements TlDeserialize from types crate"
    target: "No breaking changes to rustgram-types"
    priority: "MUST"

### testing_quality

  - id: "SC-037"
    description: "Unit test quality"
    metric: "Unit test assertions coverage"
    target: "Each public method has >= 3 test cases"
    priority: "SHOULD"
  
  - id: "SC-038"
    description: "Golden test authenticity"
    metric: "Golden test files from TDLib"
    target: "100% of golden tests from real TDLib responses"
    priority: "MUST"
  
  - id: "SC-039"
    description: "Error case testing"
    metric: "Test count for error paths"
    target: ">= 30 tests for error scenarios"
    priority: "SHOULD"
  
  - id: "SC-040"
    description: "Edge case coverage"
    metric: "Tests for empty, min, max values"
    target: "Each type has empty/min/max test"
    priority: "SHOULD"

---

## Verification Command

```bash
#!/bin/bash
set -e

echo "=== Verifying Phase 2A: Core TL Deserialization ==="

cd /Users/alfa/Documents/Self_projects/github/rustgram-client

echo ""
echo "=== SC-001 to SC-003: Compilation ==="
cargo build --package rustgram-tl-core
cargo clippy --package rustgram-tl-core -- -D warnings
cargo fmt -- --check

echo ""
echo "=== SC-004 to SC-006: Code Coverage ==="
cargo test --package rustgram-tl-core
cargo llvm-cov --package rustgram-tl-core --html --output-dir coverage/tl_core

echo ""
echo "=== SC-007 to SC-011: TL Schema Compliance ==="
cargo test --package rustgram-tl-core --test constructor_ids
cargo test --package rustgram-tl-core --test golden

echo ""
echo "=== SC-012 to SC-021: API Completeness ==="
# Manual verification: inspect types
echo "Verify: Photo enum has 2 variants"
echo "Verify: PhotoSize enum has 6 variants"
echo "Verify: Peer enum has 3 variants"
echo "Verify: InputPeer enum has 8 variants"
echo "Verify: PeerNotifySettings has 11 fields"
echo "Verify: ChatFull has 20+ fields"
echo "Verify: UserFull has 15+ fields"

echo ""
echo "=== SC-022 to SC-024: Documentation ==="
cargo doc --package rustgram-tl-core --no-deps --open

echo ""
echo "=== SC-025 to SC-028: Error Handling ==="
cargo test --package rustgram-tl-core --test error_tests
UNWRAP_COUNT=$(grep -r 'unwrap()' tl_core/src/ | grep -v test | wc -l)
echo "unwrap() count in production: $UNWRAP_COUNT"
if [ "$UNWRAP_COUNT" -gt 0 ]; then
    echo "FAIL: Found unwrap() in production code"
    exit 1
fi

echo ""
echo "=== SC-029 to SC-032: Performance ==="
cargo bench --package rustgram-tl-core

echo ""
echo "=== SC-033 to SC-036: Integration ==="
cargo build --workspace
cargo test --package rustgram-user-manager --test integration
cargo test --package rustgram-dialog-manager --test integration

echo ""
echo "=== SC-037 to SC-040: Testing Quality ==="
cargo test --package rustgram-tl-core
cargo test --package rustgram-tl-core --test edge_cases

echo ""
echo "=== All Criteria Verified ==="
```

---

## Exit Criteria

### phase1_planning

  - "clarification_qa.md created with 10 Q&A pairs"
  - "plan.yaml created with 6 implementation steps"
  - "success_criteria.yaml created with 40 success criteria"
  - "No critical unknowns remain"

### phase2_implementation

  - "SC-001 through SC-040 all pass"
  - "Verification script passes"
  - "Code review approved"
  - "Integration tests pass"

### phase3_completion

  - "All SC criteria met"
  - "Documentation complete"
  - "Ready for integration with user_manager and dialog_manager"

---

## Dependencies Satisfied

### external

  - "serde 1.0 with derive feature available in workspace"
  - "thiserror 1.0 available in workspace"
  - "bytes 1.5 available in workspace"

### internal

  - "rustgram-types crate provides TlHelper, Bytes types"
  - "rustgram-types crate provides TlDeserialize trait definition"

---

## Notes

The Core TL Deserialization module is foundational for network integration. All success criteria must be met before proceeding to Phase 2B (User & Chat Data Implementation).

Key considerations:
- Constructor IDs must match TDLib exactly for binary compatibility
- Flag handling is error-prone - extensive testing required
- Golden tests from TDLib are critical for validation
- Performance matters for large types (ChatFull with 10k+ participants)
- Error messages must be detailed for debugging protocol issues

---

**Version:** 1.0  
**Status:** Draft  
**Owner:** Analyst Agent  
**Review Date:** 2026-01-21
