# Technical Specification: Phase 1 Basic Messaging
# Epic: rustgram-client-6im
# Version: 1.0
# Created: 2026-01-21
# Status: Phase 2 - Analysis & Design

spec:
  module: basic_messaging
  version: 0.1.0
  created: 2026-01-21T00:00:00Z
  updated: 2026-01-21T00:00:00Z
  language: rust
  complexity: high
  estimated_loc: 3500-4500

# ============================================================================
# OVERVIEW
# ============================================================================

overview:
  description: |
    Core messaging functionality implementing Telegram's message send/receive
    operations with persistent storage. This specification covers three main
    components: Message Types, Send Operations, and Receive Operations.
    
  scope:
    included:
      - Text message sending (users, chats, channels)
      - Incoming message processing
      - Message persistence
      - Message metadata tracking
      - Error handling and recovery
      - Basic reply-to support
      
    excluded:
      - Media attachments (photos, videos, documents)
      - Scheduled messages
      - Message editing
      - Message forwarding
      - Message reactions
      - Message threads
      - Story messages
      - Secret chat messages (requires encryption)
      - Bot commands and interactions
      
  tdlib_reference:
    header: references/td/td/telegram/MessagesManager.h
    source: references/td/td/telegram/MessagesManager.cpp
    lines: 39,000+
    key_methods:
      - send_message
      - on_new_message
      - add_message_to_db
      - get_message_from_db

# ============================================================================
# MODULES
# ============================================================================

modules:
  # ========================================================================
  # Module 1: Message Types
  # ========================================================================
  - name: rustgram_message_types
    display_name: Message Types
    description: Core message type definitions and validation
    estimated_loc: 800-1200
    target_tests: 60-80
    complexity: MEDIUM
    
    structs:
      - name: Message
        description: |
          Core message structure representing a Telegram message.
          Simplified from TDLib's Message class (200+ fields) to essential
          fields for Phase 1.
        fields:
          - name: id
            type: MessageId
            doc: Unique message identifier (server-assigned)
            
          - name: dialog_id
            type: DialogId
            doc: Dialog containing this message
            
          - name: sender_id
            type: DialogId
            doc: Sender of the message
            
          - name: date
            type: i32
            doc: Unix timestamp when message was sent
            
          - name: content_type
            type: MessageContentType
            doc: Type of message content
            
          - name: content
            type: MessageContent
            doc: Message content (text for Phase 1)
            
          - name: reply_to
            type: Option<MessageInputReplyTo>
            doc: What this message replies to (optional)
            
          - name: edit_date
            type: Option<i32>
            doc: Last edit timestamp (if edited)
            
          - name: views
            type: Option<i32>
            doc: View count (channels only)
            
          - name: forward_info
            type: Option<MessageForwardInfo>
            doc: Forward information (stub)
            
        methods:
          - name: new
            inputs:
              - name: id
                type: MessageId
              - name: dialog_id
                type: DialogId
              - name: sender_id
                type: DialogId
              - name: content
                type: MessageContent
            returns: Self
            doc: Creates new message
            
          - name: is_valid
            returns: bool
            doc: Checks if message is valid
            
          - name: is_edited
            returns: bool
            doc: Checks if message was edited
            
          - name: is_outgoing
            returns: bool
            doc: Checks if message is outgoing
            
          - name: is_text
            returns: bool
            doc: Checks if message is text content
            
      - name: MessageContent
        description: |
          Message content wrapper. For Phase 1, only text content is supported.
          Future phases will add photo, video, document, etc.
        fields:
          - name: content_type
            type: MessageContentType
            doc: Type of content
            
          - name: text
            type: Option<FormattedText>
            doc: Text content (if message is text)
            
        methods:
          - name: new_text
            inputs:
              - name: text
                type: FormattedText
            returns: Self
            doc: Creates new text message content
            
      - name: FormattedText
        source: rustgram_formatted_text
        description: Text with optional formatting (bold, italic, links, etc.)
        reuse: true
        
    enums:
      - name: MessageContentType
        source: rustgram_message_content_type
        description: Message content type enumeration
        variants:
          - Text
          - Photo       # Future
          - Video       # Future
          - Document    # Future
          - Sticker     # Future
          - Unsupported
        reuse: true
        
    dependencies:
      internal:
        - crate: rustgram_types
          types: [MessageId, DialogId, UserId, ChatId, ChannelId]
          
        - crate: rustgram_message_content_type
          types: [MessageContentType]
          
        - crate: rustgram_formatted_text
          types: [FormattedText]
          
        - crate: rustgram_message_input_reply_to
          types: [MessageInputReplyTo]
          
        - crate: rustgram_message_forward_info
          types: [MessageForwardInfo]
          status: stub
          
      external:
        - crate: serde
          version: "1.0"
          features: ["derive"]
          reason: Serialization for storage
          
        - crate: thiserror
          version: "2.0"
          reason: Error handling
          
    tdlib_alignment:
      class: Message
      file: td/td/telegram/Message.h
      simplification: |
        TDLib Message has 200+ fields including:
        - Complex nested structures
        - Media attachments
        - Reaction data
        - Thread information
        - Story data
        
        Phase 1 implements only:
        - Core identifiers (id, dialog_id, sender_id)
        - Timestamps (date, edit_date)
        - Text content
        - Basic reply-to
        
        This represents ~7% of TDLib's Message functionality.
        
    testing:
      unit_tests: 30+
      integration_tests: 10+
      coverage_target: 80%
      
      test_categories:
        - category: Construction
          tests:
            - test_message_new
            - test_message_with_reply
            - test_message_with_edit_date
            - test_message_content_text
            
        - category: Validation
          tests:
            - test_message_valid
            - test_message_invalid_id
            - test_message_invalid_dialog
            - test_message_empty_content
            
        - category: Queries
          tests:
            - test_is_edited
            - test_is_outgoing
            - test_is_text
            - test_has_reply
            
        - category: Serialization
          tests:
            - test_serialize_message
            - test_deserialize_message
            - test_round_trip
            
  # ========================================================================
  # Module 2: Send Message Operations
  # ========================================================================
  - name: messages_manager_send
    display_name: Messages Manager - Send Operations
    description: Message sending functionality via MTProto
    estimated_loc: 1200-1500
    target_tests: 50-70
    complexity: HIGH
    parent_crate: messages_manager
    
    structs:
      - name: MessagesManager
        description: Main manager for message operations
        fields:
          - name: network_client
            type: Arc<NetworkClient>
            doc: MTProto network client
            
          - name: message_db
            type: Arc<MessageDb>
            doc: Message persistence layer
            
          - name: pending_sends
            type: HashMap<QueryId, PendingSend>
            doc: In-flight send operations
            
          - name: dialog_manager
            type: Arc<DialogManager>
            doc: Dialog validation and metadata
            
        methods:
          - name: send_message
            description: |
              Send a text message to a dialog. This is the main entry point
              for sending messages.
            inputs:
              - name: dialog_id
                type: DialogId
                doc: Target dialog
                
              - name: text
                type: FormattedText
                doc: Message text
                
              - name: reply_to
                type: Option<MessageId>
                doc: Optional message to reply to
                
            returns: Result<MessageId, SendMessageError>
            doc: |
              Sends a message to the specified dialog. Returns the assigned
              message ID on success, or an error if sending fails.
              
              # Process
              1. Validate dialog exists and is accessible
              2. Validate text content (length, formatting)
              3. Construct TL request
              4. Send via network client
              5. Store pending send state
              6. Return temporary message ID
              7. On server response, update with real ID
              
              # Errors
              - DialogNotFound: Dialog doesn't exist
              - DialogNotAccessible: No write access
              - TextTooLong: Message exceeds length limit
              - RateLimited: Too many messages sent
              - NetworkError: Network failure
              
            async: true
            
          - name: on_send_message_result
            description: Handle server response to send_message
            inputs:
              - name: query_id
                type: QueryId
                
              - name: result
                type: SendMessageResult
                
            returns: Result<(), SendMessageError>
            doc: Process server response and update message state
            
          - name: construct_send_message_request
            description: Build TL request for MTProto
            inputs:
              - name: dialog_id
                type: DialogId
                
              - name: input_peer
                type: InputPeer
                
              - name: text
                type: FormattedText
                
              - name: reply_to
                type: Option<MessageId>
                
            returns: SendMessageRequest
            doc: Construct TL request object
            internal: true
            
      - name: PendingSend
        description: State tracking for in-flight message sends
        fields:
          - name: temporary_id
            type: MessageId
            
          - name: dialog_id
            type: DialogId
            
          - name: text
            type: FormattedText
            
          - name: timestamp
            type: i32
            
          - name: reply_to
            type: Option<MessageId>
            
    enums:
      - name: SendMessageError
        description: Errors that can occur during message sending
        variants:
          - name: DialogNotFound
            fields: []
            doc: Dialog doesn't exist
            
          - name: DialogNotAccessible
            fields: [dialog_id: DialogId]
            doc: No write access to dialog
            
          - name: TextTooLong
            fields: [length: usize, max: usize]
            doc: Message exceeds length limit
            
          - name: RateLimited
            fields: [retry_after: i32]
            doc: Too many messages, wait before retry
            
          - name: NetworkError
            fields: [message: String]
            doc: Network failure
            
          - name: ValidationError
            fields: [message: String]
            doc: Invalid message data
            
          - name: TLSerializationError
            fields: [message: String]
            doc: Failed to serialize TL request
            
    tl_types:
      - name: SendMessageRequest
        description: TL request for sending messages
        fields:
          - name: flags
            type: i32
            doc: Request flags
            
          - name: peer
            type: InputPeer
            doc: Target dialog
            
          - name: message
            type: String
            doc: Message text
            
          - name: random_id
            type: i64
            doc: Unique request identifier
            
          - name: reply_to_msg_id
            type: Option<i32>
            doc: Optional reply message ID
            
        tl_constructor: messages.sendMessage
        
      - name: SendMessageResult
        description: TL response from sendMessage
        fields:
          - name: message_id
            type: i32
            doc: Assigned message ID
            
          - name: date
            type: i32
            doc: Server timestamp
            
          - name: pts
            type: i32
            doc: Permanent timestamp index
            
        tl_constructor: Updates
    
    dependencies:
      internal:
        - crate: rustgram_types
          types: [DialogId, MessageId, InputPeer]
          
        - crate: rustgram_dialog_manager
          types: [DialogManager, InputDialogId]
          
        - crate: rustgram_net
          types: [NetworkClient, NetQuery]
          
        - crate: rustgram_message_db
          types: [MessageDb, MessageData]
          
        - crate: rustgram_message_types
          types: [Message, MessageContent]
          
        - crate: rustgram_formatted_text
          types: [FormattedText]
          
      external:
        - crate: tokio
          version: "1.35"
          features: ["sync", "rt"]
          reason: Async runtime
          
        - crate: parking_lot
          version: "0.12"
          reason: Concurrent access
          
        - crate: thiserror
          version: "2.0"
          reason: Error derivation
          
    tdlib_alignment:
      method: send_message
      signature: |
        void send_message(DialogId dialog_id, 
                         MessageContent content, 
                         SendMessageOptions options)
      file: td/td/telegram/MessagesManager.cpp:4523
      simplification: |
        TDLib's send_message supports:
        - Multiple content types
        - Scheduling
        - Effects
        - Forwarding
        - Reply markup
        - Bot commands
        
        Phase 1 implements:
        - Text content only
        - Immediate send (no scheduling)
        - Basic reply-to
        - No effects/markup
        
    testing:
      unit_tests: 25+
      integration_tests: 15+
      coverage_target: 75%
      
      test_categories:
        - category: Send Operations
          tests:
            - test_send_message_success
            - test_send_message_with_reply
            - test_send_message_to_user
            - test_send_message_to_chat
            - test_send_message_to_channel
            
        - category: Error Handling
          tests:
            - test_send_dialog_not_found
            - test_send_dialog_not_accessible
            - test_send_text_too_long
            - test_send_rate_limited
            - test_send_network_error
            
        - category: State Management
          tests:
            - test_pending_send_tracking
            - test_send_result_processing
            - test_send_retry_logic
            - test_send_timeout
            
        - category: TL Construction
          tests:
            - test_construct_send_request
            - test_construct_send_with_reply
            - test_random_id_generation
            
  # ========================================================================
  # Module 3: Receive Message Operations
  # ========================================================================
  - name: messages_manager_receive
    display_name: Messages Manager - Receive Operations
    description: Incoming message processing and storage
    estimated_loc: 1000-1300
    target_tests: 50-70
    complexity: HIGH
    parent_crate: messages_manager
    
    structs:
      - name: MessagesManager
        extends: messages_manager_send
        description: Extended with receive operations
        
        methods:
          - name: on_update_new_message
            description: |
              Process incoming message update from MTProto. This is the main
              entry point for receiving messages.
            inputs:
              - name: update
                type: UpdateNewMessage
                
            returns: Result<(), ReceiveMessageError>
            doc: |
              Process an incoming message from the server:
              1. Extract message data from update
              2. Validate message structure
              3. Check for duplicates (by message_id + dialog_id)
              4. Store message in database
              5. Trigger notifications
              6. Update dialog metadata
              7. Invoke registered callbacks
              
            async: true
            
          - name: process_incoming_message
            description: Core message processing logic
            inputs:
              - name: message
                type: Message
                doc: Incoming message
                
            returns: Result<(), ProcessError>
            doc: |
              Process a validated message:
              1. Deduplication check
              2. Store in database
              3. Update dialog last message
              4. Trigger notification
              5. Invoke callbacks
            internal: true
            
          - name: deduplicate_message
            description: Check for duplicate messages
            inputs:
              - name: full_id
                type: MessageFullId
                
            returns: bool
            doc: Returns true if message is duplicate
            internal: true
            
          - name: store_received_message
            description: Persist received message
            inputs:
              - name: message
                type: Message
                
            returns: Result<(), DbError>
            doc: Store message in database
            internal: true
            
          - name: trigger_message_notification
            description: Notify about new message
            inputs:
              - name: message
                type: Message
                
            returns: ()
            doc: Trigger notification hooks
            internal: true
            
      - name: MessageHandler
        description: Callback for message processing
        fields:
          - name: callback
            type: MessageCallback
            
        methods:
          - name: on_message
            inputs:
              - name: message
                type: &Message
                
            returns: ()
            doc: User-provided message handler
            
    types:
      - name: MessageCallback
        description: Callback type for message events
        type: fn(&Message) -> BoxFuture<'static, ()>
        
    enums:
      - name: ReceiveMessageError
        description: Errors during message receiving
        variants:
          - name: InvalidUpdate
            fields: [reason: String]
            
          - name: DuplicateMessage
            fields: [id: MessageFullId]
            
          - name: StorageError
            fields: [error: DbError]
            
          - name: ProcessingError
            fields: [message: String]
            
    tl_types:
      - name: UpdateNewMessage
        description: TL update for new messages
        fields:
          - name: message
            type: Message
            doc: The new message
            
          - name: pts
            type: i32
            doc: Permanent timestamp
            
          - name: pts_count
            type: i32
            doc: PTS change count
            
        tl_constructor: UpdateNewMessage
        
      - name: UpdateShortMessage
        description: Optimized update for text messages
        fields:
          - name: id
            type: i32
            
          - name: user_id
            type: i32
            
          - name: message
            type: String
            
          - name: pts
            type: i32
            
          - name: pts_count
            type: i32
            
          - name: date
            type: i32
            
        tl_constructor: UpdateShortMessage
    
    dependencies:
      internal:
        - crate: rustgram_types
          types: [DialogId, MessageId]
          
        - crate: rustgram_message_db
          types: [MessageDb]
          
        - crate: rustgram_message_full_id
          types: [MessageFullId]
          
        - crate: rustgram_message_types
          types: [Message]
          
        - crate: rustgram_net
          types: [NetQuery, UpdateHandler]
          
      external:
        - crate: tokio
          version: "1.35"
          features: ["sync", "rt", "time"]
          
        - crate: dashmap
          version: "5.5"
          reason: Concurrent deduplication cache
          
        - crate: tracing
          version: "0.1"
          reason: Structured logging
          
    tdlib_alignment:
      method: on_new_message
      signature: |
        void on_new_message(telegram_api::message& message,
                          DialogId dialog_id,
                          bool is_channel_message)
      file: td/td/telegram/MessagesManager.cpp:8234
      simplification: |
        TDLib's on_new_message handles:
        - All content types
        - Message threading
        - Forward detection
        - Silent messages
        - Post authoring
        - Legacy updates
        
        Phase 1 implements:
        - Text messages only
        - Basic deduplication
        - No threading
        - No special message types
        
    testing:
      unit_tests: 25+
      integration_tests: 15+
      coverage_target: 75%
      
      test_categories:
        - category: Receive Processing
          tests:
            - test_receive_new_message
            - test_receive_short_message
            - test_receive_with_reply
            - test_receive_edited_message
            
        - category: Deduplication
          tests:
            - test_duplicate_detection
            - test_duplicate_prevention
            - test_cache_eviction
            
        - category: Storage
          tests:
            - test_store_received
            - test_store_failure
            - test_concurrent_storage
            
        - category: Notifications
          tests:
            - test_trigger_notification
            - test_callback_invocation
            - test_multiple_callbacks
            
  # ========================================================================
  # Module 4: Message Persistence (Shared)
  # ========================================================================
  - name: message_db
    display_name: Message Database
    description: Message persistence layer (extends existing stub)
    estimated_loc: 500-700
    target_tests: 40-60
    complexity: MEDIUM
    status: enhance_existing
    
    structs:
      - name: MessageDb
        description: |
          Enhanced message database with full CRUD operations.
          Extends existing stub implementation.
        fields:
          - name: messages
            type: HashMap<MessageFullId, Message>
            doc: Message storage
            
          - name: dialog_index
            type: HashMap<DialogId, Vec<MessageId>>
            doc: Per-dialog message lists
            
          - name: last_message
            type: HashMap<DialogId, MessageId>
            doc: Last message in each dialog
            
        methods:
          - name: add_message
            inputs:
              - name: message
                type: Message
                
            returns: Result<(), DbError>
            doc: Store a message
            
          - name: get_message
            inputs:
              - name: full_id
                type: MessageFullId
                
            returns: Result<Option<Message>, DbError>
            doc: Retrieve a message by ID
            
          - name: get_dialog_messages
            inputs:
              - name: dialog_id
                type: DialogId
              
              - name: limit
                type: usize
              
            returns: Result<Vec<Message>, DbError>
            doc: Get recent messages from dialog
            
          - name: delete_message
            inputs:
              - name: full_id
                type: MessageFullId
                
            returns: Result<bool, DbError>
            doc: Delete a message
            
          - name: update_dialog_last_message
            inputs:
              - name: dialog_id
                type: DialogId
              
              - name: message_id
                type: MessageId
                
            returns: Result<(), DbError>
            doc: Update last message pointer
            
    enums:
      - name: DbError
        description: Database operation errors
        variants:
          - NotFound
          - SerializationError
          - TransactionError
          - IoError
            
    dependencies:
      internal:
        - crate: rustgram_types
          types: [DialogId, MessageId]
          
        - crate: rustgram_message_full_id
          types: [MessageFullId]
          
        - crate: rustgram_message_types
          types: [Message]
          
      external:
        - crate: rocksdb
          version: "0.21"
          optional: true
          reason: Persistent storage backend
          
        - crate: sled
          version: "0.34"
          optional: true
          reason: Alternative storage backend
          
        - crate: serde
          version: "1.0"
          reason: Serialization
          
    tdlib_alignment:
      class: MessageDb
      file: td/td/telegram/MessageDb.h
      simplification: |
        TDLib uses SQLite with custom serialization.
        Phase 1 uses in-memory HashMap with optional RocksDB/sled backends.
        
    testing:
      unit_tests: 30+
      integration_tests: 10+
      coverage_target: 70%

# ============================================================================
# DATA FLOW DIAGRAMS
# ============================================================================

data_flow:
  send_message_flow:
    description: Complete flow for sending a message
    steps:
      - step: 1
        actor: User/API
        action: Call send_message(dialog_id, text)
        output: FormattedText, DialogId
        
      - step: 2
        actor: MessagesManager
        action: Validate dialog access via DialogManager
        output: InputPeer
        
      - step: 3
        actor: MessagesManager
        action: Validate text content
        output: Validated FormattedText
        
      - step: 4
        actor: MessagesManager
        action: Generate temporary MessageId
        output: MessageId(temp)
        
      - step: 5
        actor: MessagesManager
        action: Store pending send state
        output: PendingSend record
        
      - step: 6
        actor: MessagesManager
        action: Construct SendMessageRequest TL
        output: TL serialized bytes
        
      - step: 7
        actor: NetworkClient
        action: Send MTProto request
        output: QueryId
        
      - step: 8
        actor: MTProto Server
        action: Process message
        output: SendMessageResult
        
      - step: 9
        actor: MessagesManager
        action: on_send_message_result handler
        output: MessageId(real)
        
      - step: 10
        actor: MessagesManager
        action: Store message in MessageDb
        output: Persisted message
        
      - step: 11
        actor: MessagesManager
        action: Return to caller
        output: Result<MessageId, Error>
        
    diagram: |
      ┌─────────┐
      │   User  │
      └────┬────┘
           │ send_message(dialog_id, text)
           ▼
      ┌─────────────────────┐
      │  MessagesManager    │
      └──────┬──────────────┘
             │
             ├─► Validate dialog (DialogManager)
             │
             ├─► Validate text
             │
             ├─► Generate temp MessageId
             │
             ├─► Store pending state
             │
             ▼
      ┌─────────────────────┐
      │ Construct TL Request │
      └──────┬──────────────┘
             │
             ▼
      ┌─────────────────────┐
      │   NetworkClient     │
      └──────┬──────────────┘
             │ MTProto send
             ▼
      ┌─────────────────────┐
      │  Telegram Server    │
      └──────┬──────────────┘
             │ Response
             ▼
      ┌─────────────────────┐
      │ on_send_message_    │
      │ result              │
      └──────┬──────────────┘
             │
             ├─► Store in MessageDb
             │
             ├─► Update dialog metadata
             │
             └─► Return MessageId
      
  receive_message_flow:
    description: Complete flow for receiving a message
    steps:
      - step: 1
        actor: MTProto Update
        action: Receive UpdateNewMessage
        output: Update TL object
        
      - step: 2
        actor: NetworkClient
        action: Parse update
        output: UpdateNewMessage
        
      - step: 3
        actor: UpdateHandler
        action: Route to MessagesManager
        output: Callback invocation
        
      - step: 4
        actor: MessagesManager
        action: on_update_new_message
        output: Validation
        
      - step: 5
        actor: MessagesManager
        action: Check deduplication cache
        output: is_duplicate flag
        
      - step: 6
        actor: MessagesManager
        action: Parse message TL
        output: Message struct
        
      - step: 7
        actor: MessageDb
        action: Store message
        output: Persisted message
        
      - step: 8
        actor: MessagesManager
        action: Update dialog last_message
        output: Dialog metadata
        
      - step: 9
        actor: MessagesManager
        action: trigger_message_notification
        output: Notification event
        
      - step: 10
        actor: User Callback
        action: Process new message
        output: User-defined action
        
    diagram: |
      ┌──────────────────┐
      │  MTProto Update  │
      └─────┬────────────┘
            │ UpdateNewMessage
            ▼
      ┌──────────────────┐
      │  NetworkClient   │
      └─────┬────────────┘
            │ Route update
            ▼
      ┌──────────────────┐
      │ UpdateDispatcher │
      └─────┬────────────┘
            │ Delegate
            ▼
      ┌─────────────────────┐
      │  MessagesManager    │
      │                      │
      │ on_update_new_      │
      │ message              │
      └──────┬──────────────┘
             │
             ├─► Check deduplication
             │
             ├─► Parse TL → Message
             │
             ├─► Store in MessageDb
             │
             ├─► Update dialog metadata
             │
             └─► Trigger notification
                     │
                     ▼
             ┌─────────────────┐
             │ User Callback   │
             └─────────────────┘

# ============================================================================
# ERROR HANDLING
# ============================================================================

error_handling:
  send_errors:
    - error: DialogNotFound
      recovery: None (user error)
      user_message: "Dialog not found or deleted"
      
    - error: DialogNotAccessible
      recovery: Check permissions
      user_message: "You don't have permission to send"
      
    - error: TextTooLong
      recovery: Truncate or split message
      user_message: "Message too long (max 4096 characters)"
      
    - error: RateLimited
      recovery: Wait and retry
      user_message: "Too many messages. Please wait {seconds} seconds."
      retry_strategy: Exponential backoff
      
    - error: NetworkError
      recovery: Retry with backoff
      user_message: "Network error. Retrying..."
      retry_strategy: |
        1. Immediate retry (1x)
        2. Wait 1s, retry (2x)
        3. Wait 5s, retry (3x)
        4. Wait 15s, retry (infinite)
        
  receive_errors:
    - error: InvalidUpdate
      recovery: Log and discard
      action: "Invalid update format: {reason}"
      
    - error: DuplicateMessage
      recovery: Silently ignore
      action: "Duplicate message {id} ignored"
      
    - error: StorageError
      recovery: Retry once, then fail
      action: "Failed to store message: {error}"
      user_impact: "Message may not appear in history"
      
    - error: ProcessingError
      recovery: Skip message, notify user
      action: "Failed to process message: {message}"
      user_impact: "Message received but not fully processed"

# ============================================================================
# THREAD SAFETY
# ============================================================================

thread_safety:
  model: Actor-based message passing
  synchronization:
    - type: Arc<RwLock<T>>
      usage: Shared state (message cache, pending operations)
      
    - type: Arc<Mutex<T>>
      usage: Database transaction coordination
      
    - type: dashmap::DashMap
      usage: High-frequency concurrent access (deduplication cache)
      
  guarantees:
    - guarantee: "No data races in message storage"
      mechanism: "RwLock protects all MessageDb access"
      
    - guarantee: "Message ordering preserved"
      mechanism: "MessageId provides ordering guarantees"
      
    - guarantee: "No lost updates"
      mechanism: "Pending send state tracked until completion"
      
  concurrent_operations:
    - operation: "Send to multiple dialogs"
      safety: "Independent state per dialog"
      
    - operation: "Concurrent receives"
      safety: "DashMap provides lock-free reads"
      
    - operation: "Send + receive same dialog"
      safety: "RwLock allows concurrent read/write"

# ============================================================================
# TESTING REQUIREMENTS
# ============================================================================

testing:
  unit_tests:
    total_target: 120+
    breakdown:
      - module: Message types
        tests: 30
        focus:
          - Construction
          - Validation
          - Serialization
          - Query methods
          
      - module: Send operations
        tests: 35
        focus:
          - Send flows
          - Error handling
          - TL construction
          - State management
          
      - module: Receive operations
        tests: 35
        focus:
          - Update parsing
          - Deduplication
          - Storage
          - Notifications
          
      - module: Database
        tests: 20
        focus:
          - CRUD operations
          - Indexing
          - Transaction handling
          
  integration_tests:
    total_target: 40+
    scenarios:
      - scenario: "Send → Receive round-trip"
        tests: 10
        steps:
          - Send message to test dialog
          - Wait for server response
          - Receive message via update
          - Verify message stored
          - Verify notification sent
        
      - scenario: "Concurrent operations"
        tests: 10
        steps:
          - Send 100 messages concurrently
          - Receive 100 messages concurrently
          - Verify no data loss
          - Verify ordering preserved
          
      - scenario: "Error recovery"
        tests: 10
        steps:
          - Trigger network error
          - Verify retry logic
          - Verify eventual success
          
      - scenario: "Database consistency"
        tests: 10
        steps:
          - Store message
          - Retrieve message
          - Update message
          - Delete message
          - Verify consistency
          
  property_tests:
    total_target: 10+
    properties:
      - property: "Message ID uniqueness"
        strategy: "Generate 10k messages, verify unique IDs"
        
      - property: "Serialization round-trip"
        strategy: "Random messages, serialize/deserialize, verify equality"
        
      - property: "Message ordering"
        strategy: "Generate messages with different dates, verify ordering"
        
  concurrency_tests:
    total_target: 20+
    scenarios:
      - scenario: "Concurrent sends"
        threads: 10
        operations: 1000
        verification: No deadlocks, no lost messages
        
      - scenario: "Concurrent receives"
        threads: 10
        operations: 1000
        verification: No duplicates, correct ordering
        
      - scenario: "Mixed operations"
        threads: 10
        sends: 500
        receives: 500
        verification: No data corruption

# ============================================================================
# PERFORMANCE TARGETS
# ============================================================================

performance:
  send_operation:
    target_p50: "<20ms"
    target_p95: "<50ms"
    target_p99: "<100ms"
    measurement: "From send_message call to MessageId return"
    
  receive_operation:
    target_p50: "<30ms"
    target_p95: "<100ms"
    target_p99: "<200ms"
    measurement: "From update received to notification triggered"
    
  database_operation:
    target_p50: "<1ms"
    target_p95: "<5ms"
    target_p99: "<10ms"
    measurement: "Single message read/write"
    
  memory:
    target_per_message: "<1KB"
    includes: "Message struct + indexes"
    
  throughput:
    target_send: ">100 msg/sec"
    target_receive: ">500 msg/sec"
    measurement: "Sustained rate without degradation"

# ============================================================================
# DOCUMENTATION REQUIREMENTS
# ============================================================================

documentation:
  required:
    - Module-level API docs
    - TDLib alignment notes
    - Usage examples
    - Error handling guide
    - Testing guide
    
  deliverables:
    - file: docs/basic-messaging-architecture.md
      content: |
        - System architecture overview
        - Component interaction diagrams
        - Data flow diagrams
        - Deployment considerations
        
    - file: crates/rustgram_message_types/README.md
      content: |
        - Type definitions
        - Construction examples
        - Validation rules
        - Serialization format
        
    - file: crates/messages_manager/README.md
      content: |
        - Send/Receive API
        - Error handling
        - Configuration options
        - Performance tuning
        
    - file: crates/message_db/README.md
      content: |
        - Storage backends
        - Schema design
        - Performance characteristics
        - Backup/recovery

# ============================================================================
# SUCCESS CRITERIA
# ============================================================================

success_criteria:
  functional:
    - criterion: "Send text message"
      test: "Send message to user/chat/channel"
      threshold: "100% success rate in normal conditions"
      
    - criterion: "Receive message"
      test: "Process incoming update"
      threshold: "<100ms processing time"
      
    - criterion: "Persist message"
      test: "Store and retrieve"
      threshold: "100% data integrity"
      
    - criterion: "Handle errors"
      test: "Network/rate limit/validation errors"
      threshold: "Graceful degradation, no crashes"
      
  code_quality:
    - criterion: "Zero clippy warnings"
      measurement: "cargo clippy -- -D warnings"
      
    - criterion: "Zero unwrap() in production"
      measurement: "grep -r unwrap() src/ | grep -v test"
      
    - criterion: "100% public API documented"
      measurement: "cargo doc --no-deps"
      
  testing:
    - criterion: "200+ tests"
      measurement: "cargo test --quiet"
      
    - criterion: "100% test pass rate"
      measurement: "cargo test"
      
    - criterion: "70%+ coverage"
      measurement: "cargo llvm-cov"
      
  performance:
    - criterion: "Send latency <50ms p95"
      measurement: "cargo bench --bench send"
      
    - criterion: "Receive processing <100ms p95"
      measurement: "cargo bench --bench receive"
