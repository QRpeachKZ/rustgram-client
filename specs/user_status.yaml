# User Status Module Specification
# Version: 1.0.0
# Date: 2025-01-17
# Epic: Epic-21 - User Management

metadata:
  module: "user_status"
  crate_name: "rustgram-user-status"
  complexity: "simple"
  type: "enum"
  estimated_effort: "2-3 hours"
  test_target: ">=30 tests"

# TL Schema Reference from telegram_api.tl
# userStatusEmpty#9d05049 = UserStatus;
# userStatusOnline#edb93949 expires:int = UserStatus;
# userStatusOffline#8c703f was_online:int = UserStatus;
# userStatusRecently#7b197dc8 flags:# by_me:flags.0?true = UserStatus;
# userStatusLastWeek#541a1d1a flags:# by_me:flags.0?true = UserStatus;
# userStatusLastMonth#65899777 flags:# by_me:flags.0?true = UserStatus;

# TD API Reference from td_api.tl
# userStatusEmpty = UserStatus;
# userStatusOnline expires:int32 = UserStatus;
# userStatusOffline was_online:int32 = UserStatus;
# userStatusRecently by_my_privacy_settings:Bool = UserStatus;
# userStatusLastWeek by_my_privacy_settings:Bool = UserStatus;
# userStatusLastMonth by_my_privacy_settings:Bool = UserStatus;

enum_definition:
  name: "UserStatus"
  repr: "enum"
  derives:
    - "Debug"
    - "Clone"
    - "Copy"
    - "PartialEq"
    - "Eq"
    - "Hash"
    - "Default"
  attributes:
    - "non_exhaustive"  # Allow adding future variants
    - "repr(i32)"        # FFI-compatible representation

variants:
  - name: "Empty"
    value: 0
    description: |
      User has never been online or status is unknown.
      This is the default/placeholder status.
    tl_constructor: "userStatusEmpty"
    td_api_type: "userStatusEmpty"
    fields: []
    methods:
      - "is_empty() -> bool"

  - name: "Online"
    value: 1
    description: |
      User is currently online. The expires field indicates when
      the online status will automatically change to offline.
    tl_constructor: "userStatusOnline"
    tl_hex: "0xedb93949"
    td_api_type: "userStatusOnline"
    fields:
      - name: "expires"
        type: "i32"
        description: "Unix timestamp when online status expires"
    methods:
      - "is_online() -> bool"
      - "expires() -> i32"
      - "is_expired() -> bool (checks if current time > expires)"

  - name: "Offline"
    value: 2
    description: |
      User is offline. The was_online field indicates the last time
      the user was online.
    tl_constructor: "userStatusOffline"
    tl_hex: "0x8c703f"
    td_api_type: "userStatusOffline"
    fields:
      - name: "was_online"
        type: "i32"
        description: "Unix timestamp when user was last online"
    methods:
      - "is_offline() -> bool"
      - "was_online() -> i32"

  - name: "Recently"
    value: 3
    description: |
      User was online recently. Exact status is hidden due to privacy settings.
      The by_me flag indicates if the current user's privacy settings caused this.
    tl_constructor: "userStatusRecently"
    tl_hex: "0x7b197dc8"
    td_api_type: "userStatusRecently"
    fields:
      - name: "by_my_privacy_settings"
        type: "bool"
        description: |
          True if the current user's privacy settings hide the exact status.
          In TDLib API this is called by_my_privacy_settings.
    methods:
      - "is_recently() -> bool"
      - "by_my_privacy_settings() -> bool"

  - name: "LastWeek"
    value: 4
    description: |
      User was online within the last week. Exact status is hidden due to privacy settings.
      The by_me flag indicates if the current user's privacy settings caused this.
    tl_constructor: "userStatusLastWeek"
    tl_hex: "0x541a1d1a"
    td_api_type: "userStatusLastWeek"
    fields:
      - name: "by_my_privacy_settings"
        type: "bool"
        description: |
          True if the current user's privacy settings hide the exact status.
          In TDLib API this is called by_my_privacy_settings.
    methods:
      - "is_last_week() -> bool"
      - "by_my_privacy_settings() -> bool"

  - name: "LastMonth"
    value: 5
    description: |
      User was online within the last month. Exact status is hidden due to privacy settings.
      The by_me flag indicates if the current user's privacy settings caused this.
    tl_constructor: "userStatusLastMonth"
    tl_hex: "0x65899777"
    td_api_type: "userStatusLastMonth"
    fields:
      - name: "by_my_privacy_settings"
        type: "bool"
        description: |
          True if the current user's privacy settings hide the exact status.
          In TDLib API this is called by_my_privacy_settings.
    methods:
      - "is_last_month() -> bool"
      - "by_my_privacy_settings() -> bool"

# Type conversion methods
type_conversions:
  from_i32:
    description: "Convert from i32 to UserStatus"
    return_type: "Option<Self>"
    validation: "Returns None for values outside 0-5 range"

  to_i32:
    description: "Convert UserStatus to i32 representation"
    return_type: "i32"

  from_tl_constructor:
    description: "Parse from MTProto TL constructor"
    parameters:
      - name: "constructor"
        type: "u32"
    return_type: "Option<Self>"
    note: "Maps hex constructors to variants"

# Helper methods
helper_methods:
  - name: "display_name"
    return_type: "&'static str"
    description: "Human-readable name for the status"

  - name: "is_online_now"
    return_type: "bool"
    description: |
      Checks if user is currently online based on:
      - Online variant with expires > current time
      - All other variants return false

  - name: "time_since_last_online"
    return_type: "Option<i32>"
    description: |
      Returns seconds elapsed since user was last online.
      - Online: returns 0
      - Offline: returns current_time - was_online
      - Recently/LastWeek/LastMonth: returns None
      - Empty: returns None

# Serde support (optional feature)
serde_support:
  enabled: true
  feature_name: "serde"
  derive_attributes:
    - "Serialize"
    - "Deserialize"
  tag: "type"
  content: "data"

# Constants
constants:
  - name: "MAX_VALUE"
    type: "i32"
    value: "5"
    description: "Maximum valid i32 value for UserStatus"

# Display implementation
display:
  trait: "std::fmt::Display"
  format: |
    Empty: "Empty"
    Online: "Online(expires={expires})"
    Offline: "Offline(was_online={was_online})"
    Recently: "Recently(by_me={by_me})"
    LastWeek: "LastWeek(by_me={by_me})"
    LastMonth: "LastMonth(by_me={by_me})"

# Test requirements
test_requirements:
  minimum_tests: 30
  coverage_target: "100%"
  test_categories:
    - name: "trait_implementations"
      tests:
        - "test_default"
        - "test_copy"
        - "test_clone"
        - "test_partial_eq"
        - "test_hash"
        - "test_send_sync"
        - "test_display"

    - name: "variant_creation"
      tests:
        - "test_empty"
        - "test_online"
        - "test_offline"
        - "test_recently"
        - "test_last_week"
        - "test_last_month"

    - name: "variant_checks"
      tests:
        - "test_is_empty"
        - "test_is_online"
        - "test_is_offline"
        - "test_is_recently"
        - "test_is_last_week"
        - "test_is_last_month"

    - name: "field_accessors"
      tests:
        - "test_online_expires"
        - "test_offline_was_online"
        - "test_recently_by_my_privacy_settings"
        - "test_last_week_by_my_privacy_settings"
        - "test_last_month_by_my_privacy_settings"

    - name: "type_conversions"
      tests:
        - "test_from_i32_valid"
        - "test_from_i32_invalid"
        - "test_to_i32"
        - "test_roundtrip_i32"

    - name: "helper_methods"
      tests:
        - "test_display_name"
        - "test_is_online_now"
        - "test_time_since_last_online"

    - name: "edge_cases"
      tests:
        - "test_online_with_past_expiry"
        - "test_online_with_future_expiry"
        - "test_offline_with_zero_timestamp"
        - "test_offline_with_future_timestamp"
        - "test_privacy_flag_combinations"

# Quality requirements
quality_requirements:
  clippy:
    - "no warnings"
    - "deny unwrap_used"
    - "deny expect_used"
  
  rustfmt:
    - "100% compliant"

  documentation:
    - "All public items documented"
    - "All examples tested"
    - "Module-level documentation"

# Dependencies
dependencies:
  internal: []
  external:
    - name: "serde"
      version: "1.0"
      features: ["derive"]
      optional: true

  dev_dependencies:
    - name: "serde_json"
      version: "1.0"
      feature: "serde"

# Success criteria
success_criteria:
  - "All 30+ tests pass"
  - "Zero clippy warnings"
  - "100% rustfmt compliance"
  - "All public APIs documented"
  - "Serde serialization/deserialization works (when feature enabled)"
  - "Compatible with TDLib semantics"
  - "FFI-safe (#[repr(i32)])"
