# Test Coverage Audit Specification
# Parent Task: rustgram-client-ma0.3 "Phase 3: Test Coverage Audit"
# Task ID: rustgram-client-o7z
# Phase: Phase 2 - Spec/Design
# Version: 2.0 (Revised based on validation)

spec:
  title: "Test Coverage Audit for Rustgram Client"
  version: "2.0"
  status: "DRAFT"
  last_updated: "2025-01-17"
  
  scope:
    total_crates: 398
    critical_modules: 13
    manager_modules: 74
    type_modules: 86
    stub_modules: 86
    total_batches: 16
    
  objectives:
    primary:
      - "Generate comprehensive coverage report for all 398 crates"
      - "Identify untested critical modules requiring immediate attention"
      - "Validate actor framework message passing tests"
      - "Create actionable roadmap for test implementation"
      
    secondary:
      - "Establish coverage baseline for future regression testing"
      - "Document test patterns and best practices"
      - "Identify integration test gaps"
      - "Recommend testing toolchain configuration"

---

## Module Categorization

### Critical Modules (13)
**Definition**: Modules handling network I/O, cryptography, authentication, or core architecture

| Module | Category | Coverage Target | Priority |
|--------|----------|-----------------|----------|
| net | Network | 80% | P0 |
| crypto | Cryptography | 80% | P0 |
| storage | State Management | 75% | P0 |
| actor | Core Architecture | 75% | P0 |
| auth_manager | Authentication | 75% | P0 |
| password_manager | Security | 75% | P0 |
| auth | Auth Protocol | 70% | P1 |
| secure_storage | Security | 70% | P1 |
| td_db | Database | 70% | P1 |
| dialog_manager | State Management | 70% | P1 |
| message_db | State Management | 70% | P1 |
| user_manager | Business Logic | 70% | P1 |
| client_actor | Core Architecture | 70% | P1 |

**Testing Requirements**:
- Unit tests for all public APIs
- Integration tests for state mutations
- Property-based tests for crypto operations
- Concurrency tests for actor message passing
- Error path coverage

---

### Manager Modules (74)
**Definition**: Business logic coordinators with `_manager` suffix

**Categories**:
- **Dialog Management**: dialog_manager, dialog_participant_manager, dialog_filter_manager, dialog_invite_link_manager, dialog_action_manager
- **Message Management**: message_query_manager, message_import_manager
- **Media Management**: audios_manager, videos_manager, video_notes_manager, voice_notes_manager, documents_manager, animations_manager, stickers_manager
- **User Management**: user_manager, bot_info_manager, bot_recommendation_manager
- **Network/Connection**: connection_state_manager, download_manager, file_reference_manager
- **Call/Real-time**: call_manager, group_call_manager
- **State/Settings**: state_manager, option_manager, autosave_manager, theme_manager, language_pack_manager, time_zone_manager
- **Notification**: notification_manager (not in list but expected)
- **Updates**: updates_manager
- **Business**: business_manager, business_connection_manager
- **Integration**: attach_menu_manager, web_app_manager, inline_queries_manager, callback_queries_manager, inline_message_manager
- **Privacy**: privacy_manager
- **Other**: poll_manager, quick_reply_manager, referral_program_manager, star_manager, promo_data_manager, suggested_action_manager, statistics_manager, top_dialog_manager, link_manager, resource_manager, phone_number_manager, device_token_manager, terms_of_service_manager, translation_manager, transcription_manager, country_info_manager, common_dialog_manager, channel_recommendation_manager, reaction_manager, saved_messages_manager, forum_topic_manager, web_pages_manager, boost_manager, background_manager, pts_manager, alarm_manager, account_manager, password_manager (also critical)

**Coverage Target**: 60% overall
**Testing Requirements**:
- Unit tests for manager operations
- Mock actor dependencies
- State transition tests
- Error handling validation

---

### Type Modules (86)
**Definition**: Simple wrappers, newtype patterns, enums with minimal logic

**Examples**:
- ID types: user_id, chat_id, message_id, dialog_id, file_id, etc.
- Enums: reaction_type, sticker_type, web_page_type, etc.
- Simple structs: peer_color, venue, formatted_text components

**Coverage Target**: 50% overall
**Testing Requirements**:
- Serialization/deserialization tests
- Display/Debug implementation tests
- From/Trait implementations
- Basic validation logic

---

### Stub Modules (86)
**Definition**: Placeholder implementations with minimal code (<20 lines or explicit stub markers)

**Identification Criteria**:
- File size < 20 lines
- Contains "stub", "placeholder", "TODO", "unimplemented!"
- Empty trait implementations

**Coverage Target**: 20% OR compilation test only
**Testing Requirements**:
- Module compiles successfully
- Basic type checking
- No runtime panics in trivial operations

---

## Test Patterns

### Unit Test Pattern

```rust
#[cfg(test)]
mod tests {
    use super::*;
    
    #[test]
    fn test_basic_functionality() {
        // Arrange
        let input = ...;
        
        // Act
        let result = function_under_test(input);
        
        // Assert
        assert_eq!(result, expected);
    }
    
    #[test]
    fn test_error_handling() {
        // Test error paths
    }
    
    // Property-based testing for complex logic
    #[proptest]
    fn proptest_property(input: StrategyType) {
        // Property-based assertions
    }
}
```

### Integration Test Pattern

```rust
// tests/integration_test.rs
use crate_name::Module;

#[tokio::test]
async fn test_actor_interaction() {
    // Setup actors
    // Send messages
    // Verify state changes
    // Cleanup
}
```

### Actor Test Pattern

```rust
#[cfg(test)]
mod actor_tests {
    use super::*;
    use rustgram_actor::ActorId;
    
    #[tokio::test]
    async fn test_message_passing() {
        // Create mock actors
        // Send messages
        // Verify delivery
        // Check ordering
    }
    
    #[tokio::test]
    async fn test_concurrent_messages() {
        // Concurrent message sending
        // Verify thread safety
        // Check for race conditions
    }
}
```

---

## Coverage Methodology

### Phase 1: Inventory (Step 1)

**Tool**: Custom Bash + Python script  
**Output**: `crate-inventory.json`

```json
{
  "total_crates": 398,
  "categories": {
    "critical": [...],
    "manager": [...],
    "type": [...],
    "stub": [...]
  },
  "dependencies": {
    "crate_name": ["dep1", "dep2"]
  },
  "test_status": {
    "crate_name": {
      "has_unit_tests": true,
      "has_integration_tests": false,
      "test_file_count": 3
    }
  }
}
```

**Script**: `tools/inventory-crates.sh`

```bash
#!/usr/bin/env bash
# Scan all crates, categorize, identify test files
# Output JSON inventory
```

---

### Phase 2: Coverage Analysis (Steps 2-5)

**Tool**: `cargo-llvm-cov` (primary), `tarpaulin` (verification)

**Batch Execution Pattern**:

```bash
# Batch N: Specific module subset
cargo llvm-cov --workspace \
  --exclude-from-file coverage-excludes.txt \
  --include-ffi \
  --html \
  --output-dir coverage/batch-N \
  --package <package-list>
```

**Package List Format**:
```bash
--package rustgram-net \
--package rustgram-crypto \
# ... etc
```

**Output**: `coverage/batch-N/index.html`

**Aggregation**:
- Parse HTML reports
- Extract coverage percentages
- Categorize by module type
- Generate CSV summary

---

### Phase 3: Actor Framework Validation (Step 6)

**Tool**: Custom test suite + manual review

**Validation Checklist**:

1. **ActorId<T> Type Safety**
   - [ ] Compile-time type checking verified
   - [ ] Cannot send wrong message types
   - [ ] ActorId::clone() behavior tested
   - [ ] ActorId::eq() and hash() tested

2. **ActorShared<T> Clone Behavior**
   - [ ] Clone creates new reference
   - [ ] Underlying actor shared
   - [ ] Thread-safe clone operations

3. **NetActor Trait Implementations**
   - [ ] All NetActor impls tested
   - [ ] Message routing validated
   - [ ] Error propagation verified

4. **Message Callback Patterns**
   - [ ] Callback registration tested
   - [ ] Async callback execution
   - [ ] Callback error handling

5. **Concurrent Message Handling**
   - [ ] Multiple simultaneous senders
   - [ ] Message ordering preserved
   - [ ] No race conditions

**Test Count Targets**:
- ActorId: >= 10 tests
- ActorShared: >= 5 tests
- NetActor: >= 8 tests
- Callbacks: >= 5 tests
- Concurrency: >= 3 tests

---

### Phase 4: Aggregation & Reporting (Steps 7-10)

**Output Files**:

1. **coverage-summary.json** - Machine-readable coverage data
2. **audit-report.md** - Human-readable audit summary
3. **coverage-by-category.md** - Breakdown by module type
4. **untested-critical.md** - List of 0% coverage critical modules
5. **test-roadmap.md** - Prioritized implementation roadmap
6. **recommendations.md** - Testing best practices
7. **tool-config-guide.md** - Coverage tool setup guide

---

## Batch Execution Plan

### Batch 1: Critical - Core Infrastructure (4 modules)
- net
- crypto
- actor
- storage

### Batch 2: Critical - Auth & Security (3 modules)
- auth_manager
- password_manager
- auth

### Batch 3: Critical - Remaining Critical (6 modules)
- secure_storage
- td_db
- dialog_manager
- message_db
- user_manager
- client_actor

### Batch 4-8: Managers (74 modules ÷ 5 = ~15 per batch)
- **Batch 4**: Dialog managers + state managers
- **Batch 5**: Media managers (audio, video, document)
- **Batch 6**: Media managers (sticker, animation, voice) + call managers
- **Batch 7**: Network, connection, update managers
- **Batch 8**: Remaining managers (business, integration, misc)

### Batch 9-10: Type Modules (86 modules ÷ 2 = ~43 per batch)
- **Batch 9**: All *_id types (user_id, chat_id, etc.)
- **Batch 10**: Enums and simple structs

### Batch 11-13: Stub Modules (86 modules ÷ 3 = ~29 per batch)
- Process in alphabetical order
- Quick validation only

### Batch 14: Actor Framework Validation
- Dedicated actor testing
- Message passing validation
- Concurrency tests

### Batch 15: Aggregate Reporting
- Generate all reports
- Create visualizations

### Batch 16: Roadmap & Recommendations
- Prioritize test implementation
- Estimate effort
- Create actionable plan

---

## Deliverables

### Primary Deliverables

1. **crate-inventory.json**
   - Complete crate listing with categorization
   - Dependency graph
   - Test status indicators

2. **coverage-summary.json**
   - Coverage percentage for each crate
   - Aggregate statistics by category
   - List of untested crates

3. **audit-report.md**
   - Executive summary
   - Key findings
   - Risk assessment
   - Recommendations

4. **coverage-by-category.md**
   - Critical modules: 70%+ target
   - Manager modules: 60%+ target
   - Type modules: 50%+ target
   - Stub modules: 20%+ target

5. **untested-critical.md**
   - List of critical modules with 0% coverage
   - Gap analysis for each
   - Prioritized remediation plan

6. **test-roadmap.md**
   - Phased test implementation plan
   - Effort estimates
   - Dependencies
   - Resource requirements

7. **actor-validation-report.md**
   - Actor framework test coverage
   - Message passing validation
   - Concurrency test results
   - Recommendations for actor testing

### Secondary Deliverables

8. **tool-config-guide.md**
   - cargo-llvm-cov setup
   - tarpaulin configuration
   - CI/CD integration
   - Best practices

9. **test-patterns.md**
   - Documented test patterns
   - Examples for each module type
   - Mock actor patterns
   - Property testing guide

10. **recommendations.md**
    - Testing strategy improvements
    - Tool upgrades
    - Process changes
    - Training needs

---

## Success Criteria

### Quantitative Metrics

| Metric | Target | Measurement Method |
|--------|--------|-------------------|
| Crates audited | 398 (100%) | Inventory count |
| Critical modules >= 70% | >= 9 of 13 | Coverage report |
| Manager modules >= 60% | >= 44 of 74 | Coverage report |
| Type modules >= 50% | >= 43 of 86 | Coverage report |
| Actor tests complete | >= 31 tests | Test count |
| Untested critical identified | All 0% modules | Manual review |

### Qualitative Criteria

- ✅ Comprehensive coverage report generated
- ✅ All critical modules categorized
- ✅ Dependency graph created
- ✅ Actionable roadmap delivered
- ✅ Actor framework validated
- ✅ Integration test gaps documented

---

## Tooling Configuration

### cargo-llvm-cov

```toml
# .cargo/config.toml
[llvm-cov]
output-dir = "coverage"
include-ffi = true
```

**Installation**:
```bash
cargo install cargo-llvm-cov
cargo llvm-cov clean --workspace
```

**Usage**:
```bash
# Full workspace
cargo llvm-cov --workspace --html --output-dir coverage

# Specific packages
cargo llvm-cov --package rustgram-net --package rustgram-crypto
```

### tarpaulin (Backup)

```bash
cargo install cargo-tarpaulin
cargo tarpaulin --workspace --out Html --output-dir coverage-tarpaulin
```

### Custom Scripts

**tools/inventory-crates.sh**:
```bash
#!/usr/bin/env bash
set -e
cargo run --bin inventory_generator
```

**tools/aggregate-coverage.py**:
```python
#!/usr/bin/env python3
# Parse coverage reports
# Generate summary
# Create visualizations
```

---

## Risk Mitigation

| Risk | Probability | Impact | Mitigation |
|------|------------|--------|------------|
| Memory issues with workspace | Medium | High | Use package-level batching |
| Tool conflicts | Low | Medium | Test with both llvm-cov and tarpaulin |
| Actor test gaps | High | High | Dedicated validation batch |
| Compilation failures | Low | Medium | Document and skip problematic crates |
| Inconsistent coverage data | Low | Medium | Use both tools for verification |

---

## Timeline Estimate

- **Inventory**: 2 hours
- **Coverage Analysis (Batches 1-13)**: 8 hours
- **Actor Validation**: 2 hours
- **Aggregation & Reporting**: 4 hours
- **Roadmap & Recommendations**: 2 hours

**Total**: ~18 hours (2-3 days)

---

## Dependencies

### Internal
- ✅ Workspace builds successfully
- ✅ Existing tests compile
- ✅ Module structure understood

### External
- ✅ cargo-llvm-cov installed
- ✅ tarpaulin available
- ✅ Python 3.9+ for aggregation scripts

---

## Next Steps

1. ✅ Create inventory script
2. ✅ Validate cargo-llvm-cov with workspace
3. ✅ Execute batch coverage analysis
4. ✅ Generate aggregate reports
5. ✅ Validate actor framework
6. ✅ Create roadmap and recommendations

---

**Spec Version**: 2.0  
**Status**: Ready for Phase 3 Execution  
**Approver**: Agent Analyst (Phase 2)
