title: "UserManager Network Integration (rustgram-client-ff7.4)"
description: "Implement network integration for UserManager following DialogManager pattern"
deadline: "2-3 days"

dependencies:
  completed:
    - "rustgram-client-ff7: Phase 0: Network Layer Integration"
    - "rustgram-client-ff7.1: NetQueryDispatcher in ClientActor"
  external:
    - "rustgram-net: NetQuery, NetQueryDispatcher, NetQueryCallback"
    - "rustgram-types: TlSerialize, TlDeserialize, TlHelper"

modules:
  - name: "cache.rs"
    path: "crates/user_manager/src/cache.rs"
    status: "new"
    description: "TTL-based caching layer for user data"
    lines_estimate: 400

  - name: "network.rs (RealNetworkClient)"
    path: "crates/user_manager/src/network.rs"
    status: "modify"
    description: "Add RealNetworkClient with NetQueryDispatcher integration"
    lines_estimate: "+300"

  - name: "tl.rs (serialization)"
    path: "crates/user_manager/src/tl.rs"
    status: "modify"
    description: "Complete TL serialization for requests/responses"
    lines_estimate: "+200"

  - name: "lib.rs (integration)"
    path: "crates/user_manager/src/lib.rs"
    status: "modify"
    description: "Integrate NetworkClient and cache into UserManager"
    lines_estimate: "+150"

batches:
  - id: 1
    name: "Cache Module"
    duration: "0.5 day"
    parallel_group: 1
    tasks:
      - id: "1.1"
        name: "Create cache.rs module"
        agent: "dev-rust"
        description: "Create UserCache with TTL support following DialogManager pattern"
        acceptance:
          - "UserCache struct with DEFAULT_USER_TTL (300s) and DEFAULT_FULL_USER_TTL (600s)"
          - "get_user(), set_user(), invalidate(), invalidate_all() methods"
          - "CacheStats struct with hit_rate(), total_requests() methods"
          - "Thread-safe with parking_lot::Mutex"
          - "Unit tests for TTL expiration, cache hits/misses"
          - "70%+ test coverage"
        depends_on: []

  - id: 2
    name: "Network Client Implementation"
    duration: "1 day"
    parallel_group: 2
    tasks:
      - id: "2.1"
        name: "Implement RealNetworkClient"
        agent: "dev-rust"
        description: "Add RealNetworkClient to network.rs with NetQueryDispatcher integration"
        acceptance:
          - "RealNetworkClient struct with Arc<NetQueryDispatcher>"
          - "send_typed_query<R, Response>() method with async/await"
          - "send_query() method with oneshot channel callback"
          - "QueryCallback implementation for oneshot bridge"
          - "generate_query_id() function"
          - "Constructor ID constants verified from TDLib"
          - "Error conversion from QueryError to NetworkError"
          - "Unit tests for serialization, timeout, error handling"
          - "70%+ test coverage"
        depends_on: ["1.1"]

  - id: 3
    name: "TL Serialization"
    duration: "0.5 day"
    parallel_group: 2
    tasks:
      - id: "3.1"
        name: "Complete TL types in tl.rs"
        agent: "dev-rust"
        description: "Add TL request/response types for users.getFullUser"
        acceptance:
          - "GetFullUserRequest struct with CONSTRUCTOR_ID"
          - "GetFullUserResponse struct with deserialize_tl()"
          - "TlSerialize implementation for GetFullUserRequest"
          - "Constructor ID verified against telegram_api.tl"
          - "Unit tests for serialization/deserialization"
          - "70%+ test coverage"
        depends_on: []

  - id: 4
    name: "Integration & Testing"
    duration: "1 day"
    parallel_group: 3
    tasks:
      - id: "4.1"
        name: "Integrate NetworkClient into UserManager"
        agent: "dev-rust"
        description: "Add RealNetworkClient integration to UserManager"
        acceptance:
          - "UserManager.set_real_network_client() method"
          - "fetch_user() uses NetworkClient if cache miss"
          - "fetch_full_user() implementation"
          - "Cache integration on successful fetches"
          - "NO unwrap() in production code"
          - "Proper Result/Option handling"
        depends_on: ["2.1", "1.1"]

      - id: "4.2"
        name: "Add update handling infrastructure"
        agent: "dev-rust"
        description: "Add cache invalidation for user updates"
        acceptance:
          - "on_user_update() method to invalidate cache"
          - "update_user() to update cached user data"
          - "Documentation for future UpdateProcessor integration"
        depends_on: ["4.1"]

      - id: "4.3"
        name: "Integration tests"
        agent: "dev-rust"
        description: "Add integration tests with mock NetQueryDispatcher"
        acceptance:
          - "Test fetch_user from network with cache miss"
          - "Test fetch_full_user deserialization"
          - "Test cache hit on subsequent fetches"
          - "Test timeout handling"
          - "Test error propagation"
          - "70%+ overall coverage"
        depends_on: ["4.1", "4.2"]

      - id: "4.4"
        name: "Documentation"
        agent: "docs"
        description: "Add README and update module docs"
        acceptance:
          - "README.md with usage examples"
          - "Module documentation with network integration notes"
          - "Public API doc comments (100% coverage)"
        depends_on: ["4.1", "4.2"]

      - id: "4.5"
        name: "Code review"
        agent: "reviewer"
        description: "Review all changes for consistency with DialogManager pattern"
        acceptance:
          - "Pattern alignment with DialogManager verified"
          - "NO unwrap() in production code verified"
          - "Error handling consistent with project standards"
          - "Test coverage 70%+ verified"
          - "Public API documentation complete"
        depends_on: ["4.1", "4.2", "4.3"]

timeline:
  - phase: "Batch 1"
    duration: "0.5 day"
    deliverables: ["cache.rs module with TTL support"]
  - phase: "Batch 2 & 3 (Parallel)"
    duration: "1 day"
    deliverables: ["RealNetworkClient", "TL serialization types"]
  - phase: "Batch 4"
    duration: "1 day"
    deliverables: ["Integration tests", "Documentation", "Code review"]
  - phase: "Total"
    duration: "2.5 days"
    deliverables: "Complete network integration for UserManager"

risks:
  - id: "R1"
    type: "api_compatibility"
    status: "OPEN"
    mitigation: "Verify all TL constructor IDs against telegram_api.tl reference"
    owner: "dev-rust"

  - id: "R2"
    type: "cache_consistency"
    status: "OPEN"
    mitigation: "Implement clear invalidation hooks for future UpdateProcessor"
    owner: "dev-rust"

  - id: "R3"
    type: "access_hash"
    status: "OPEN"
    mitigation: "Add access_hash: Option<AccessHash> field to User struct"
    owner: "dev-rust"
