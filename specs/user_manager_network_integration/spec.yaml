# UserManager Network Integration - Specification
# Epic: rustgram-client-ff7.4

spec_version: "1.0"
title: "UserManager Network Integration"
description: "Complete network integration for UserManager following DialogManager pattern"

modules:
  cache_rs:
    path: "crates/user_manager/src/cache.rs"
    type: "new"
    description: "TTL-based caching layer for user data"
    
    structs:
      UserCache:
        fields:
          - name: "users"
            type: "HashMap<UserId, CacheEntry<User>>"
            doc: "Basic user cache with TTL"
          - name: "full_users"
            type: "HashMap<UserId, CacheEntry<FullUser>>"
            doc: "Full user profile cache with longer TTL"
          - name: "stats"
            type: "CacheStats"
            doc: "Cache statistics tracking"
        methods:
          - name: "new"
            signature: "pub fn new() -> Self"
            doc: "Create new UserCache with default TTL values"
          - name: "get_user"
            signature: "pub fn get_user(&self, id: UserId) -> Option<&User>"
            doc: "Get basic user from cache, returns None if expired"
          - name: "get_full_user"
            signature: "pub fn get_full_user(&self, id: UserId) -> Option<&FullUser>"
            doc: "Get full user from cache, returns None if expired"
          - name: "set_user"
            signature: "pub fn set_user(&mut self, id: UserId, user: User)"
            doc: "Store user in cache with default TTL"
          - name: "set_full_user"
            signature: "pub fn set_full_user(&mut self, id: UserId, user: FullUser)"
            doc: "Store full user in cache with extended TTL"
          - name: "invalidate_user"
            signature: "pub fn invalidate_user(&mut self, id: UserId)"
            doc: "Remove user from all caches"
          - name: "invalidate_all"
            signature: "pub fn invalidate_all(&mut self)"
            doc: "Clear all cached data"
          - name: "stats"
            signature: "pub fn stats(&self) -> &CacheStats"
            doc: "Get cache statistics"

      CacheEntry:
        generic: "T"
        fields:
          - name: "data"
            type: "T"
            doc: "Cached data"
          - name: "expires_at"
            type: "Instant"
            doc: "Expiration timestamp"
        methods:
          - name: "new"
            signature: "pub fn new(data: T, ttl: Duration) -> Self"
            doc: "Create new cache entry with TTL"
          - name: "is_expired"
            signature: "pub fn is_expired(&self) -> bool"
            doc: "Check if entry has expired"

      CacheStats:
        fields:
          - name: "hits"
            type: "AtomicU64"
            doc: "Cache hit count"
          - name: "misses"
            type: "AtomicU64"
            doc: "Cache miss count"
        methods:
          - name: "new"
            signature: "pub fn new() -> Self"
            doc: "Create new stats tracker"
          - name: "record_hit"
            signature: "pub fn record_hit(&self)"
            doc: "Increment hit counter"
          - name: "record_miss"
            signature: "pub fn record_miss(&self)"
            doc: "Increment miss counter"
          - name: "hit_rate"
            signature: "pub fn hit_rate(&self) -> f64"
            doc: "Calculate cache hit rate"

    constants:
      - name: "DEFAULT_USER_TTL"
        value: "300"
        type: "u64"
        doc: "Default TTL for basic user data (5 minutes)"
      - name: "DEFAULT_FULL_USER_TTL"
        value: "600"
        type: "u64"
        doc: "Default TTL for full user data (10 minutes)"

  network_rs:
    path: "crates/user_manager/src/network.rs"
    type: "modify"
    description: "Add RealNetworkClient with NetQueryDispatcher integration"
    
    structs:
      RealNetworkClient:
        fields:
          - name: "dispatcher"
            type: "Arc<NetQueryDispatcher>"
            doc: "Network query dispatcher for sending requests"
          - name: "timeout"
            type: "Duration"
            doc: "Request timeout"
        methods:
          - name: "new"
            signature: "pub fn new(dispatcher: Arc<NetQueryDispatcher>) -> Self"
            doc: "Create new RealNetworkClient"
          - name: "send_typed_query"
            signature: "pub async fn send_typed_query<R, Response>(&self, request: R) -> Result<Response, NetworkError>"
            doc: "Send typed TL request and deserialize response"
          - name: "send_query"
            signature: "pub async fn send_query(&self, query: NetQuery) -> Result<Vec<u8>, NetworkError>"
            doc: "Send raw NetQuery with oneshot callback"

      QueryCallback:
        implements: "NetQueryCallback"
        fields:
          - name: "tx"
            type: "tokio::sync::oneshot::Sender<Result<Vec<u8>, QueryError>>"
            doc: "Oneshot sender for result"
        methods:
          - name: "new"
            signature: "pub fn new() -> (Self, Receiver)"
            doc: "Create callback channel pair"

    constants:
      - name: "USERS_GET_FULL_USER"
        value: "0xb60f5918"
        type: "u32"
        doc: "TL constructor ID for users.getFullUser"
      - name: "USERS_GET_USERS"
        value: "0xd91a548"
        type: "u32"
        doc: "TL constructor ID for users.getUsers"

  tl_rs:
    path: "crates/user_manager/src/tl.rs"
    type: "modify"
    description: "Complete TL serialization for requests/responses"
    
    structs:
      GetFullUserRequest:
        fields:
          - name: "id"
            type: "InputUser"
            doc: "User to fetch full info for"
        implements:
          - "TlSerialize"
          - "TlDeserialize"
        methods:
          - name: "constructor_id"
            signature: "pub fn constructor_id() -> u32"
            doc: "Return TL constructor ID"

      GetFullUserResponse:
        fields:
          - name: "full_user"
            type: "FullUser"
            doc: "Full user data"
          - name: "chats"
            type: "Vec<Chat>"
            doc: "Related chats"
          - name: "users"
            type: "Vec<User>"
            doc: "Related users"
        methods:
          - name: "deserialize_tl"
            signature: "pub fn deserialize_tl(data: &[u8]) -> Result<Self>"
            doc: "Deserialize from TL bytes"

  lib_rs:
    path: "crates/user_manager/src/lib.rs"
    type: "modify"
    description: "Integrate NetworkClient and cache into UserManager"
    
    modifications:
      - struct: "UserManager"
        add_fields:
          - name: "cache"
            type: "UserCache"
            doc: "User data cache"
          - name: "network"
            type: "Option<RealNetworkClient>"
            doc: "Network client for fetching data"
        add_methods:
          - name: "set_real_network_client"
            signature: "pub fn set_real_network_client(&mut self, client: RealNetworkClient)"
            doc: "Set the real network client"
          - name: "fetch_user"
            signature: "pub async fn fetch_user(&self, id: UserId) -> Result<User, ManagerError>"
            doc: "Fetch user from cache or network"
          - name: "fetch_full_user"
            signature: "pub async fn fetch_full_user(&self, id: UserId) -> Result<FullUser, ManagerError>"
            doc: "Fetch full user from cache or network"
          - name: "on_user_update"
            signature: "pub fn on_user_update(&self, update: &UpdateUser)"
            doc: "Handle user update from server"
          - name: "invalidate_user"
            signature: "pub fn invalidate_user(&self, id: UserId)"
            doc: "Invalidate cached user data"

traits:
  UserNetworkClient:
    description: "Abstract trait for user network operations"
    methods:
      - name: "get_full_user"
        signature: "async fn get_full_user(&self, id: InputUser) -> Result<FullUser, NetworkError>"
        doc: "Fetch full user info from server"

error_types:
  NetworkError:
    variants:
      - name: "QueryError"
        fields: ["QueryError"]
      - name: "Timeout"
        fields: ["Duration"]
      - name: "Serialization"
        fields: ["String"]
      - name: "Deserialization"
        fields: ["String"]
  
  ManagerError:
    variants:
      - name: "Network"
        fields: ["NetworkError"]
      - name: "Cache"
        fields: ["String"]
      - name: "NotFound"
        fields: ["UserId"]
