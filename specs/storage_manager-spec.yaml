# StorageManager Module Specification

## Module Information
module: storage_manager
crate: rustgram-storage (extend existing)
type: Manager
complexity: MEDIUM
tdlib_reference: references/td/td/telegram/StorageManager.h
epic: 21

## Overview
StorageManager extends the existing `rustgram-storage` crate to add file statistics, garbage collection, and storage management capabilities. This module:
- Computes file storage statistics by type and dialog
- Runs garbage collection on unused files
- Manages storage optimization
- Tracks database and log sizes
- Provides fast and detailed storage statistics

**IMPORTANT**: This is an EXTENSION to the existing `rustgram-storage` crate, not a new crate.

## Public API Methods

### Storage Statistics
- **get_storage_stats**
  - TDLib: `get_storage_stats(bool need_all_files, int32 dialog_limit, Promise<FileStats> promise)`
  - Rust: `pub fn get_storage_stats(&self, need_all_files: bool, dialog_limit: i32) -> impl Future<Output = Result<FileStats, Error>>`
  - Description: Get detailed storage statistics with optional file list
  - Dependencies: FileStats (new), DialogId

- **get_storage_stats_fast**
  - TDLib: `get_storage_stats_fast(Promise<FileStatsFast> promise)`
  - Rust: `pub fn get_storage_stats_fast(&self) -> impl Future<Output = Result<FileStatsFast, Error>>`
  - Description: Get fast storage statistics without file scanning
  - Dependencies: FileStatsFast (new)

- **get_database_stats**
  - TDLib: `get_database_stats(Promise<DatabaseStats> promise)`
  - Rust: `pub fn get_database_stats(&self) -> impl Future<Output = Result<DatabaseStats, Error>>`
  - Description: Get database-specific statistics
  - Dependencies: DatabaseStats (new)

### Garbage Collection
- **run_gc**
  - TDLib: `run_gc(FileGcParameters parameters, bool return_deleted_file_statistics, Promise<FileStats> promise)`
  - Rust: `pub fn run_gc(&self, parameters: FileGcParameters, return_deleted_stats: bool) -> impl Future<Output = Result<FileStats, Error>>`
  - Description: Run garbage collection with specified parameters
  - Dependencies: FileGcParameters (new), FileStats (new)

- **update_use_storage_optimizer**
  - TDLib: `update_use_storage_optimizer()`
  - Rust: `pub fn update_use_storage_optimizer(&self)`
  - Description: Update storage optimizer settings from config

### Internal Methods
- **on_new_file**
  - TDLib: `on_new_file(int64 size, int64 real_size, int32 cnt)`
  - Rust: `pub(crate) fn on_new_file(&self, size: i64, real_size: i64, cnt: i32)`
  - Description: Track new file creation for fast stats

## Required Types

### Existing Types (in rustgram-storage)
- **StorageError** - Already exists in rustgram-storage
- **StorageResult** - Already exists in rustgram-storage
- **DbConnection** - Already exists in rustgram-storage

### New Types (Add to rustgram-storage)

#### Core Statistics Types
- **FileTypeStat** - File statistics by type
  ```rust
  #[derive(Debug, Clone, PartialEq, Eq)]
  pub struct FileTypeStat {
      /// Total size in bytes
      pub size: i64,
      /// Number of files
      pub count: i32,
  }
  
  impl FileTypeStat {
      pub const fn new() -> Self { Self { size: 0, count: 0 } }
      pub fn add(&mut self, size: i64, count: i32);
      pub fn is_empty(&self) -> bool;
  }
  ```
  - Source: TDLib FileTypeStat
  - Serializable: Yes (for storage)

- **FileStatsFast** - Fast storage statistics
  ```rust
  #[derive(Debug, Clone, PartialEq, Eq)]
  pub struct FileStatsFast {
      /// Total file size in bytes
      pub size: i64,
      /// Total file count
      pub count: i32,
      /// Database size in bytes
      pub database_size: i64,
      /// Language pack database size in bytes
      pub language_pack_database_size: i64,
      /// Log file size in bytes
      pub log_size: i64,
  }
  
  impl FileStatsFast {
      pub fn new(
          size: i64,
          count: i32,
          database_size: i64,
          language_pack_database_size: i64,
          pub log_size: i64,
      ) -> Self;
  }
  ```
  - Source: TDLib FileStatsFast
  - Constructor: Direct struct initialization

- **FileStats** - Detailed storage statistics
  ```rust
  #[derive(Debug, Clone)]
  pub struct FileStats {
      /// Statistics by file type
      pub by_type: [FileTypeStat; MAX_FILE_TYPE],
      /// Statistics by owner dialog
      pub by_dialog: HashMap<DialogId, [FileTypeStat; MAX_FILE_TYPE]>,
      /// All files (if need_all_files was true)
      pub all_files: Vec<FileInfo>,
  }
  
  impl FileStats {
      pub fn new(need_all_files: bool, split_by_dialog: bool) -> Self;
      pub fn apply_dialog_limit(&mut self, limit: i32);
      pub fn get_total_size(&self) -> i64;
      pub fn get_total_count(&self) -> i32;
  }
  ```
  - Source: TDLib FileStats
  - Complex type with optional file list

- **FileInfo** - Individual file information
  ```rust
  #[derive(Debug, Clone)]
  pub struct FileInfo {
      /// File type
      pub file_type: FileType,
      /// File path
      pub path: PathBuf,
      /// Owner dialog ID
      pub owner_dialog_id: Option<DialogId>,
      /// File size in bytes
      pub size: i64,
      /// Last access time (nanoseconds)
      pub atime_nsec: u64,
      /// Last modification time (nanoseconds)
      pub mtime_nsec: u64,
  }
  ```
  - Source: TDLib FullFileInfo
  - Requires FileType enum

- **FileType** - File type enumeration
  ```rust
  #[derive(Debug, Clone, Copy, PartialEq, Eq, Hash)]
  #[repr(i32)]
  pub enum FileType {
      Unknown = 0,
      Thumbnail = 1,
      ProfilePhoto = 2,
      Photo = 3,
      Voice = 4,
      Video = 5,
      Document = 6,
      Encrypted = 7,
      Temp = 8,
      Sticker = 9,
      Audio = 10,
      Animation = 11,
      EncryptedThumbnail = 12,
      Wallpaper = 13,
      VideoNote = 14,
      SecureRaw = 15,
      Secure = 16,
      Background = 17,
      DocumentAsFile = 18,
      Size = 19,  // MAX_FILE_TYPE
  }
  
  impl FileType {
      pub fn from_i32(value: i32) -> Option<Self>;
      pub fn to_i32(self) -> i32;
      pub fn is_temp(self) -> bool;
  }
  ```
  - Source: TDLib FileType
  - MAX_FILE_TYPE constant: 19

#### Garbage Collection Types
- **FileGcParameters** - Garbage collection parameters
  ```rust
  #[derive(Debug, Clone, PartialEq, Eq)]
  pub struct FileGcParameters {
      /// Dialog IDs to keep files for (None = all dialogs)
      pub dialog_ids: Option<Vec<DialogId>>,
      /// Exclude dialog IDs from GC
      pub exclude_dialog_ids: Vec<DialogId>,
      /// Keep files from these dialogs even if they are in exclude_dialog_ids
      pub keep_dialog_ids: Vec<DialogId>,
      /// File types to GC
      pub file_types: Option<Vec<FileType>>,
      /// Keep files newer than this time (Unix timestamp)
      pub keep_files_newer_than: Option<i64>,
      /// Keep files older than this time (Unix timestamp)
      pub keep_files_older_than: Option<i64>,
      /// Keep all dialogs' files created before this time
      pub keep_all_dialog_files_created_before: Option<i64>,
      /// Keep files from these specific dialogs even if they match other criteria
      pub keep_files_from_dialogs: Vec<DialogId>,
      /// Return deleted file statistics
      pub return_deleted_file_statistics: bool,
      /// Maximum delay before GC starts
      pub max_delay: i32,
  }
  
  impl FileGcParameters {
      pub fn new() -> Self;
      pub fn with_dialog_ids(mut self, dialog_ids: Vec<DialogId>) -> Self;
      pub fn with_file_types(mut self, file_types: Vec<FileType>) -> Self;
  }
  ```
  - Source: TDLib FileGcParameters
  - Complex filtering logic

#### Database Statistics
- **DatabaseStats** - Database statistics
  ```rust
  #[derive(Debug, Clone)]
  pub struct DatabaseStats {
      /// Debug information string
      pub debug: String,
  }
  
  impl DatabaseStats {
      pub fn new(debug: String) -> Self;
      pub fn get_database_statistics_object(&self) -> DatabaseStatisticsObject;
  }
  ```
  - Source: TDLib DatabaseStats
  - Placeholder for TDLib's complex database stats

- **DatabaseStatisticsObject** - TDLib API object
  ```rust
  #[derive(Debug, Clone)]
  pub struct DatabaseStatisticsObject {
      pub tables: Vec<TableStatistics>,
  }
  
  #[derive(Debug, Clone)]
  pub struct TableStatistics {
      pub name: String,
      pub row_count: i32,
      pub size: i64,
  }
  ```

## Dependencies

### External Crates (Add to rustgram-storage/Cargo.toml)
```toml
[dependencies]
# Existing
rustgram_types = { path = "../types" }
rusqlite = { version = "0.32", features = ["bundled"] }
tokio = { version = "1.35", features = ["sync", "rt", "macros", "fs"] }
thiserror = "1.0"
tracing = "0.1"
async-trait = "0.1"
futures = "0.3"
bytes = "1.5"

# New additions
serde = { version = "1.0", features = ["derive"], optional = true }
tokio-stream = { version = "0.1", optional = true }

[features]
default = ["dialog"]
dialog = []
secure = ["dep:aes", "dep:cbc", "dep:pbkdf2", "dep:sha2", "dep:rand", "dep:getrandom"]
full = ["dialog", "secure"]
storage_manager = ["dep:serde", "dep:tokio-stream"]
```

### Internal Dependencies
- **DialogId** - `rustgram-dialog-id` (for per-dialog stats)
- **FileType** - New enum in rustgram-storage
- **PathBuf** - std::path::PathBuf (for file paths)
- **SystemTime** - std::time::SystemTime (for timestamps)

## Error Types

### StorageManagerError (Add to rustgram-storage/error.rs)
```rust
#[derive(Debug, thiserror::Error)]
pub enum StorageManagerError {
    /// Failed to scan files
    #[error("Failed to scan files: {0}")]
    ScanFailed(String),
    
    /// Failed to run garbage collection
    #[error("Garbage collection failed: {0}")]
    GcFailed(String),
    
    /// Invalid file type
    #[error("Invalid file type: {0}")]
    InvalidFileType(i32),
    
    /// File not found
    #[error("File not found: {0}")]
    FileNotFound(PathBuf),
    
    /// Dialog ID not found
    #[error("Dialog ID not found: {0}")]
    DialogNotFound(i64),
    
    /// IO error
    #[error("IO error: {0}")]
    Io(#[from] std::io::Error),
    
    /// Storage error (existing)
    #[error("Storage error: {0}")]
    Storage(#[from] StorageError),
}
```

## TDLib Alignment Notes

### File Statistics Architecture
TDLib's FileStats uses:
1. **StatByType**: Array of 20 FileTypeStat (one per FileType)
2. **Dialog splitting**: Optional HashMap of DialogId -> StatByType
3. **Full file list**: Optional Vec<FullFileInfo> with metadata

### Garbage Collection Strategy
1. **Worker Pattern**: FileStatsWorker runs on separate scheduler
2. **Cancellation**: CancellationToken for aborting long operations
3. **Background GC**: Automatic GC every 24 hours (GC_EACH = 86400s)
4. **Random Delay**: Random delay 0-15 minutes to avoid simultaneous GC

### Constants from TDLib
```rust
const GC_EACH: i32 = 60 * 60 * 24;  // 1 day
const GC_DELAY: i32 = 60;  // 1 minute
const GC_RAND_DELAY: i32 = 60 * 15;  // 15 minutes
```

### Fast Statistics Caching
- **FileTypeStat fast_stat_**: Cached fast stats
- **Update on new file**: on_new_file() updates cache immediately
- **Save/load persistence**: Cache saved to database
- **Database size queries**: Separate queries for DB, language pack, log

### File Scanning Strategy
1. **Recursive directory scan**: Walk through blob directory
2. **Metadata extraction**: Get size, atime, mtime for each file
3. **Dialog ID extraction**: Parse owner dialog ID from file path
4. **File type detection**: Use file path patterns
5. **Batch processing**: Process files in batches to avoid memory issues

### Storage Optimization
- **Automatic cleanup**: Remove temp files older than threshold
- **Dialog-based cleanup**: Remove files from deleted dialogs
- **Size-based cleanup**: Remove oldest files if size exceeds limit
- **Keep rules**: Complex logic for what to keep

## Testing Requirements
- **Unit Tests**: Test statistics calculation, GC logic
- **Integration Tests**: Test with real file system
- **Temp Directory Tests**: Use tempfile crate for isolated tests
- **GC Logic Tests**: Test various GC parameter combinations
- **Performance Tests**: Test with large file counts
- **Thread Safety Tests**: Concurrent GC requests
- **Target Test Count**: 40-50 tests

## Implementation Plan

### Phase 1: Core Types (300 LOC, 20 tests)
1. Add FileType enum to rustgram-storage
2. Add FileTypeStat struct
3. Add FileStatsFast struct
4. Add FileInfo struct
5. Unit tests for all types

### Phase 2: FileStats Type (400 LOC, 20 tests)
6. Add FileStats struct
7. Add DatabaseStats stub
8. Add FileGcParameters stub
9. Add StorageManagerError
10. Unit tests for complex types

### Phase 3: Storage Statistics (500 LOC, 25 tests)
11. Implement get_storage_stats_fast
12. Implement get_storage_stats (without file scanning)
13. Implement get_database_stats
14. Add fast stats caching
15. Integration tests

### Phase 4: File Scanning (600 LOC, 20 tests)
16. Implement file system walker
17. Add metadata extraction
18. Implement dialog ID extraction from paths
19. Implement file type detection
20. Integration tests with temp directories

### Phase 5: Garbage Collection (600 LOC, 25 tests)
21. Implement FileGcParameters fully
22. Implement run_gc logic
23. Add GC worker task
24. Implement GC scheduling
25. Integration tests

### Phase 6: Optimization & Integration (300 LOC, 15 tests)
26. Add automatic GC scheduling
27. Implement storage optimizer
28. Add performance monitoring
29. Full integration tests
30. Documentation

## New Module Structure

```
crates/storage/
  Cargo.toml (update)
  src/
    lib.rs (existing, add re-exports)
    error.rs (existing, add StorageManagerError)
    connection.rs (existing)
    migrations.rs (existing)
    dialog.rs (existing)
    secure.rs (existing)
    
    # New modules for storage-manager feature
    stats.rs (new) - FileType, FileTypeStat, FileStatsFast
    file_stats.rs (new) - FileStats, FileInfo
    gc.rs (new) - FileGcParameters, GC logic
    database_stats.rs (new) - DatabaseStats
    manager.rs (new) - StorageManager public API
    worker.rs (new) - FileStatsWorker task
```

## Estimated Metrics
- **New LOC**: 1500-2000 (MEDIUM complexity, extends existing crate)
- **Tests**: 40-50
- **Complexity**: MEDIUM (file system operations, GC logic)
- **Dependencies**: 2-3 new dependencies
- **New Types**: 8 types
- **Implementation Phases**: 6 phases
- **Feature Flag**: storage_manager (disabled by default)

## Special Considerations

### File System Performance
- **Large directories**: Can have 10000+ files
- **I/O bottleneck**: File system is slow, need async operations
- **Memory usage**: Don't load all file paths into memory at once

### Cross-Platform Compatibility
- **Path handling**: Different path separators on Windows/Linux/Mac
- **File metadata**: Different metadata availability
- **Permissions**: May not have permission to scan all files

### Error Handling
- **Partial failures**: Some files may not be readable
- **Concurrent modifications**: Files may be deleted during scan
- **Disk full**: May not be able to delete files during GC

### Storage Estimation
- **Size estimation**: Use file size metadata when available
- **Database size**: Query SQLite for database size
- **Log rotation**: Handle log file rotation correctly

### Testing Strategy
- **Temp directory**: Use tempfile crate for isolated tests
- **Mock file system**: For unit tests without real I/O
- **Stress tests**: Test with 10000+ files
- **Concurrent GC**: Test multiple simultaneous GC requests

## Backward Compatibility
- **Feature flag**: New functionality behind "storage_manager" feature
- **Existing API**: No changes to existing rustgram-storage API
- **Opt-in**: Users must enable feature to use new functionality
- **Version bump**: Minor version bump (0.1.x -> 0.2.0)

## Integration with Existing Storage
- **Reuse connections**: Use existing DbConnection infrastructure
- **Reuse error types**: Extend existing StorageError enum
- **Reuse logging**: Use existing tracing infrastructure
- **Reuse config**: Integrate with existing configuration system

## Future Enhancements (Out of Scope)
- **Cloud storage**: Support for cloud-based file storage
- **Compression**: Automatic compression of old files
- **Deduplication**: Remove duplicate files
- **Migration**: Support for migrating files between storage backends
