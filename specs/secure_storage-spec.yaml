# Specification: SecureStorage
module: secure_storage
crate: rustgram-secure-storage
tdlib_reference: references/td/td/telegram/SecureStorage.h
complexity: HIGH
module_type: Manager Type (Crypto)
estimated_loc: 1500-2500
estimated_tests: 60-80

types:
  - name: Secret
    description: |
      32-byte secret with checksum validation.
      
      The sum of all bytes modulo 255 must equal 239.
      Used as the master secret for encryption.
    fields:
      - name: secret
        type: UInt256
        description: 32-byte secret value
        optional: false
      - name: hash
        type: i64
        description: Hash of the secret
        optional: false

  - name: EncryptedSecret
    description: |
      Encrypted version of a Secret.
      
      Can be decrypted with a key and salt using
      the specified encryption algorithm.
    fields:
      - name: encrypted_secret
        type: UInt256
        description: Encrypted 32-byte value
        optional: false

  - name: Password
    description: |
      User password for encryption.
      
      Wraps a String password for use in key derivation.
    fields:
      - name: password
        type: String
        description: The password string
        optional: false

  - name: ValueHash
    description: |
      SHA-256 hash of a value.
      
      Used to verify encrypted data integrity.
    fields:
      - name: hash
        type: UInt256
        description: 32-byte hash value
        optional: false

  - name: EncryptedValue
    description: |
      Encrypted data with its hash.
      
      Contains both the encrypted data and its hash
      for verification after decryption.
    fields:
      - name: data
        type: BufferSlice
        description: Encrypted data
        optional: false
      - name: hash
        type: ValueHash
        description: Hash for verification
        optional: false

  - name: Decryptor
    description: |
      Streaming decryptor for encrypted values.
      
      Supports incremental decryption of large values.
    fields:
      - name: aes_cbc_state
        type: AesCbcState
        description: AES-CBC encryption state
        optional: false
      - name: sha256_state
        type: Sha256State
        description: SHA-256 hash state
        optional: false
      - name: skipped_prefix
        type: bool
        description: Whether random prefix was skipped
        optional: false
      - name: to_skip
        type: usize
        description: Bytes to skip
        optional: false

  - name: Encryptor
    description: |
      Streaming encryptor implementing DataView.
      
      Provides read access to encrypted data.
    fields:
      - name: aes_cbc_state
        type: AesCbcState
        description: AES-CBC encryption state (mutable)
        optional: false
      - name: current_offset
        type: i64
        description: Current read offset
        optional: false
      - name: data_view
        type: DataView
        description: Source data view
        optional: false

  - name: DataView
    description: |
      Trait for readable data views.
      
      Allows incremental reading of data by offset and size.
    methods:
      - name: size
        description: Returns total size
        returns: i64
      - name: pread
        description: Read data at offset
        parameters:
          - name: offset
            type: i64
          - name: size
            type: i64
        returns: Result<BufferSlice>

  - name: BufferSliceDataView
    description: DataView backed by BufferSlice
    implements: DataView

  - name: ConcatDataView
    description: DataView concatenating two views
    implements: DataView

  - name: EncryptionAlgorithm
    description: Encryption algorithm for secret
    variants:
      - Sha512
      - Pbkdf2

external_dependencies:
  - type: UInt256
    crate: rustgram-types
    verified: false # May need to add this type
  - type: BufferSlice
    crate: rustgram-buffer
    verified: false # STUB NEEDED
  - type: AesCbcState
    crate: rustgram-crypto
    verified: false # STUB NEEDED
  - type: Sha256State
    crate: rustgram-crypto
    verified: false # STUB NEEDED

constructors (Secret):
  - name: create
    description: Creates Secret from bytes, validating checksum
    parameters:
      - name: secret
        type: Slice
    returns: Result<Secret>
  - name: create_new
    description: Generates new random Secret
    returns: Secret

constructors (Password):
  - name: new
    description: Creates Password from string
    parameters:
      - name: password
        type: String
    returns: Password

methods (Secret):
  - name: as_slice
    description: Returns secret as bytes
    returns: Slice
  - name: encrypt
    description: Encrypts the secret
    parameters:
      - name: key
        type: Slice
      - name: salt
        type: Slice
      - name: algorithm
        type: EncryptionAlgorithm
    returns: EncryptedSecret
  - name: get_hash
    description: Returns secret hash
    returns: i64
  - name: clone
    description: Clones the secret
    returns: Secret
  - name: size
    description: Returns size (always 32)
    returns: usize (const)

methods (EncryptedSecret):
  - name: create
    description: Creates from encrypted bytes
    parameters:
      - name: encrypted_secret
        type: Slice
    returns: Result<EncryptedSecret>
  - name: decrypt
    description: Decrypts to Secret
    parameters:
      - name: key
        type: Slice
      - name: salt
        type: Slice
      - name: algorithm
        type: EncryptionAlgorithm
    returns: Result<Secret>
  - name: as_slice
    description: Returns encrypted bytes
    returns: Slice

methods (Password):
  - name: as_slice
    description: Returns password as string slice
    returns: Slice

methods (ValueHash):
  - name: create
    description: Creates hash from data
    parameters:
      - name: data
        type: Slice
    returns: Result<ValueHash>
  - name: as_slice
    description: Returns hash as bytes
    returns: Slice

methods (Decryptor):
  - name: new
    description: Creates decryptor with AES state
    parameters:
      - name: aes_cbc_state
        type: AesCbcState
    returns: Decryptor
  - name: append
    description: Appends encrypted data
    parameters:
      - name: data
        type: BufferSlice
    returns: Result<BufferSlice>
  - name: finish
    description: Finalizes decryption and verifies hash
    returns: Result<ValueHash>

functions (free):
  - name: calc_aes_cbc_state_pbkdf2
    description: Derives AES state from secret using PBKDF2
    parameters:
      - name: secret
        type: Slice
      - name: salt
        type: Slice
    returns: AesCbcState
  - name: calc_aes_cbc_state_sha512
    description: Derives AES state from seed using SHA512
    parameters:
      - name: seed
        type: Slice
    returns: AesCbcState
  - name: calc_value_hash
    description: Calculates hash from data view
    parameters:
      - name: data_view
        type: &DataView
    returns: Result<ValueHash>
  - name: gen_random_prefix
    description: Generates random prefix for encryption
    parameters:
      - name: data_size
        type: i64
    returns: BufferSlice
  - name: encrypt_value
    description: Encrypts data with secret
    parameters:
      - name: secret
        type: &Secret
      - name: data
        type: Slice
    returns: Result<EncryptedValue>
  - name: decrypt_value
    description: Decrypts data with secret and verifies hash
    parameters:
      - name: secret
        type: &Secret
      - name: hash
        type: &ValueHash
      - name: data
        type: Slice
    returns: Result<BufferSlice>
  - name: encrypt_file
    description: Encrypts file
    parameters:
      - name: secret
        type: &Secret
      - name: src
        type: &String
      - name: dest
        type: &String
    returns: Result<ValueHash>
  - name: decrypt_file
    description: Decrypts file
    parameters:
      - name: secret
        type: &Secret
      - name: hash
        type: &ValueHash
      - name: src
        type: &String
      - name: dest
        type: &String
    returns: Status

traits:
  - Debug (where applicable)
  - Clone (Secret, Password, EncryptedSecret)
  - PartialEq (ValueHash)

test_plan:
  unit_tests: 60
  doc_tests: 10

notes: |
  This is a complex cryptographic module.
  Key challenges:
  1. Secret validation (sum % 255 == 239)
  2. AES-CBC encryption/decryption
  3. SHA-256 hashing
  4. Key derivation (PBKDF2, SHA512)
  5. Streaming encryption/decryption
  6. DataView trait for lazy loading
  
  For the Rust implementation:
  1. Use existing crypto crates (aes, sha2, pbkdf2)
  2. Create stubs for BufferSlice, AesCbcState, Sha256State
  3. Implement DataView trait for streaming
  4. Focus on API correctness over crypto implementation
  
  The checksum validation is critical: sum of bytes % 255 == 239.
  
  DataView is an important abstraction - it allows lazy loading
  of encrypted data without decrypting everything at once.
