spec:
  module: message_query_manager
  version: 0.1.0
  created: 2026-01-14T10:00:00Z
  updated: 2026-01-14T10:00:00Z
  language: rust
  complexity: high
  estimated_loc: 2000
  is_state_machine: true

plan:
  - item: Comprehend and Analyze TDLib Implementation
  - item: Implement Core Types and State Machines
  - item: Implement Upload Cover State Machine
  - item: Implement Reload Operations (Extended Media, Fact Checks, Views, Reactions)
  - item: Implement Search Operations
  - item: Implement Delete/Read/Unpin Operations
  - item: Implement Binlog Event Handlers
  - item: Write Comprehensive Tests and Documentation
  - item: Review and Verify Module Compliance

success_criteria:
  code_quality:
    max_clippy_warnings: 0
    production_unwrap_calls: 0
    max_cyclomatic_complexity: 15
  
  test_coverage:
    min_tests: 70
    min_line_coverage: 80
  
  documentation:
    public_api_docs_percent: 100
    examples_required: true
  
  tdlib_alignment:
    api_compatibility: strict

# ============================================================================
# API INVENTORY - All 63+ Public Methods
# ============================================================================

api_methods:

  # === Affected History Operations ===
  - method: run_affected_history_query_until_complete
    signature: "run_affected_history_query_until_complete(dialog_id: DialogId, query: AffectedHistoryQuery, get_affected_messages: bool, promise: Promise<Unit>)"
    category: affected_history
    async: true
    return_type: Result<(), Error>
    tdlib_name: run_affected_history_query_until_complete
    tdlib_line: 51-52

  # === Upload Cover Operations ===
  - method: upload_message_covers
    signature: "upload_message_covers(business_connection_id: BusinessConnectionId, dialog_id: DialogId, covers: Vec<Photo>, promise: Promise<Unit>)"
    category: upload
    async: true
    return_type: Result<(), Error>
    tdlib_name: upload_message_covers
    tdlib_line: 54-55

  - method: upload_message_cover
    signature: "upload_message_cover(business_connection_id: BusinessConnectionId, dialog_id: DialogId, photo: Photo, file_upload_id: FileUploadId, promise: Promise<Unit>, bad_parts: Vec<i32>)"
    category: upload
    async: true
    return_type: Result<(), Error>
    tdlib_name: upload_message_cover
    tdlib_line: 57-58

  - method: complete_upload_message_cover
    signature: "complete_upload_message_cover(business_connection_id: BusinessConnectionId, dialog_id: DialogId, photo: Photo, file_upload_id: FileUploadId, media_ptr: MessageMedia, promise: Promise<Unit>)"
    category: upload
    async: true
    return_type: Result<(), Error>
    tdlib_name: complete_upload_message_cover
    tdlib_line: 60-63

  # === Delivery and Bot Operations ===
  - method: report_message_delivery
    signature: "report_message_delivery(message_full_id: MessageFullId, until_date: i32, from_push: bool)"
    category: delivery
    async: false
    return_type: ()
    tdlib_name: report_message_delivery
    tdlib_line: 65

  - method: send_bot_requested_peer
    signature: "send_bot_requested_peer(message_full_id: MessageFullId, button_id: i32, shared_dialog_ids: Vec<DialogId>, promise: Promise<Unit>)"
    category: bot
    async: true
    return_type: Result<(), Error>
    tdlib_name: send_bot_requested_peer
    tdlib_line: 67-68

  # === Extended Media Reload ===
  - method: reload_message_extended_media
    signature: "reload_message_extended_media(dialog_id: DialogId, message_ids: Vec<MessageId>)"
    category: reload_extended_media
    async: true
    return_type: ()
    tdlib_name: reload_message_extended_media
    tdlib_line: 70

  - method: finish_get_message_extended_media
    signature: "finish_get_message_extended_media(dialog_id: DialogId, message_ids: &Vec<MessageId>)"
    category: reload_extended_media
    async: false
    return_type: ()
    tdlib_name: finish_get_message_extended_media
    tdlib_line: 72

  # === Fact Check Operations ===
  - method: reload_message_fact_checks
    signature: "reload_message_fact_checks(dialog_id: DialogId, message_ids: Vec<MessageId>)"
    category: fact_check
    async: true
    return_type: ()
    tdlib_name: reload_message_fact_checks
    tdlib_line: 74

  - method: set_message_fact_check
    signature: "set_message_fact_check(message_full_id: MessageFullId, fact_check_text: &FormattedText, promise: Promise<Unit>)"
    category: fact_check
    async: true
    return_type: Result<(), Error>
    tdlib_name: set_message_fact_check
    tdlib_line: 76-77

  # === Post Approval ===
  - method: toggle_suggested_post_approval
    signature: "toggle_suggested_post_approval(message_full_id: MessageFullId, is_rejected: bool, schedule_date: i32, comment: &str, promise: Promise<Unit>)"
    category: moderation
    async: true
    return_type: Result<(), Error>
    tdlib_name: toggle_suggested_post_approval
    tdlib_line: 79-80

  # === Search Operations ===
  - method: search_messages
    signature: "search_messages(dialog_list_id: DialogListId, ignore_folder_id: bool, query: &str, offset_str: &str, limit: i32, filter: MessageSearchFilter, dialog_type_filter: SearchMessagesChatTypeFilter, min_date: i32, max_date: i32, promise: Promise<FoundMessages>)"
    category: search
    async: true
    return_type: Result<FoundMessages, Error>
    tdlib_name: search_messages
    tdlib_line: 82-85

  - method: on_get_messages_search_result
    signature: "on_get_messages_search_result(query: &str, offset_date: i32, offset_dialog_id: DialogId, offset_message_id: MessageId, limit: i32, filter: MessageSearchFilter, min_date: i32, max_date: i32, total_count: i32, messages: Vec<Message>, next_rate: i32, promise: Promise<FoundMessages>)"
    category: search
    async: false
    return_type: Result<FoundMessages, Error>
    tdlib_name: on_get_messages_search_result
    tdlib_line: 87-91

  - method: search_outgoing_document_messages
    signature: "search_outgoing_document_messages(query: &str, limit: i32, promise: Promise<FoundMessages>)"
    category: search
    async: true
    return_type: Result<FoundMessages, Error>
    tdlib_name: search_outgoing_document_messages
    tdlib_line: 93-94

  - method: on_get_outgoing_document_messages
    signature: "on_get_outgoing_document_messages(messages: Vec<Message>, promise: Promise<FoundMessages>)"
    category: search
    async: false
    return_type: Result<FoundMessages, Error>
    tdlib_name: on_get_outgoing_document_messages
    tdlib_line: 96-97

  - method: check_search_posts_flood
    signature: "check_search_posts_flood(query: &str, promise: Promise<PublicPostSearchLimits>)"
    category: search
    async: true
    return_type: Result<PublicPostSearchLimits, Error>
    tdlib_name: check_search_posts_flood
    tdlib_line: 99-100

  - method: search_public_posts
    signature: "search_public_posts(query: &str, offset_str: &str, limit: i32, star_count: i64, promise: Promise<FoundPublicPosts>)"
    category: search
    async: true
    return_type: Result<FoundPublicPosts, Error>
    tdlib_name: search_public_posts
    tdlib_line: 102-103

  - method: on_get_public_post_search_result
    signature: "on_get_public_post_search_result(hashtag: &str, old_offset: &MessageSearchOffset, limit: i32, star_count: i64, flood: SearchPostsFlood, messages: Vec<Message>, next_rate: i32, promise: Promise<FoundPublicPosts>)"
    category: search
    async: false
    return_type: Result<FoundPublicPosts, Error>
    tdlib_name: on_get_public_post_search_result
    tdlib_line: 105-110

  - method: search_hashtag_posts
    signature: "search_hashtag_posts(hashtag: String, offset_str: String, limit: i32, promise: Promise<FoundMessages>)"
    category: search
    async: true
    return_type: Result<FoundMessages, Error>
    tdlib_name: search_hashtag_posts
    tdlib_line: 112-113

  - method: on_get_hashtag_search_result
    signature: "on_get_hashtag_search_result(hashtag: &str, old_offset: &MessageSearchOffset, limit: i32, total_count: i32, messages: Vec<Message>, next_rate: i32, promise: Promise<FoundMessages>)"
    category: search
    async: false
    return_type: Result<FoundMessages, Error>
    tdlib_name: on_get_hashtag_search_result
    tdlib_line: 115-118

  - method: search_dialog_recent_location_messages
    signature: "search_dialog_recent_location_messages(dialog_id: DialogId, limit: i32, promise: Promise<Messages>)"
    category: search
    async: true
    return_type: Result<Messages, Error>
    tdlib_name: search_dialog_recent_location_messages
    tdlib_line: 120-121

  - method: on_get_recent_locations
    signature: "on_get_recent_locations(dialog_id: DialogId, limit: i32, total_count: i32, messages: Vec<Message>, promise: Promise<Messages>)"
    category: search
    async: false
    return_type: Result<Messages, Error>
    tdlib_name: on_get_recent_locations
    tdlib_line: 123-125

  # === Position and Viewers ===
  - method: get_dialog_message_position_from_server
    signature: "get_dialog_message_position_from_server(dialog_id: DialogId, message_topic: MessageTopic, filter: MessageSearchFilter, message_id: MessageId, promise: Promise<i32>)"
    category: query
    async: true
    return_type: Result<i32, Error>
    tdlib_name: get_dialog_message_position_from_server
    tdlib_line: 127-129

  - method: get_message_read_date_from_server
    signature: "get_message_read_date_from_server(message_full_id: MessageFullId, promise: Promise<MessageReadDate>)"
    category: query
    async: true
    return_type: Result<MessageReadDate, Error>
    tdlib_name: get_message_read_date_from_server
    tdlib_line: 131-132

  - method: get_message_viewers
    signature: "get_message_viewers(message_full_id: MessageFullId, promise: Promise<MessageViewers>)"
    category: query
    async: true
    return_type: Result<MessageViewers, Error>
    tdlib_name: get_message_viewers
    tdlib_line: 134-135

  # === View Operations ===
  - method: view_messages
    signature: "view_messages(dialog_id: DialogId, message_ids: &Vec<MessageId>, increment_view_counter: bool)"
    category: views
    async: false
    return_type: ()
    tdlib_name: view_messages
    tdlib_line: 137

  - method: finish_get_message_views
    signature: "finish_get_message_views(dialog_id: DialogId, message_ids: &Vec<MessageId>)"
    category: views
    async: false
    return_type: ()
    tdlib_name: finish_get_message_views
    tdlib_line: 139

  # === Reactions Reload ===
  - method: queue_message_reactions_reload
    signature: "queue_message_reactions_reload(message_full_id: MessageFullId)"
    category: reactions
    async: false
    return_type: ()
    tdlib_overload: true
    tdlib_name: queue_message_reactions_reload
    tdlib_line: 141

  - method: queue_message_reactions_reload_batch
    signature: "queue_message_reactions_reload_batch(dialog_id: DialogId, message_ids: Vec<MessageId>)"
    category: reactions
    async: false
    return_type: ()
    tdlib_name: queue_message_reactions_reload
    tdlib_line: 143

  - method: try_reload_message_reactions
    signature: "try_reload_message_reactions(dialog_id: DialogId, is_finished: bool)"
    category: reactions
    async: true
    return_type: ()
    tdlib_name: try_reload_message_reactions
    tdlib_line: 145

  - method: has_message_pending_read_reactions
    signature: "has_message_pending_read_reactions(message_full_id: MessageFullId) -> bool"
    category: reactions
    async: false
    return_type: bool
    const: true
    tdlib_name: has_message_pending_read_reactions
    tdlib_line: 147

  # === Paid Reactions ===
  - method: get_paid_message_reaction_senders
    signature: "get_paid_message_reaction_senders(dialog_id: DialogId, promise: Promise<MessageSenders>)"
    category: reactions
    async: true
    return_type: Result<MessageSenders, Error>
    tdlib_name: get_paid_message_reaction_senders
    tdlib_line: 149-150

  # === To-Do List Operations ===
  - method: add_to_do_list_tasks
    signature: "add_to_do_list_tasks(message_full_id: MessageFullId, tasks: Vec<InputChecklistTask>, promise: Promise<Unit>)"
    category: todo
    async: true
    return_type: Result<(), Error>
    tdlib_name: add_to_do_list_tasks
    tdlib_line: 152-153

  - method: mark_to_do_list_tasks_as_done
    signature: "mark_to_do_list_tasks_as_done(message_full_id: MessageFullId, done_task_ids: Vec<i32>, not_done_task_ids: Vec<i32>, promise: Promise<Unit>)"
    category: todo
    async: true
    return_type: Result<(), Error>
    tdlib_name: mark_to_do_list_tasks_as_done
    tdlib_line: 155-156

  # === Discussion Messages ===
  - method: get_discussion_message
    signature: "get_discussion_message(dialog_id: DialogId, message_id: MessageId, expected_dialog_id: DialogId, expected_message_id: MessageId, promise: Promise<MessageThreadInfo>)"
    category: discussion
    async: true
    return_type: Result<MessageThreadInfo, Error>
    tdlib_name: get_discussion_message
    tdlib_line: 158-159

  - method: process_discussion_message
    signature: "process_discussion_message(result: MessagesDiscussionMessage, dialog_id: DialogId, message_id: MessageId, expected_dialog_id: DialogId, expected_message_id: MessageId, promise: Promise<MessageThreadInfo>)"
    category: discussion
    async: false
    return_type: Result<MessageThreadInfo, Error>
    tdlib_name: process_discussion_message
    tdlib_line: 161-163

  # === Delete Operations ===
  - method: block_message_sender_from_replies_on_server
    signature: "block_message_sender_from_replies_on_server(message_id: MessageId, need_delete_message: bool, need_delete_all_messages: bool, report_spam: bool, log_event_id: u64, promise: Promise<Unit>)"
    category: delete
    async: true
    return_type: Result<(), Error>
    tdlib_name: block_message_sender_from_replies_on_server
    tdlib_line: 165-167

  - method: delete_all_call_messages_on_server
    signature: "delete_all_call_messages_on_server(revoke: bool, log_event_id: u64, promise: Promise<Unit>)"
    category: delete
    async: true
    return_type: Result<(), Error>
    tdlib_name: delete_all_call_messages_on_server
    tdlib_line: 169

  - method: delete_all_channel_messages_by_sender_on_server
    signature: "delete_all_channel_messages_by_sender_on_server(channel_id: ChannelId, sender_dialog_id: DialogId, log_event_id: u64, promise: Promise<Unit>)"
    category: delete
    async: true
    return_type: Result<(), Error>
    tdlib_name: delete_all_channel_messages_by_sender_on_server
    tdlib_line: 171-172

  - method: delete_dialog_history_on_server
    signature: "delete_dialog_history_on_server(dialog_id: DialogId, max_message_id: MessageId, remove_from_dialog_list: bool, revoke: bool, allow_error: bool, log_event_id: u64, promise: Promise<Unit>)"
    category: delete
    async: true
    return_type: Result<(), Error>
    tdlib_name: delete_dialog_history_on_server
    tdlib_line: 174-175

  - method: delete_dialog_messages_by_date_on_server
    signature: "delete_dialog_messages_by_date_on_server(dialog_id: DialogId, min_date: i32, max_date: i32, revoke: bool, log_event_id: u64, promise: Promise<Unit>)"
    category: delete
    async: true
    return_type: Result<(), Error>
    tdlib_name: delete_dialog_messages_by_date_on_server
    tdlib_line: 177-178

  - method: delete_messages_on_server
    signature: "delete_messages_on_server(dialog_id: DialogId, message_ids: Vec<MessageId>, revoke: bool, log_event_id: u64, promise: Promise<Unit>)"
    category: delete
    async: true
    return_type: Result<(), Error>
    tdlib_name: delete_messages_on_server
    tdlib_line: 180-181

  - method: delete_scheduled_messages_on_server
    signature: "delete_scheduled_messages_on_server(dialog_id: DialogId, message_ids: Vec<MessageId>, log_event_id: u64, promise: Promise<Unit>)"
    category: delete
    async: true
    return_type: Result<(), Error>
    tdlib_name: delete_scheduled_messages_on_server
    tdlib_line: 183-184

  - method: delete_topic_history_on_server
    signature: "delete_topic_history_on_server(dialog_id: DialogId, forum_topic_id: ForumTopicId, log_event_id: u64, promise: Promise<Unit>)"
    category: delete
    async: true
    return_type: Result<(), Error>
    tdlib_name: delete_topic_history_on_server
    tdlib_line: 186-187

  # === Read Operations ===
  - method: read_all_dialog_mentions_on_server
    signature: "read_all_dialog_mentions_on_server(dialog_id: DialogId, log_event_id: u64, promise: Promise<Unit>)"
    category: read
    async: true
    return_type: Result<(), Error>
    tdlib_name: read_all_dialog_mentions_on_server
    tdlib_line: 189

  - method: read_all_dialog_reactions_on_server
    signature: "read_all_dialog_reactions_on_server(dialog_id: DialogId, log_event_id: u64, promise: Promise<Unit>)"
    category: read
    async: true
    return_type: Result<(), Error>
    tdlib_name: read_all_dialog_reactions_on_server
    tdlib_line: 191

  - method: read_all_topic_mentions_on_server
    signature: "read_all_topic_mentions_on_server(dialog_id: DialogId, forum_topic_id: ForumTopicId, log_event_id: u64, promise: Promise<Unit>)"
    category: read
    async: true
    return_type: Result<(), Error>
    tdlib_name: read_all_topic_mentions_on_server
    tdlib_line: 193-194

  - method: read_all_topic_reactions_on_server
    signature: "read_all_topic_reactions_on_server(dialog_id: DialogId, forum_topic_id: ForumTopicId, saved_messages_topic_id: SavedMessagesTopicId, log_event_id: u64, promise: Promise<Unit>)"
    category: read
    async: true
    return_type: Result<(), Error>
    tdlib_name: read_all_topic_reactions_on_server
    tdlib_line: 196-198

  - method: read_message_contents_on_server
    signature: "read_message_contents_on_server(dialog_id: DialogId, message_ids: Vec<MessageId>, log_event_id: u64, promise: Promise<Unit>, skip_log_event: bool)"
    category: read
    async: true
    return_type: Result<(), Error>
    tdlib_name: read_message_contents_on_server
    tdlib_line: 200-201

  - method: read_message_reactions_on_server
    signature: "read_message_reactions_on_server(dialog_id: DialogId, message_ids: Vec<MessageId>)"
    category: read
    async: false
    return_type: ()
    tdlib_name: read_message_reactions_on_server
    tdlib_line: 203

  # === Unpin Operations ===
  - method: unpin_all_dialog_messages_on_server
    signature: "unpin_all_dialog_messages_on_server(dialog_id: DialogId, log_event_id: u64, promise: Promise<Unit>)"
    category: unpin
    async: true
    return_type: Result<(), Error>
    tdlib_name: unpin_all_dialog_messages_on_server
    tdlib_line: 205

  - method: unpin_all_topic_messages_on_server
    signature: "unpin_all_topic_messages_on_server(dialog_id: DialogId, forum_topic_id: ForumTopicId, saved_messages_topic_id: SavedMessagesTopicId, log_event_id: u64, promise: Promise<Unit>)"
    category: unpin
    async: true
    return_type: Result<(), Error>
    tdlib_name: unpin_all_topic_messages_on_server
    tdlib_line: 207-209

  # === Binlog Events ===
  - method: on_binlog_events
    signature: "on_binlog_events(events: Vec<BinlogEvent>)"
    category: binlog
    async: false
    return_type: ()
    tdlib_name: on_binlog_events
    tdlib_line: 211

# ============================================================================
# STATE MACHINES
# ============================================================================

state_machines:

  # === Upload Cover State Machine ===
  - name: BeingUploadedCover
    states:
      - name: Uploading
        description: Photo is being uploaded
        transitions:
          - event: UploadSuccess
            target: Complete
            action: complete_upload_message_cover
          - event: UploadError
            target: Failed
            action: on_upload_cover_error
          - event: BadParts
            target: Uploading
            action: do_upload_cover with bad_parts
    
    fields:
      - name: business_connection_id
        type: BusinessConnectionId
      - name: dialog_id
        type: DialogId
      - name: photo
        type: Photo
      - name: input_file
        type: Option<InputFile>
      - name: promise
        type: Promise<Unit>

  # === Extended Media Reload State ===
  - name: BeingReloadedExtendedMedia
    states:
      - name: Idle
        description: No reload in progress
      - name: Reloading
        description: Extended media reload in progress
        transitions:
          - event: ReloadComplete
            target: Idle
            action: finish_get_message_extended_media
    
    tracking:
      type: FlatHashSet<MessageFullId>
      field: being_reloaded_extended_media_message_full_ids_

  # === Fact Check Reload State ===
  - name: BeingReloadedFactChecks
    states:
      - name: Idle
        description: No reload in progress
      - name: Reloading
        description: Fact check reload in progress
        transitions:
          - event: ReloadComplete
            target: Idle
            action: on_reload_message_fact_checks
    
    tracking:
      type: FlatHashSet<MessageFullId>
      field: being_reloaded_fact_checks_

  # === View Counter State ===
  - name: NeedViewCounterIncrement
    states:
      - name: Pending
        description: View counter needs increment
      - name: Incremented
        description: View counter incremented
        transitions:
          - event: ViewReported
            target: Incremented
            action: view_messages
    
    tracking:
      type: FlatHashSet<MessageFullId>
      field: need_view_counter_increment_message_full_ids_

  # === Views Reload State ===
  - name: BeingReloadedViews
    states:
      - name: Idle
        description: No reload in progress
      - name: Reloading
        description: Message views reload in progress
        transitions:
          - event: ReloadComplete
            target: Idle
            action: finish_get_message_views
    
    tracking:
      type: FlatHashSet<MessageFullId>
      field: being_reloaded_views_message_full_ids_

  # === Reactions Reload State ===
  - name: BeingReloadedReactions
    states:
      - name: Idle
        description: No reload in progress
      - name: Queued
        description: Messages queued for reload
        transitions:
          - event: RequestSent
            target: Reloading
          - event: ReloadComplete
            target: Idle
            action: try_reload_message_reactions
    
    tracking:
      type: FlatHashMap<DialogId, ReactionsToReload>
      field: being_reloaded_reactions_
    
    nested_struct:
      name: ReactionsToReload
      fields:
        - name: message_ids
          type: FlatHashSet<MessageId>
        - name: is_request_sent
          type: bool

  # === Pending Read Reactions State ===
  - name: PendingReadReactions
    states:
      - name: Pending
        description: Reactions read pending
        transitions:
          - event: ReadComplete
            target: Completed
            action: on_read_message_reactions
    
    tracking:
      type: FlatHashMap<MessageFullId, i32>
      field: pending_read_reactions_

# ============================================================================
# ERROR TYPE SPECIFICATION
# ============================================================================

error_types:
  - name: UploadCoverError
    variants:
      - InvalidPhoto
      - UploadFailed(String)
      - NetworkError(String)
      - InvalidBusinessConnection

  - name: SearchError
    variants:
      - InvalidQuery
      - RateLimited(i32)
      - NetworkError(String)
      - InvalidOffset

  - name: DeleteError
    variants:
      - MessageNotFound
      - PermissionDenied
      - TooManyRequests
      - NetworkError(String)

  - name: ReadError
    variants:
      - MessageNotFound
      - PermissionDenied
      - AlreadyRead

# ============================================================================
# TL STUB REQUIREMENTS
# ============================================================================

tl_stubs:
  - tl_type: telegram_api::MessageMedia
    rust_name: MessageMedia
    stub_module: tl
    reason: Full TL layer not yet implemented
    variants:
      - Empty
      - Photo
      - Geo
      - Contact
      - Unsupported
    usage: Used in complete_upload_message_cover

  - tl_type: telegram_api::InputFile
    rust_name: InputFile
    stub_module: tl
    reason: Full TL layer not yet implemented
    variants:
      - InputFileId
      - InputFileBlob
      - InputFileBig
    usage: Used in BeingUploadedCover

  - tl_type: telegram_api::searchPostsFlood
    rust_name: SearchPostsFlood
    stub_module: tl
    reason: Search-specific TL type
    fields:
      - pending: bool
      - next_rate: i32
    usage: Used in on_get_public_post_search_result

  - tl_type: telegram_api::messages_discussionMessage
    rust_name: MessagesDiscussionMessage
    stub_module: tl
    reason: Discussion-specific TL type
    fields:
      - messages: Vec<Message>
      - max_id: i32
      - chats: Vec<Chat>
    usage: Used in process_discussion_message

  - tl_type: telegram_api::factCheck
    rust_name: FactCheck
    stub_module: tl
    reason: Fact check TL type
    fields:
      - text: FormattedText
      - country: String
    usage: Used in on_reload_message_fact_checks

# ============================================================================
# DEPENDENCY MATRIX (VERIFIED)
# ============================================================================

dependency_matrix:
  # === ID Types ===
  - type: DialogId
    source: rustgram-types
    constructor: from_user(), from_chat(), from_channel()
    location: types/src/ids.rs:658-667
    verified: true
    status: FOUND
  
  - type: MessageId
    source: rustgram-types
    constructor: new(), from_server_id()
    location: types/src/ids.rs:355-393
    verified: true
    status: FOUND
  
  - type: MessageFullId
    source: rustgram-message_full_id
    constructor: new(dialog_id, message_id)
    location: message_full_id/src/lib.rs:23-28
    verified: true
    status: FOUND
  
  - type: ChannelId
    source: rustgram-types
    constructor: new(id)
    location: types/src/ids.rs:458-503
    verified: true
    status: FOUND
  
  - type: BusinessConnectionId
    source: rustgram-business_connection_id
    constructor: new(id)
    location: business_connection_id/src/lib.rs:20-24
    verified: true
    status: FOUND
  
  - type: FileUploadId
    source: rustgram-file_upload_id
    constructor: new(file_id, internal_upload_id)
    location: file_upload_id/src/lib.rs:60-65
    verified: true
    status: FOUND
  
  - type: ForumTopicId
    source: rustgram-forum_topic_id
    constructor: new(id)
    location: forum_topic_id/src/lib.rs
    verified: true
    status: FOUND
  
  # === Complex Types ===
  - type: AffectedHistory
    source: rustgram-affected_history
    constructor: with_pts(pts, pts_count, is_final), empty()
    location: affected_history/src/lib.rs:69-94
    verified: true
    status: FOUND
  
  - type: MessageThreadInfo
    source: rustgram-message_thread_info
    constructor: new()
    location: message_thread_info/src/lib.rs:45-50
    verified: true
    status: FOUND
  
  - type: MessageTopic
    source: rustgram-message_topic
    constructor: new()
    location: message_topic/src/lib.rs:85-90
    verified: true
    status: FOUND
  
  - type: MessageViewer
    source: rustgram-message_viewer
    constructor: new()
    location: message_viewer/src/lib.rs
    verified: true
    status: FOUND
  
  # === Data Types ===
  - type: FormattedText
    source: rustgram-formatted_text
    constructor: new(text), with_entities(text, entities)
    location: formatted_text/src/lib.rs
    verified: true
    status: FOUND
  
  - type: Photo
    source: rustgram-message_extended_media
    constructor: new()
    location: message_extended_media/src/lib.rs:31-36
    verified: true
    status: FOUND
    note: Simplified stub - full Photo from TDLib not yet implemented
  
  - type: MessageSearchFilter
    source: rustgram-message_search_filter
    constructor: new()
    location: message_search_filter/src/lib.rs
    verified: true
    status: FOUND
  
  # === Missing Types (STUB REQUIRED) ===
  - type: DialogListId
    source: STUB REQUIRED
    constructor: TBD
    location: TBD
    verified: false
    status: NOT_FOUND
    mitigation: Create stub in message_query_manager/types.rs
  
  - type: MessageSearchOffset
    source: STUB REQUIRED
    constructor: TBD
    location: TBD
    verified: false
    status: NOT_FOUND
    mitigation: Create stub in message_query_manager/tl.rs
  
  - type: SavedMessagesTopicId
    source: rustgram-saved_messages_manager (internal)
    constructor: new(id)
    location: saved_messages_manager/src/topic_id.rs
    verified: true
    status: FOUND
    note: Re-export from saved_messages_manager crate
  
  - type: SearchMessagesChatTypeFilter
    source: STUB REQUIRED (td_api type)
    constructor: TBD
    location: TBD
    verified: false
    status: NOT_FOUND
    mitigation: Create stub in message_query_manager/tl.rs
  
  - type: FoundMessages
    source: STUB REQUIRED (td_api type)
    constructor: TBD
    location: TBD
    verified: false
    status: NOT_FOUND
    mitigation: Create stub in message_query_manager/tl.rs
  
  - type: FoundPublicPosts
    source: STUB REQUIRED (td_api type)
    constructor: TBD
    location: TBD
    verified: false
    status: NOT_FOUND
    mitigation: Create stub in message_query_manager/tl.rs
  
  - type: MessageReadDate
    source: STUB REQUIRED (td_api type)
    constructor: TBD
    location: TBD
    verified: false
    status: NOT_FOUND
    mitigation: Create stub in message_query_manager/tl.rs
  
  - type: MessageViewers
    source: STUB REQUIRED (td_api type)
    constructor: TBD
    location: TBD
    verified: false
    status: NOT_FOUND
    mitigation: Create stub in message_query_manager/tl.rs
  
  - type: MessageSenders
    source: STUB REQUIRED (td_api type)
    constructor: TBD
    location: TBD
    verified: false
    status: NOT_FOUND
    mitigation: Create stub in message_query_manager/tl.rs
  
  - type: InputChecklistTask
    source: STUB REQUIRED (td_api type)
    constructor: TBD
    location: TBD
    verified: false
    status: NOT_FOUND
    mitigation: Create stub in message_query_manager/tl.rs
  
  - type: Messages
    source: STUB REQUIRED (td_api type)
    constructor: TBD
    location: TBD
    verified: false
    status: NOT_FOUND
    mitigation: Create stub in message_query_manager/tl.rs
  
  - type: PublicPostSearchLimits
    source: STUB REQUIRED (td_api type)
    constructor: TBD
    location: TBD
    verified: false
    status: NOT_FOUND
    mitigation: Create stub in message_query_manager/tl.rs

# ============================================================================
# RISK REGISTER
# ============================================================================

risk_register:
  - id: R1
    type: MISSING_DEPENDENCY
    dependency: DialogListId
    mitigation: Create stub in types.rs with comment
    impact: LOW
    status: MITIGATED
  
  - id: R2
    type: MISSING_DEPENDENCY
    dependency: Full Photo type from TDLib
    mitigation: Use simplified Photo from message_extended_media
    impact: LOW
    status: MITIGATED
  
  - id: R3
    type: TL_STUB_REQUIRED
    dependency: telegram_api::MessageMedia
    mitigation: Create TL stub in tl.rs module
    impact: MEDIUM
    status: ACCEPTED
  
  - id: R4
    type: TL_STUB_REQUIRED
    dependency: telegram_api::InputFile
    mitigation: Create TL stub in tl.rs module
    impact: MEDIUM
    status: ACCEPTED
  
  - id: R5
    type: STATE_COMPLEXITY
    dependency: Multiple concurrent reload state machines
    mitigation: Use separate tracking maps for each state type
    impact: MEDIUM
    status: MITIGATED
  
  - id: R6
    type: THREAD_SAFETY
    dependency: Concurrent access to state maps
    mitigation: Use Arc<RwLock<T>> for all state tracking maps
    impact: HIGH
    status: MITIGATED
  
  - id: R7
    type: SERIALIZATION
    dependency: Binlog event serialization
    mitigation: Implement LogEvent trait for all operations
    impact: MEDIUM
    status: MITIGATED
  
  - id: R8
    type: API_COMPLEXITY
    dependency: 63+ public methods
    mitigation: Group by functionality, document each category
    impact: LOW
    status: ACCEPTED

# ============================================================================
# TEST REQUIREMENTS
# ============================================================================

test_requirements:
  min_tests: 70
  test_categories:
    - name: state_machine_tests
      count: 20
      description: Upload cover state transitions, reload states
    
    - name: api_method_tests
      count: 30
      description: Public API method behavior
    
    - name: error_handling_tests
      count: 10
      description: Error conditions and recovery
    
    - name: integration_tests
      count: 10
      description: Multi-operation workflows
  
  specific_tests:
    - test_upload_cover_success
    - test_upload_cover_retry_with_bad_parts
    - test_extended_media_reload_state
    - test_fact_check_reload_state
    - test_reactions_reload_queuing
    - test_pending_read_reactions_tracking
    - test_search_messages_pagination
    - test_delete_operations_error_handling
    - test_read_operations_batching
    - test_binlog_event_processing

# ============================================================================
# REFERENCE
# ============================================================================

reference:
  tdlib_header: references/td/td/telegram/MessageQueryManager.h
  tdlib_impl: references/td/td/telegram/MessageQueryManager.cpp
  tdlib_lines: 3528 (implementation)
  
  # Key TDLib sections
  upload_cover_state: 231-237
  reload_states: 300-316
  log_event_classes: 214-225
  constants: 229

# ============================================================================
# ADDITIONAL NOTES
# ============================================================================

notes:
  complexity_analysis: |
    MessageQueryManager is one of the most complex TDLib managers with:
    - 63+ public methods
    - 6 concurrent state machines
    - 14 binlog event types
    - Multiple TL stub requirements
    
    Implementation should focus on:
    1. Clear separation of concerns by functionality
    2. Robust state management with proper synchronization
    3. Comprehensive error handling
    4. Extensive test coverage for state transitions

  tdlib_alignment_notes: |
    - All public methods must match TDLib signatures exactly
    - State machine transitions must preserve TDLib semantics
    - Error handling must match TDLib's error types
    - Binlog event serialization must be compatible

  implementation_strategy: |
    1. Start with state tracking structures (FlatHashMap/FlatHashSet equivalents)
    2. Implement upload cover state machine (most complex)
    3. Implement reload operations (extended_media, fact_checks, views, reactions)
    4. Implement search operations (11 methods)
    5. Implement delete/read/unpin operations (14 methods)
    6. Implement binlog event handlers
    7. Add comprehensive tests for each category
