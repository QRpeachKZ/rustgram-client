# API Compatibility Check - Technical Specification

**Phase**: 2 (Analysis)
**Epic**: rustgram-client-1q4 "ma0.4-api-compatibility"
**Version**: 1.0
**Date**: 2026-01-17

```yaml
spec:
  name: "API Compatibility Check"
  version: "1.0.0"
  phase: 4
  epic: "rustgram-client-1q4"

# =============================================================================
# MODULE SPECIFICATIONS
# =============================================================================

modules:
  # ---------------------------------------------------------------------------
  # AUTH MANAGER
  # ---------------------------------------------------------------------------
  auth_manager:
    crate: "rustgram-auth-manager"
    tdlib_header: "references/td/td/telegram/AuthManager.h"
    rust_path: "crates/auth_manager/src/lib.rs"
    stub_level: 2  # PARTIAL: Has state machine, missing network integration
    
    public_api:
      # TDLib public methods (from AuthManager.h)
      tdlib_methods:
        - { name: "is_bot", signature: "bool is_bot() const", coverage: "PARTIAL" }
        - { name: "is_authorized", signature: "bool is_authorized() const", coverage: "FULL" }
        - { name: "was_authorized", signature: "bool was_authorized() const", coverage: "MISSING" }
        - { name: "get_state", signature: "void get_state(uint64 query_id)", coverage: "DIFFERENT" }
        - { name: "set_phone_number", signature: "void set_phone_number(uint64, string, td_api::object_ptr<td_api::phoneNumberAuthenticationSettings>)", coverage: "FULL" }
        - { name: "check_premium_purchase", signature: "void check_premium_purchase(uint64, string, int64)", coverage: "MISSING" }
        - { name: "set_firebase_token", signature: "void set_firebase_token(uint64, string)", coverage: "MISSING" }
        - { name: "report_missing_code", signature: "void report_missing_code(uint64, string)", coverage: "MISSING" }
        - { name: "set_email_address", signature: "void set_email_address(uint64, string)", coverage: "MISSING" }
        - { name: "resend_authentication_code", signature: "void resend_authentication_code(uint64, td_api::object_ptr<td_api::ResendCodeReason>)", coverage: "MISSING" }
        - { name: "check_email_code", signature: "void check_email_code(uint64, EmailVerification&&)", coverage: "PARTIAL" }
        - { name: "check_code", signature: "void check_code(uint64, string)", coverage: "FULL" }
        - { name: "register_user", signature: "void register_user(uint64, string, string, bool)", coverage: "MISSING" }
        - { name: "request_qr_code_authentication", signature: "void request_qr_code_authentication(uint64, vector<UserId>)", coverage: "PARTIAL" }
        - { name: "check_bot_token", signature: "void check_bot_token(uint64, string)", coverage: "FULL" }
        - { name: "check_password", signature: "void check_password(uint64, string)", coverage: "FULL" }
        - { name: "request_password_recovery", signature: "void request_password_recovery(uint64)", coverage: "MISSING" }
        - { name: "check_password_recovery_code", signature: "void check_password_recovery_code(uint64, string)", coverage: "MISSING" }
        - { name: "recover_password", signature: "void recover_password(uint64, string, string, string)", coverage: "MISSING" }
        - { name: "log_out", signature: "void log_out(uint64)", coverage: "FULL" }
        - { name: "delete_account", signature: "void delete_account(uint64, string, string)", coverage: "FULL" }
      
      # Rust public methods (from lib.rs)
      rust_methods:
        - { name: "new", signature: "pub fn new(api_id: i32, api_hash: String) -> Self", equivalent_to: "AuthManager constructor" }
        - { name: "set_phone_number", signature: "pub async fn set_phone_number(&self, phone: String) -> Result<(), AuthManagerError>", equivalent_to: "set_phone_number" }
        - { name: "check_code", signature: "pub async fn check_code(&self, code: String, email: Option<EmailVerification>) -> Result<(), AuthManagerError>", equivalent_to: "check_code" }
        - { name: "check_password", signature: "pub async fn check_password(&self, password: String) -> Result<(), AuthManagerError>", equivalent_to: "check_password" }
        - { name: "check_bot_token", signature: "pub async fn check_bot_token(&self, token: String) -> Result<(), AuthManagerError>", equivalent_to: "check_bot_token" }
        - { name: "request_qr_code_authentication", signature: "pub async fn request_qr_code_authentication(&self) -> Result<(), AuthManagerError>", equivalent_to: "request_qr_code_authentication" }
        - { name: "log_out", signature: "pub async fn log_out(&self) -> Result<(), AuthManagerError>", equivalent_to: "log_out" }
        - { name: "delete_account", signature: "pub async fn delete_account(&self, reason: String) -> Result<(), AuthManagerError>", equivalent_to: "delete_account" }
        - { name: "is_authorized", signature: "pub async fn is_authorized(&self) -> bool", equivalent_to: "is_authorized" }
        - { name: "get_state", signature: "pub fn get_state(&self) -> State", equivalent_to: "get_current_authorization_state_object()" }
    
    tl_types:
      - { name: "AuthorizationState", rust_crate: "rustgram-auth", rust_module: "state", coverage: "FULL" }
      - { name: "AuthenticationCodeInfo", rust_crate: "rustgram-auth", rust_module: "sent_code", coverage: "PARTIAL" }
      - { name: "AuthenticationCodeType", rust_crate: "rustgram-auth", rust_module: "code_type", coverage: "PARTIAL" }
      - { name: "EmailAddressAuthentication", rust_crate: "rustgram-auth", rust_module: "email_verification", coverage: "PARTIAL" }
      - { name: "EmailAddressResetState", rust_crate: null, coverage: "MISSING" }
      - { name: "TermsOfService", rust_crate: "rustgram-terms-of-service", coverage: "FULL" }
      - { name: "Passkey", rust_crate: "rustgram-passkey", coverage: "PARTIAL" }
    
    actor_patterns:
      - { tdlib: "class AuthManager : public NetActor", rust: "pub struct AuthManager", notes: "No inheritance, composition-based" }
      - { tdlib: "ActorShared<> parent_", rust: "Arc<RwLock<State>>", notes: "Shared ownership vs parent reference" }
      - { tdlib: "Promise<Unit> callback", rust: "async fn -> Result<(), E>", notes: "Async/await vs promise callbacks" }
      - { tdlib: "start_up() / tear_down()", rust: "N/A", notes: "No explicit lifecycle in current impl" }
      - { tdlib: "State enum with transitions", rust: "State enum", notes: "SAME: State machine pattern preserved" }

  # ---------------------------------------------------------------------------
  # CONNECTION STATE MANAGER
  # ---------------------------------------------------------------------------
  connection_state_manager:
    crate: "rustgram-connection-state-manager"
    tdlib_header: "references/td/td/telegram/ConnectionStateManager.h"
    rust_path: "crates/connection_state_manager/src/lib.rs"
    stub_level: 3  # FULL: Complete implementation with all states
    
    public_api:
      tdlib_methods:
        - { name: "get_current_state", signature: "void get_current_state(vector<td_api::object_ptr<td_api::Update>> &updates) const", coverage: "DIFFERENT" }
      
      rust_methods:
        - { name: "new", signature: "pub fn new() -> Self", equivalent_to: "Constructor" }
        - { name: "current_state", signature: "pub const fn current_state(&self) -> ConnectionState", equivalent_to: "connection_state_ accessor" }
        - { name: "set_state", signature: "pub fn set_state(&mut self, state: ConnectionState) -> Result<bool, StateError>", equivalent_to: "on_connection_state_changed()" }
        - { name: "is_ready", signature: "pub fn is_ready(&self) -> bool", equivalent_to: "state_ == ConnectionState::Ready check" }
        - { name: "is_connecting", signature: "pub fn is_connecting(&self) -> bool", equivalent_to: "N/A: Convenience method" }
        - { name: "is_connected", signature: "pub fn is_connected(&self) -> bool", equivalent_to: "N/A: Convenience method" }
        - { name: "reset", signature: "pub fn reset(&mut self)", equivalent_to: "N/A: Reset to Empty" }
    
    tl_types:
      - { name: "ConnectionState", rust_crate: "rustgram-connectionstate", coverage: "FULL" }
    
    actor_patterns:
      - { tdlib: "class ConnectionStateManager : public Actor", rust: "pub struct ConnectionStateManager", notes: "Simpler: No actor inheritance" }
      - { tdlib: "Td *td_", rust: "N/A", notes: "No Td dependency in Rust version" }
      - { tdlib: "on_connection_state_changed(ConnectionState)", rust: "set_state(ConnectionState)", notes: "Different notification model" }

  # ---------------------------------------------------------------------------
  # USER MANAGER
  # ---------------------------------------------------------------------------
  user_manager:
    crate: "rustgram-user-manager"
    tdlib_header: "references/td/td/telegram/UserManager.h"
    rust_path: "crates/user_manager/src/lib.rs"
    stub_level: 2  # PARTIAL: Has User struct, simplified manager
    
    public_api:
      tdlib_methods:
        - { name: "get_my_id", signature: "UserId get_my_id() const", coverage: "FULL" }
        - { name: "get_user", signature: "bool get_user(UserId, int, Promise<Unit>)", coverage: "DIFFERENT" }
        - { name: "reload_user", signature: "void reload_user(UserId, Promise<Unit>, const char*)", coverage: "MISSING" }
        - { name: "get_input_user", signature: "Result<telegram_api::object_ptr<telegram_api::InputUser>> get_input_user(UserId) const", coverage: "MISSING" }
        - { name: "is_user_bot", signature: "bool is_user_bot(UserId) const", coverage: "FULL" }
        - { name: "is_user_premium", signature: "bool is_user_premium(UserId) const", coverage: "FULL" }
        - { name: "is_user_deleted", signature: "bool is_user_deleted(UserId) const", coverage: "FULL" }
        - { name: "get_user_title", signature: "string get_user_title(UserId) const", coverage: "PARTIAL" }
        - { name: "get_user_object", signature: "td_api::object_ptr<td_api::user> get_user_object(UserId) const", coverage: "MISSING" }
        - { name: "set_name", signature: "void set_name(string, string, Promise<Unit>)", coverage: "MISSING" }
        - { name: "set_bio", signature: "void set_bio(string, Promise<Unit>)", coverage: "MISSING" }
        - { name: "set_username", signature: "void set_username(string, Promise<Unit>)", coverage: "MISSING" }
      
      rust_methods:
        - { name: "new", signature: "pub fn new() -> Self", equivalent_to: "Constructor" }
        - { name: "add_user", signature: "pub async fn add_user(&self, user: User) -> bool", equivalent_to: "on_get_user() internal" }
        - { name: "get_user", signature: "pub async fn get_user(&self, id: UserId) -> Option<User>", equivalent_to: "get_user()" }
        - { name: "remove_user", signature: "pub async fn remove_user(&self, id: UserId) -> Option<User>", equivalent_to: "N/A: No TDLib equivalent" }
        - { name: "get_my_id", signature: "pub async fn get_my_id(&self) -> Option<UserId>", equivalent_to: "get_my_id()" }
        - { name: "set_my_id", signature: "pub async fn set_my_id(&self, id: UserId)", equivalent_to: "set_my_id()" }
        - { name: "get_me", signature: "pub async fn get_me(&self) -> Option<User>", equivalent_to: "get_me()" }
        - { name: "is_bot", signature: "pub async fn is_bot(&self, id: UserId) -> bool", equivalent_to: "is_user_bot()" }
        - { name: "is_premium", signature: "pub async fn is_premium(&self, id: UserId) -> bool", equivalent_to: "is_user_premium()" }
        - { name: "is_deleted", signature: "pub async fn is_deleted(&self, id: UserId) -> bool", equivalent_to: "is_user_deleted()" }
        - { name: "get_display_name", signature: "pub async fn get_display_name(&self, id: UserId) -> Option<String>", equivalent_to: "get_user_title()" }
    
    tl_types:
      - { name: "user", rust_crate: null, coverage: "MISSING: No TD API object mapping" }
      - { name: "UserStatus", rust_crate: null, coverage: "MISSING" }
      - { name: "UserFullInfo", rust_crate: null, coverage: "MISSING" }
      - { name: "usernames", rust_crate: "rustgram-usernames", coverage: "FULL" }
      - { name: "profilePhoto", rust_crate: "rustgram-dialog-photo", coverage: "PARTIAL" }
    
    actor_patterns:
      - { tdlib: "class UserManager : public Actor", rust: "pub struct UserManager", notes: "No actor framework" }
      - { tdlib: "WaitFreeHashMap<UserId, unique_ptr<User>>", rust: "Arc<RwLock<HashMap<UserId, User>>>", notes: "Different concurrent map" }
      - { tdlib: "on_get_user(telegram_api::User&&)", rust: "add_user(User)", notes: "No network layer integration" }

  # ---------------------------------------------------------------------------
  # DIALOG MANAGER
  # ---------------------------------------------------------------------------
  dialog_manager:
    crate: "rustgram-dialog-manager"
    tdlib_header: "references/td/td/telegram/DialogManager.h"
    rust_path: "crates/dialog_manager/src/lib.rs"
    stub_level: 1  # TYPE DEFINITIONS ONLY
    
    public_api:
      tdlib_methods:
        - { name: "get_my_dialog_id", signature: "DialogId get_my_dialog_id() const", coverage: "MISSING" }
        - { name: "get_input_dialog_id", signature: "InputDialogId get_input_dialog_id(DialogId) const", coverage: "MISSING" }
        - { name: "get_input_peer", signature: "tl_object_ptr<telegram_api::InputPeer> get_input_peer(DialogId, AccessRights) const", coverage: "MISSING" }
        - { name: "check_dialog_access", signature: "Status check_dialog_access(DialogId, bool, AccessRights, const char*) const", coverage: "MISSING" }
        - { name: "set_dialog_title", signature: "void set_dialog_title(DialogId, string, Promise<Unit>)", coverage: "MISSING" }
        - { name: "set_dialog_photo", signature: "void set_dialog_photo(DialogId, const td_api::object_ptr<td_api::InputChatPhoto>&, Promise<Unit>)", coverage: "MISSING" }
        - { name: "get_chat_id_object", signature: "int64 get_chat_id_object(DialogId, const char*) const", coverage: "MISSING" }
      
      rust_methods:
        - { name: "N/A", signature: "lib.rs is minimal", equivalent_to: "N/A" }
    
    tl_types:
      - { name: "chat", rust_crate: null, coverage: "MISSING" }
      - { name: "ChatType", rust_crate: null, coverage: "MISSING" }
      - { name: "ChatList", rust_crate: null, coverage: "MISSING" }
      - { name: "DialogFilter", rust_crate: null, coverage: "MISSING" }

  # ---------------------------------------------------------------------------
  # MESSAGES MANAGER
  # ---------------------------------------------------------------------------
  messages_manager:
    crate: "rustgram-messages-manager"
    tdlib_header: "references/td/td/telegram/MessagesManager.h"
    rust_path: "crates/messages-manager/src/lib.rs"
    stub_level: 1  # TYPE DEFINITIONS ONLY
    
    public_api:
      tdlib_methods:
        - { name: "send_message", signature: "void send_message(DialogId, MessageInputReplyTo, InputMessageContent*, Promise<>), coverage: "MISSING" }
        - { name: "get_messages", signature: "void get_messages(DialogId, vector<MessageId>, Promise<>)", coverage: "MISSING" }
        - { name: "delete_messages", signature: "void delete_messages(DialogId, vector<MessageId>, bool, Promise<Unit>)", coverage: "MISSING" }
        - { name: "edit_message_text", signature: "void edit_message_text(DialogId, MessageId, InputMessageText*, Promise<Unit>)", coverage: "MISSING" }
        - { name: "get_history", signature: "void get_history(DialogId, MessageId, int32, int32, bool, Promise<Unit>)", coverage: "MISSING" }
        - { name: "search_messages", signature: "void search_messages(DialogId, string, MessageId, int32, MessageSearchFilter, Promise<Unit>)", coverage: "MISSING" }
      
      rust_methods:
        - { name: "N/A", signature: "lib.rs has type definitions only", equivalent_to: "N/A" }
    
    tl_types:
      - { name: "message", rust_crate: null, coverage: "MISSING" }
      - { name: "MessageContent", rust_crate: "rustgram-message-content", coverage: "PARTIAL" }
      - { name: "MessageForwardInfo", rust_crate: null, coverage: "MISSING" }
      - { name: "MessageReplyInfo", rust_crate: null, coverage: "MISSING" }
      - { name: "formattedText", rust_crate: "rustgram-formatted-text", coverage: "PARTIAL" }

  # ---------------------------------------------------------------------------
  # NOTIFICATION MANAGER
  # ---------------------------------------------------------------------------
  notification_manager:
    crate: "rustgram-notification-manager"
    tdlib_header: "references/td/td/telegram/NotificationManager.h"
    rust_path: "crates/notification-manager/src/lib.rs"
    stub_level: 1  # TYPE DEFINITIONS ONLY
    
    public_api:
      tdlib_methods:
        - { name: "get_max_notification_group_size", signature: "size_t get_max_notification_group_size() const", coverage: "MISSING" }
        - { name: "add_notification", signature: "void add_notification(NotificationGroupId, ...)", coverage: "MISSING" }
        - { name: "remove_notification", signature: "void remove_notification(NotificationGroupId, NotificationId, bool, bool, Promise<Unit>, const char*)", coverage: "MISSING" }
        - { name: "remove_notification_group", signature: "void remove_notification_group(NotificationGroupId, ...)", coverage: "MISSING" }
      
      rust_methods:
        - { name: "N/A", signature: "lib.rs is minimal", equivalent_to: "N/A" }
    
    tl_types:
      - { name: "notification", rust_crate: "rustgram-notification", coverage: "PARTIAL" }
      - { name: "NotificationType", rust_crate: "rustgram-notification-type", coverage: "PARTIAL" }
      - { name: "notificationGroup", rust_crate: null, coverage: "MISSING" }
      - { name: "NotificationGroupType", rust_crate: "rustgram-notification-group-type", coverage: "PARTIAL" }

# =============================================================================
# DEPENDENCY MATRIX
# =============================================================================

dependency_matrix:
  # Manager-to-Manager dependencies
  manager_dependencies:
    auth_manager:
      depends_on: []
      required_by: [user_manager, dialog_manager, messages_manager]
      notes: "Authentication must complete before user/dialog operations"
    
    connection_state_manager:
      depends_on: []
      required_by: [messages_manager, notification_manager]
      notes: "Must be connected to send/receive"
    
    user_manager:
      depends_on: [auth_manager]
      required_by: [dialog_manager, messages_manager]
      notes: "Users referenced in dialogs/messages"
    
    dialog_manager:
      depends_on: [auth_manager, user_manager]
      required_by: [messages_manager, notification_manager]
      notes: "Messages/notifications target dialogs"
    
    messages_manager:
      depends_on: [auth_manager, connection_state_manager, user_manager, dialog_manager]
      required_by: []
      notes: "Top-level dependency"
    
    notification_manager:
      depends_on: [connection_state_manager, dialog_manager]
      required_by: []
      notes: "Receives updates from connection/dialogs"
  
  # Shared type dependencies
  type_dependencies:
    primitive_types:
      - { name: "int32", rust_crate: "rustgram-types", rust_type: "i32" }
      - { name: "int53", rust_crate: "rustgram-types", rust_type: "i64" }
      - { name: "int64", rust_crate: "rustgram-types", rust_type: "i64" }
      - { name: "string", rust_crate: "rustgram-types", rust_type: "String" }
      - { name: "bytes", rust_crate: "rustgram-types", rust_type: "Vec<u8>" }
      - { name: "boolFalse/boolTrue", rust_crate: "rustgram-types", rust_type: "bool" }
    
    id_types:
      - { name: "UserId", rust_crate: "rustgram-user-id", coverage: "FULL" }
      - { name: "ChatId", rust_crate: "rustgram-chat-id", coverage: "FULL" }
      - { name: "DialogId", rust_crate: "rustgram-dialog-id", coverage: "PARTIAL" }
      - { name: "MessageId", rust_crate: "rustgram-message-id", coverage: "PARTIAL" }
      - { name: "ChannelId", rust_crate: "rustgram-channel-id", coverage: "PARTIAL" }
      - { name: "SecretChatId", rust_crate: "rustgram-secret-chat-id", coverage: "PARTIAL" }
      - { name: "NotificationId", rust_crate: "rustgram-notification-id", coverage: "PARTIAL" }
      - { name: "NotificationGroupId", rust_crate: "rustgram-notification-group-id", coverage: "PARTIAL" }
    
    actor_framework:
      - { name: "Actor", rust_crate: null, coverage: "MISSING: No actor framework crate" }
      - { name: "ActorShared", rust_crate: null, coverage: "MISSING: Use Arc<RwLock<T>> instead" }
      - { name: "Promise", rust_crate: null, coverage: "MISSING: Use async/await instead" }
      - { name: "NetActor", rust_crate: null, coverage: "MISSING: Network layer integration" }
      - { name: "Timeout", rust_crate: null, coverage: "MISSING: Use tokio::time::sleep" }

# =============================================================================
# RISK REGISTER
# =============================================================================

risk_register:
  - id: "R1"
    type: "API_INCOMPATIBILITY"
    description: "TDLib uses query_id pattern; Rust uses async/await. Fundamental architectural difference makes direct API comparison difficult."
    impact: "HIGH"
    probability: "HIGH"
    status: "OPEN"
    mitigation: "Document functional equivalence instead of 1:1 API mapping. Create mapping table: Promise<T> → async fn → Result<T>."
    owner: "Phase 2 Analyst"
    
  - id: "R2"
    type: "ARCHITECTURE_MISMATCH"
    description: "No centralized actor framework crate in Rust. Each manager uses ad-hoc Arc<RwLock<T>> pattern."
    impact: "HIGH"
    probability: "MEDIUM"
    status: "OPEN"
    mitigation: "Document current ad-hoc patterns. Consider creating crates/actor in future work. For this audit, accept pattern variance."
    owner: "Phase 2 Analyst"
    
  - id: "R3"
    type: "STUB_IMPLEMENTATION"
    description: "dialog_manager, messages-manager, notification-manager are LEVEL 1 stubs (type definitions only). Missing 100% of logic."
    impact: "MEDIUM"
    probability: "HIGH"
    status: "OPEN"
    mitigation: "Document as 'TYPE DEFINITIONS ONLY' in gap analysis. Prioritize for Phase 3 implementation."
    owner: "Phase 3 Implementer"
    
  - id: "R4"
    type: "TL_SCHEMA_GAP"
    description: "TDLib objects (td_api::user, td_api::chat, td_api::message) not mapped to Rust structs. Only primitive types have full coverage."
    impact: "HIGH"
    probability: "HIGH"
    status: "OPEN"
    mitigation: "Create mapping of missing TDLib → Rust types. Estimate effort to generate from td_api.tl."
    owner: "Phase 2 Analyst"
    
  - id: "R5"
    type: "DOCUMENTATION_MISSING"
    description: "No API documentation generated from Rust code. TDLib has header documentation. Comparison requires manual inspection."
    impact: "LOW"
    probability: "HIGH"
    status: "MITIGATED"
    mitigation: "Use rustdoc to generate HTML. Compare with TDLib Doxygen. Create cross-reference document."
    owner: "Phase 2 Analyst"
    
  - id: "R6"
    type: "API_INCOMPATIBILITY"
    description: "UserManager uses HashMap<UserId, User> instead of TDLib's WaitFreeHashMap. Different concurrency semantics."
    impact: "LOW"
    probability: "MEDIUM"
    status: "MITIGATED"
    mitigation: "Document: RwLock provides exclusive write access. WaitFreeHashMap allows concurrent reads. Accept as architectural difference."
    owner: "Phase 2 Analyst"
    
  - id: "R7"
    type: "STUB_IMPLEMENTATION"
    description: "AuthManager missing 13 critical methods from TDLib (password recovery, premium purchase, Firebase token, etc.)"
    impact: "MEDIUM"
    probability: "HIGH"
    status: "OPEN"
    mitigation: "List all missing methods in gap analysis. Categorize by: AUTH_FLOW, PAYMENT, RECOVERY. Prioritize AUTH_FLOW."
    owner: "Phase 3 Implementer"
    
  - id: "R8"
    type: "TL_SCHEMA_GAP"
    description: "87% coverage target is not calculated. No baseline exists."
    impact: "MEDIUM"
    probability: "HIGH"
    status: "BLOCKER"
    mitigation: "MUST establish baseline before Batch 1. Count types in td_api.tl vs Rust crates. Document current %."
    owner: "Phase 2.5 Verification"
    
  - id: "R9"
    type: "ARCHITECTURE_MISMATCH"
    description: "TDLib managers receive Td* reference. Rust managers have no global client object."
    impact: "MEDIUM"
    probability: "LOW"
    status: "MITIGATED"
    mitigation: "Document as design choice: Rust prefers explicit dependencies over global Td singleton. Accept as architectural difference."
    owner: "Phase 2 Analyst"
    
  - id: "R10"
    type: "DOCUMENTATION_MISSING"
    description: "Actor pattern mapping has no template. Risk of inconsistent documentation across batches."
    impact: "LOW"
    probability: "MEDIUM"
    status: "MITIGATED"
    mitigation: "Created actor_mapping_template.md in plan_validation.md. All auditors must use this template."
    owner: "Phase 2 Analyst"

# =============================================================================
# SUCCESS CRITERIA
# =============================================================================

success_criteria:
  api_coverage:
    description: "Percentage of critical managers audited"
    target: 100
    threshold: 90
    measurement: "count of audited managers / 6 total"
    
  tl_schema_coverage:
    description: "TL schema types verified against td_api.tl"
    target: 87
    threshold: 80
    measurement: "verified types / total types in td_api.tl"
    baseline_required: true
    baseline_method: "grep -c '^[@a-zA-Z]' references/td/td/generate/scheme/td_api.tl"
    
  documentation_completeness:
    description: "All required documentation artifacts created"
    required_artifacts:
      - "docs/api-compatibility-report.md"
      - "docs/gap-analysis.md"
      - "docs/stub-inventory.md"
      - "docs/actor-pattern-mapping.md"
    target: 4
    threshold: 4
    
  quality_gates:
    critical_issues:
      target: 0
      threshold: 0
      description: "No BLOCKER issues allowed"
      
    high_risks:
      target: 0
      threshold: 3
      description: "Maximum 3 HIGH risk items allowed at completion"
      
    code_quality:
      clippy_clean: true
      no_production_unwrap: true
      description: "All audited code must pass clippy with current lints"

# =============================================================================
# OUTPUT ARTIFACTS
# =============================================================================

artifacts:
  phase_2_outputs:
    - path: "specs/api-compatibility-check/plan_validation.md"
      description: "Plan validation with recommendations"
      format: "markdown"
      
    - path: "specs/api-compatibility-check/spec.yaml"
      description: "Technical specification with module specs, dependencies, risks"
      format: "yaml"
      
    - path: "specs/api-compatibility-check/dependency_matrix.md"
      description: "Visual dependency matrix (generated from spec.yaml)"
      format: "markdown"
      
    - path: "specs/api-compatibility-check/risk_register.yaml"
      description: "Risk register extracted from spec.yaml"
      format: "yaml"
      
    - path: "specs/api-compatibility-check/actor_mapping_template.md"
      description: "Template for actor pattern documentation"
      format: "markdown"
  
  phase_3_outputs:
    - path: "docs/api-compatibility-report.md"
      description: "Main compatibility report for all 6 managers"
      format: "markdown"
      
    - path: "docs/gap-analysis.md"
      description: "Analysis of missing 13% TL schema coverage"
      format: "markdown"
      
    - path: "docs/stub-inventory.md"
      description: "Inventory of stub implementations by level (0-3)"
      format: "markdown"
      
    - path: "docs/actor-pattern-mapping.md"
      description: "TDLib to Rust actor pattern mappings"
      format: "markdown"
      
    - path: "docs/api-compatibility-check-results.json"
      description: "Machine-readable results for automation"
      format: "json"
