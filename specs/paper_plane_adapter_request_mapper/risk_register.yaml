# Risk Register: Paper Plane Adapter Request Mapper
**Task ID**: rustgram-client-zwh.3
**Version**: 1.0
**Last Updated**: 2026-01-21
**Status**: Active

---

## Risk Summary

| Total | Critical | High | Medium | Low |
|-------|----------|------|--------|-----|
| 12 | 2 | 4 | 4 | 2 |

---

## Technical Risks

### R1: JSON Schema Incompatibility with TDLib
| Field | Value |
|-------|-------|
| **ID** | R1 |
| **Level** | 游댮 **CRITICAL** |
| **Category** | Technical |
| **Description** | The JSON request/response format may not match TDLib exactly, causing integration failures with Paper Plane GUI |
| **Impact** | Breaking changes in Paper Plane, failed requests, data loss |
| **Probability** | Medium |
| **Status** | 游리 **OPEN** |
| **Owner** | Implementation Team |
| **Mitigation** | 1. Reference `references/td/td/telegram/ClientJson.cpp`<br>2. Create TDLib compatibility test suite<br>3. Document exact JSON format for each request type<br>4. Use TDLib's `tl_json.h` serialization as template |
| **Contingency** | Create adapter layer to translate between formats if incompatibility discovered late |
| **Dependencies** | Phase 1 plan clarification on JSON vs Direct mapping (RESOLVED: Use JSON mapping) |

### R2: Async Bridge Complexity
| Field | Value |
|-------|-------|
| **ID** | R2 |
| **Level** | 游댮 **CRITICAL** |
| **Category** | Technical |
| **Description** | Bridging sync GUI calls to async manager methods is complex; race conditions and deadlocks possible |
| **Impact** | Application hangs, crashes, data corruption |
| **Probability** | High |
| **Status** | 游리 **OPEN** |
| **Owner** | Implementation Team |
| **Mitigation** | 1. Use `tokio::sync::mpsc` unbounded channels for request queuing<br>2. Design with single async executor thread<br>3. Implement request timeout with automatic cleanup<br>4. Add comprehensive concurrency tests<br>5. Monitor with tracing for deadlock detection |
| **Contingency** | Fall back to sync wrapper around async calls if channel approach fails |
| **Dependencies** | None |

### R3: Request ID Collision
| Field | Value |
|-------|-------|
| **ID** | R3 |
| **Level** | 游 **HIGH** |
| **Category** | Technical |
| **Description** | Request IDs (u64) may collide in long-running processes or high-throughput scenarios |
| **Impact** | Response sent to wrong caller, data leakage, security issue |
| **Probability** | Low (requires 2^64 requests) |
| **Status** | 游리 **OPEN** |
| **Owner** | Implementation Team |
| **Mitigation** | 1. Use `AtomicU64` with relaxed ordering<br>2. Wraparound is safe due to pending request timeout<br>3. Document collision probability<br>4. Add debug assertion for duplicate IDs |
| **Contingency** | Use UUID or u128 if collision becomes issue |
| **Dependencies** | None |

### R4: Memory Leak in Pending Requests
| Field | Value |
|-------|-------|
| **ID** | R4 |
| **Level** | 游 **HIGH** |
| **Category** | Technical |
| **Description** | Pending requests map may leak memory if responses never arrive (network failures, bugs) |
| **Impact** | Unbounded memory growth, OOM crashes |
| **Probability** | Medium |
| **Status** | 游리 **OPEN** |
| **Owner** | Implementation Team |
| **Mitigation** | 1. Implement request timeout (default: 60 seconds)<br>2. Cleanup expired requests on each `receive()` call<br>3. Add metrics for pending request count<br>4. Log warnings for high pending count |
| **Contingency** | Add max pending request limit with LRU eviction |
| **Dependencies** | None |

### R5: Type Conversion Errors
| Field | Value |
|-------|-------|
| **ID** | R5 |
| **Level** | 游 **HIGH** |
| **Category** | Technical |
| **Description** | Converting between JSON types (i64) and Rust types (UserId, ChatId) may fail with edge cases |
| **Impact** | Panic or incorrect data |
| **Probability** | Medium |
| **Status** | 游리 **OPEN** |
| **Owner** | Implementation Team |
| **Mitigation** | 1. Use `TryFrom` traits with proper error handling<br>2. Never `unwrap()` on type conversion<br>3. Add unit tests for edge cases (0, -1, MAX)<br>4. Document valid ranges for each ID type |
| **Contingency** | Add validation layer before type conversion |
| **Dependencies** | None |

### R6: Manager API Changes
| Field | Value |
|-------|-------|
| **ID** | R6 |
| **Level** | 游리 **MEDIUM** |
| **Category** | Technical |
| **Description** | Manager APIs may change during development, breaking the adapter |
| **Impact** | Compilation errors, runtime panics |
| **Probability** | Medium |
| **Status** | 游리 **OPEN** |
| **Owner** | Architecture Team |
| **Mitigation** | 1. Version pin manager crates in Cargo.toml<br>2. Use trait objects for manager abstraction<br>3. Add integration tests that fail on API breakage<br>4. Coordinate changes with manager teams |
| **Contingency** | Create compatibility shim for old API |
| **Dependencies** | Manager crate versions |

---

## API Risks

### R7: Incomplete Manager Coverage
| Field | Value |
|-------|-------|
| **ID** | R7 |
| **Level** | 游 **HIGH** |
| **Category** | API |
| **Description** | Paper Plane may use manager methods not yet implemented (e.g., editMessage, forwardMessages) |
| **Impact** | Feature not working in GUI, fallback to TDLib |
| **Probability** | High |
| **Status** | 游리 **OPEN** |
| **Owner** | Requirements Team |
| **Mitigation** | 1. Audit Paper Plane code for all used requests<br>2. Prioritize common requests first<br>3. Return error for unsupported requests with clear message<br>4. Document unsupported operations |
| **Contingency** | Stub unsupported requests to return "not implemented" error |
| **Dependencies** | Paper Plane source code audit |

### R8: @extra Format Mismatch
| Field | Value |
|-------|-------|
| **ID** | R8 |
| **Level** | 游리 **MEDIUM** |
| **Category** | API |
| **Description** | TDLib serializes @extra as JSON string; clients may expect different format |
| **Impact** | Request correlation breaks, client can't match responses |
| **Probability** | Low |
| **Status** | 游리 **OPEN** |
| **Owner** | Implementation Team |
| **Mitigation** | 1. Follow TDLib: @extra as JSON string, not raw value<br>2. Add test with complex @extra (nested object)<br>3. Document @extra behavior clearly |
| **Contingency** | Accept both string and raw value for compatibility |
| **Dependencies** | None |

### R9: Update Ordering
| Field | Value |
|-------|-------|
| **ID** | R9 |
| **Level** | 游리 **MEDIUM** |
| **Category** | API |
| **Description** | Updates must be delivered in order; async channel may reorder |
| **Impact** | GUI shows stale data, confusion, incorrect state |
| **Probability** | Medium |
| **Status** | 游리 **OPEN** |
| **Owner** | Implementation Team |
| **Mitigation** | 1. Use single-producer channel (guarantees order)<br>2. Add sequence number to each update<br>3. Document ordering guarantee<br>4. Test with rapid updates |
| **Contingency** | Buffer updates and sort by sequence number |
| **Dependencies** | Task zwh.2 (Update Channel Bridge) |

### R10: Missing Error Codes
| Field | Value |
|-------|-------|
| **ID** | R10 |
| **Level** | 游리 **MEDIUM** |
| **Category** | API |
| **Description** | Manager errors may not map to TDLib error codes exactly |
| **Impact** | GUI shows wrong error message, user confusion |
| **Probability** | Medium |
| **Status** | 游리 **OPEN** |
| **Owner** | Implementation Team |
| **Mitigation** | 1. Document error mapping table<br>2. Add error code translation layer<br>3. Return descriptive messages even if code differs<br>4. Test all error paths |
| **Contingency** | Use generic 500 error for unknown codes |
| **Dependencies** | None |

---

## Integration Risks

### R11: Thread Safety Violation
| Field | Value |
|-------|-------|
| **ID** | R11 |
| **Level** | 游릭 **LOW** |
| **Category** | Integration |
| **Description** | `receive()` not thread-safe; multiple threads calling it may cause data races |
| **Impact** | Panic, missing responses |
| **Probability** | Low (documented limitation) |
| **Status** | 游릭 **MITIGATED** |
| **Owner** | Documentation Team |
| **Mitigation** | 1. Document that `receive()` must be called from single thread<br>2. Add debug assertion for concurrent calls<br>3. Provide thread-safe wrapper if needed |
| **Contingency** | Add Mutex wrapper for thread-safe receive |
| **Dependencies** | None |

### R12: GUI Event Loop Integration
| Field | Value |
|-------|-------|
| **ID** | R12 |
| **Level** | 游릭 **LOW** |
| **Category** | Integration |
| **Description** | Paper Plane uses glib main loop; integrating with tokio runtime may be tricky |
| **Impact** | Events not processed, GUI freezes |
| **Probability** | Low |
| **Status** | 游리 **OPEN** |
| **Owner** | Integration Team |
| **Mitigation** | 1. Task zwh.2 specifically addresses this (glib channel)<br>2. Use `glib::Sender` for thread-safe bridge<br>3. Test with actual Paper Plane GUI<br>4. Document integration pattern |
| **Contingency** | Run tokio in separate thread with glib timeout source |
| **Dependencies** | Task zwh.2, glib-rs |

---

## Risk Metrics

### Exposure by Level

| Level | Count | Mitigation Required |
|-------|-------|---------------------|
| 游댮 Critical | 2 | Immediate mitigation before dev |
| 游 High | 4 | Mitigation in first sprint |
| 游리 Medium | 4 | Mitigation in second sprint |
| 游릭 Low | 2 | Monitor |

### Exposure by Category

| Category | Critical | High | Medium | Low | Total |
|----------|----------|------|--------|-----|-------|
| Technical | 2 | 3 | 1 | 0 | 6 |
| API | 0 | 1 | 3 | 0 | 4 |
| Integration | 0 | 0 | 0 | 2 | 2 |

### Open vs Mitigated

| Status | Count | Percentage |
|--------|-------|------------|
| 游리 OPEN | 11 | 92% |
| 游릭 MITIGATED | 1 | 8% |
| 游댮 BLOCKER | 0 | 0% |

---

## Mitigation Progress

### Sprint 1 (Critical + High)
- [ ] R1: JSON Schema Incompatibility - Create TDLib compatibility tests
- [ ] R2: Async Bridge Complexity - Design channel architecture
- [ ] R3: Request ID Collision - Implement AtomicU64 generator
- [ ] R4: Memory Leak - Add timeout and cleanup logic
- [ ] R5: Type Conversion - Add TryFrom implementations
- [ ] R7: Incomplete Coverage - Audit Paper Plane requests

### Sprint 2 (Medium)
- [ ] R6: Manager API Changes - Version pin crates
- [ ] R8: @extra Format - Add format tests
- [ ] R9: Update Ordering - Implement single-producer channel
- [ ] R10: Error Codes - Create error mapping table

### Sprint 3 (Low + Review)
- [ ] R11: Thread Safety - Document receive() limitation
- [ ] R12: GUI Integration - Coordinate with zwh.2
- [ ] All risks: Re-assess after implementation

---

## Risk Response Strategies

### Avoid (eliminate risk cause)
- R2: Async Bridge - Use proven TDLib pattern (channels)
- R3: ID Collision - Use large ID space (u64)

### Transfer (shift to third party)
- R6: Manager API Changes - Use semantic versioning

### Mitigate (reduce impact/probability)
- R1: JSON Schema - Compatibility tests
- R4: Memory Leak - Timeout cleanup
- R5: Type Conversion - Proper error handling

### Accept (document and monitor)
- R11: Thread Safety - Document limitation
- R12: GUI Integration - Known issue, addressed in zwh.2

---

## Escalation Triggers

| Risk | Trigger | Escalation To |
|------|---------|---------------|
| R1 | Compatibility test failure | Architecture Team |
| R2 | Deadlock in integration tests | Tech Lead |
| R4 | Memory growth > 100MB in tests | Performance Team |
| R7 | > 20% of Paper Plane requests unsupported | Requirements Team |
| R12 | GUI freeze in integration test | Integration Team |

---

**Risk Register Status**: Active  
**Next Review**: Sprint 1 completion  
**Owner**: Phase 2 Analysis Agent
