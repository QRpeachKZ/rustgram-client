# Risk Register: Phase 1 Basic Messaging
# Epic: rustgram-client-6im
# Generated: 2026-01-21
# Last Updated: 2026-01-21

register:
  version: 1.0
  epic: rustgram-client-6im
  phase: Phase 2 - Analysis & Design

# ============================================================================
# RISK CATEGORIES
# ============================================================================

risk_types:
  BLOCKER: Prevents implementation, must resolve before starting
  HIGH: Significant impact, requires mitigation strategy
  MEDIUM: Moderate impact, monitor and plan contingencies
  LOW: Minor impact, accept with monitoring

# ============================================================================
# RISKS
# ============================================================================

risks:
  # ========================================================================
  # BLOCKER RISKS
  # ========================================================================
  
  - id: R001
    type: BLOCKER
    category: ARCHITECTURE
    title: Message Type Definition Missing
    description: |
      Core Message type doesn't exist. All messaging operations depend on this
      type, making it a critical blocker for Phase 1 implementation.
    impact: |
      Cannot implement send or receive operations. Entire epic blocked.
    probability: 100% (certain)
    exposure: BLOCKER
    mitigation_strategy: |
      1. Create rustgram_message_types crate first (Day 1)
      2. Implement Message struct with core fields only
      3. Add comprehensive tests (30+)
      4. Verify serialization/deserialization works
      5. Get code review approval before proceeding
    contingency: |
      If TDLib Message proves too complex:
      1. Start with minimal Message struct (id, dialog_id, sender_id, date, content)
      2. Defer advanced fields (reactions, threads, stories) to Phase 2
      3. Use trait-based design for extensibility
    owner: Senior Rust Developer
    status: OPEN
    created: 2026-01-21
    target_resolution: 2026-01-22 (Day 1)
    
  - id: R002
    type: BLOCKER
    category: INTEGRATION
    title: TL Schema Type Misalignment
    description: |
      TL schema types (SendMessageRequest, UpdateNewMessage, etc.) don't exist.
      These are required for MTProto communication.
    impact: |
      Cannot serialize/deserialize MTProto messages. Network communication blocked.
    probability: 90% (likely)
    exposure: BLOCKER
    mitigation_strategy: |
      1. Reference TDLib TL definitions directly
      2. Create tl.rs module with exact field names
      3. Implement serde serialization
      4. Test against wire format captures
      5. Validate with TDLib reference implementation
    contingency: |
      If TL schema proves incompatible:
      1. Use raw bytes for initial implementation
      2. Layer proper TL types in Phase 1.5
      3. Maintain compatibility shim during transition
    owner: Network Protocol Specialist
    status: OPEN
    created: 2026-01-21
    target_resolution: 2026-01-23 (Day 2)
    
  # ========================================================================
  # HIGH RISKS
  # ========================================================================
  
  - id: R003
    type: HIGH
    category: LOGIC
    title: Message Ordering Consistency
    description: |
      Messages may arrive out of order from MTProto due to network conditions,
      concurrent updates, or server-side processing. Ensuring consistent
      ordering in the database and UI is critical.
    impact: |
      Users see messages in wrong order. Conversation history becomes corrupted.
      Data integrity issues requiring manual cleanup.
    probability: 60% (possible)
    exposure: HIGH
    mitigation_strategy: |
      1. Use MessageId as primary ordering key (server-assigned, monotonic)
      2. Implement message gap detection (detect missing message IDs)
      3. Add reorder buffer for out-of-order messages (max 100 messages)
      4. Store pts (permanent timestamp) for conflict resolution
      5. Add unit tests for ordering edge cases
    contingency: |
      If ordering issues persist:
      1. Log all out-of-order messages for analysis
      2. Implement manual "fetch history" for gaps
      3. Add UI indicator for "messages may be out of order"
    owner: Backend Engineer
    status: OPEN
    created: 2026-01-21
    target_resolution: 2026-01-25 (Day 4)
    
  - id: R004
    type: HIGH
    category: PERFORMANCE
    title: Database Write Bottleneck
    description: |
      MessageDb uses HashMap storage (stub). Under high message throughput
      (500+ msg/sec), single-threaded writes may become a bottleneck.
    impact: |
      Message receive throughput degrades. Updates delayed. User experience suffers.
    probability: 50% (moderate)
    exposure: HIGH
    mitigation_strategy: |
      1. Profile MessageDb write operations early (Day 3)
      2. Implement write batching (group 100 messages per transaction)
      3. Use RocksDB backend if HashMap insufficient (optional dependency)
      4. Add write-through cache for recent messages
      5. Benchmark at 500+ msg/sec target
    contingency: |
      If performance targets not met:
      1. Accept lower throughput for Phase 1 (100 msg/sec)
      2. Schedule performance optimization for Phase 1.5
      3. Document performance characteristics clearly
    owner: Performance Engineer
    status: OPEN
    created: 2026-01-21
    target_resolution: 2026-01-26 (Day 5)
    
  - id: R005
    type: HIGH
    category: CONCURRENCY
    title: Race Condition in Pending Sends
    description: |
      Concurrent send_message calls to the same dialog may cause state
      corruption in pending_sends HashMap if not properly synchronized.
    impact: |
      Lost messages, duplicate sends, or crashes. Data loss possible.
    probability: 40% (possible)
    exposure: HIGH
    mitigation_strategy: |
      1. Use DashMap for lock-free concurrent access to pending_sends
      2. Add comprehensive concurrency tests (20+ tests)
      3. Use ThreadSanitizer to detect data races
      4. Implement atomic state transitions
      5. Add logging for all state changes
    contingency: |
      If race conditions detected:
      1. Fall back to RwLock (correct but slower)
      2. Add mutex to serialize sends per dialog
      3. Document performance trade-off
    owner: Concurrency Specialist
    status: OPEN
    created: 2026-01-21
    target_resolution: 2026-01-24 (Day 3)
    
  # ========================================================================
  # MEDIUM RISKS
  # ========================================================================
  
  - id: R006
    type: MEDIUM
    category: LOGIC
    title: Message Deduplication Failures
    description: |
      Duplicate messages may arrive from MTProto (network retries, reconnections).
      Deduplication cache may miss duplicates if cache key is incorrect.
    impact: |
      Users see duplicate messages. Conversation history has repeats.
      Annoying but not data-corrupting.
    probability: 50% (moderate)
    exposure: MEDIUM
    mitigation_strategy: |
      1. Use MessageFullId (dialog_id + message_id) as dedup key
      2. Implement time-based cache expiry (1 hour TTL)
      3. Add DashMap for lock-free dedup lookups
      4. Add unit tests for duplicate detection
      5. Log duplicate rate for monitoring
    contingency: |
      If dedup fails:
      1. Add UI "hide duplicates" filter
      2. Implement manual dedup tool
      3. Accept minor duplicates in Phase 1
    owner: Backend Engineer
    status: OPEN
    created: 2026-01-21
    target_resolution: 2026-01-25 (Day 4)
    
  - id: R007
    type: MEDIUM
    category: STORAGE
    title: MessageDb Transaction Rollback
    description: |
      MessageDb doesn't support transactions (stub implementation).
      Partial writes (power failure, crash) may corrupt database.
    impact: |
      Lost messages, corrupted indexes, requires database rebuild.
      Data loss risk.
    probability: 30% (low)
    exposure: MEDIUM
    mitigation_strategy: |
      1. Implement begin/commit/rollback transaction API
      2. Use write-ahead log (WAL) for durability
      3. Add database integrity checks on startup
      4. Implement backup/restore mechanism
      5. Add unit tests for transaction rollback
    contingency: |
      If transactions prove too complex:
      1. Use RocksDB (has built-in transactions)
      2. Accept data loss risk for Phase 1 (document it)
      3. Schedule transactions for Phase 1.5
    owner: Storage Engineer
    status: OPEN
    created: 2026-01-21
    target_resolution: 2026-01-27 (Day 6)
    
  - id: R008
    type: MEDIUM
    category: INTEGRATION
    title: Network Layer Incompatibility
    description: |
      rustgram_net API may not match expected interface for send/receive
      operations. NetworkClient may lack required methods.
    impact: |
      Cannot send/receive messages. Integration blocked.
      Requires NetworkClient enhancement.
    probability: 35% (possible)
    exposure: MEDIUM
    mitigation_strategy: |
      1. Review rustgram_net API before implementation (Day 1)
      2. Create integration tests for NetworkClient
      3. Implement adapter if API mismatch
      4. Add NetQuery construction helpers
      5. Document required NetworkClient interface
    contingency: |
      If NetworkClient incompatible:
      1. Extend rustgram_net with required methods
      2. Create compatibility layer (adapter pattern)
      3. Schedule rustgram-net enhancement epic
    owner: Integration Engineer
    status: OPEN
    created: 2026-01-21
    target_resolution: 2026-01-23 (Day 2)
    
  - id: R009
    type: MEDIUM
    category: LOGIC
    title: Memory Leak in Message Cache
    description: |
      MessageDb may cache all messages in memory without bounds.
      Long-running client may consume unbounded memory.
    impact: |
      Out-of-memory crashes. Performance degradation.
      Requires client restart.
    probability: 40% (possible)
    exposure: MEDIUM
    mitigation_strategy: |
      1. Implement LRU cache with size limit (10,000 messages)
      2. Use weak references for message data
      3. Add memory profiling tests (valgrind)
      4. Monitor memory usage in benchmarks
      5. Document cache eviction policy
    contingency: |
      If memory leaks persist:
      1. Reduce cache size to 1,000 messages
      2. Implement periodic cache clearing
      3. Add memory usage warnings to logs
    owner: Performance Engineer
    status: OPEN
    created: 2026-01-21
    target_resolution: 2026-01-26 (Day 5)
    
  # ========================================================================
  # LOW RISKS
  # ========================================================================
  
  - id: R010
    type: LOW
    category: TESTING
    title: Test Data Management Overhead
    description: |
      Creating realistic test messages, dialogs, and updates requires
      significant test fixture code. May slow development.
    impact: |
      Slower test development. Some tests may use unrealistic data.
      Reduced test coverage quality.
    probability: 70% (likely)
    exposure: LOW
    mitigation_strategy: |
      1. Create test fixture generators (proptest strategies)
      2. Use test database with pre-seeded data
      3. Implement mock NetworkClient for unit tests
      4. Create reusable test helpers
      5. Document test data requirements
    contingency: |
      If test data overhead too high:
      1. Accept simpler test fixtures
      2. Focus on happy path tests first
      3. Add edge case tests in Phase 1.5
    owner: Test Engineer
    status: MITIGATED
    created: 2026-01-21
    target_resolution: N/A
    
  - id: R011
    type: LOW
    category: DOCUMENTATION
    title: TDLib Alignment Documentation Gap
    description: |
      Complex mapping between rustgram implementation and TDLib reference
      may not be fully documented. Future maintainers may be confused.
    impact: |
      Slower onboarding for new developers.
      Potential misalignment in future updates.
    probability: 60% (possible)
    exposure: LOW
    mitigation_strategy: |
      1. Add TDLib alignment comments to all public APIs
      2. Create mapping table in docs/
      3. Document all simplifications from TDLib
      4. Add examples showing TDLib vs rustgram differences
      5. Keep TL schema references in comments
    contingency: |
      If documentation falls behind:
      1. Accept technical debt
      2. Schedule documentation sprint for Phase 1.5
      3. Require docs in code review checklist
    owner: Tech Writer
    status: MITIGATED
    created: 2026-01-21
    target_resolution: N/A
    
  - id: R012
    type: LOW
    category: API
    title: Breaking Changes in Future Phases
    description: |
      Phase 1 API design may not accommodate future requirements
      (media, editing, threads). May require breaking changes.
    impact: |
      API changes between phases. Users must update code.
      Migration documentation required.
    probability: 50% (moderate)
    exposure: LOW
    mitigation_strategy: |
      1. Design Message struct with extensibility (Vec<ExtraData>)
      2. Use trait objects for future content types
      3. Document which APIs are stable vs experimental
      4. Add deprecation warnings before breaking changes
      5. Keep API version in Cargo.toml
    contingency: |
      If breaking changes required:
      1. Maintain compatibility shim for 1 minor version
      2. Provide migration guide
      3. Communicate early and clearly
    owner: API Designer
    status: MITIGATED
    created: 2026-01-21
    target_resolution: N/A

# ============================================================================
# RISK SUMMARY
# ============================================================================

summary:
  total_risks: 12
  by_status:
    OPEN: 9
    MITIGATED: 3
    BLOCKER: 0
    CLOSED: 0
    
  by_type:
    BLOCKER: 2
    HIGH: 3
    MEDIUM: 4
    LOW: 3
    
  by_category:
    ARCHITECTURE: 1
    INTEGRATION: 2
    LOGIC: 3
    PERFORMANCE: 2
    CONCURRENCY: 1
    STORAGE: 1
    TESTING: 1
    DOCUMENTATION: 1
    
  exposure_breakdown:
    critical: 2  # BLOCKER
    high: 3      # HIGH
    medium: 4    # MEDIUM
    low: 3       # LOW
    
  top_priority:
    - R001  # Message type missing (BLOCKER)
    - R002  # TL schema misalignment (BLOCKER)
    - R003  # Message ordering (HIGH)
    - R004  # Database performance (HIGH)
    - R005  # Race conditions (HIGH)

# ============================================================================
# MITIGATION TIMELINE
# ============================================================================

timeline:
  week1:
    days:
      - day: 1
        date: 2026-01-22
        risks:
          - id: R001
            action: Create Message type
            status: IN_PROGRESS
          - id: R008
            action: Review NetworkClient API
            status: IN_PROGRESS
            
      - day: 2
        date: 2026-01-23
        risks:
          - id: R002
            action: Create TL schema stubs
            status: IN_PROGRESS
          - id: R008
            action: Complete NetworkClient review
            target_status: MITIGATED
            
      - day: 3
        date: 2026-01-24
        risks:
          - id: R005
            action: Implement concurrent pending sends
            status: IN_PROGRESS
            
      - day: 4
        date: 2026-01-25
        risks:
          - id: R003
            action: Implement message ordering
            status: IN_PROGRESS
          - id: R006
            action: Implement deduplication
            status: IN_PROGRESS
            
      - day: 5
        date: 2026-01-26
        risks:
          - id: R004
            action: Profile MessageDb performance
            status: IN_PROGRESS
          - id: R009
            action: Implement message cache limits
            status: IN_PROGRESS
            
  week2:
    days:
      - day: 6
        date: 2026-01-27
        risks:
          - id: R007
            action: Implement MessageDb transactions
            status: IN_PROGRESS

# ============================================================================
# RISK REVIEWS
# ============================================================================

review_schedule:
  frequency: Daily
  participants:
    - Senior Rust Developer (risk owner)
    - Tech Lead
    - Product Manager
    
  agenda:
    - Review new risks
    - Update existing risk status
    - Verify mitigation progress
    - Adjust timelines if needed
    
  escalation:
    - If BLOCKER risk not resolved in 2 days → Escalate to CTO
    - If HIGH risk not mitigated in 5 days → Escalate to VP Engineering
    - If MEDIUM risk not mitigated in 10 days → Add to retrospective

# ============================================================================
# SUCCESS CRITERIA
# ============================================================================

success_criteria:
  all_blockers_resolved: true
  all_high_mitigated: true
  all_medium_monitored: true
  all_low_accepted: true
  
  specific:
    - criterion: "Zero BLOCKER risks at implementation start"
      threshold: 0 OPEN BLOCKER risks
      
    - criterion: "All HIGH risks have mitigation plans"
      threshold: 100% of HIGH risks with status=MITIGATED
      
    - criterion: "RISK owner assigned for all OPEN risks"
      threshold: 100% of OPEN risks have owner
      
    - criterion: "Target resolution dates set"
      threshold: 100% of OPEN risks have target_resolution

# ============================================================================
# CONTINGENCY PLANS
# ============================================================================

contingency_plans:
  plan_a: |
    All risks mitigated as planned. Implementation proceeds on schedule.
    Timeline: 11-15 days
    
  plan_b: |
    1 BLOCKER risk requires 2 extra days. Implementation slightly delayed.
    Timeline: 13-17 days
    Trigger: Any BLOCKER not resolved by Day 2
    
  plan_c: |
    2+ BLOCKER risks or 3+ HIGH risks require redesign.
    Epic split into phases.
    Timeline: 20-25 days for complete implementation
    Trigger: BLOCKER not resolved by Day 3
    
  plan_d: |
    Fundamental architecture issue discovered.
    Epic paused, new architecture proposed.
    Timeline: TBD (requires architecture review)
    Trigger: Mitigation strategies fail completely

# ============================================================================
# MONITORING
# ============================================================================

monitoring:
  metrics:
    - metric: "Open risk count"
      threshold: "<5 OPEN risks"
      frequency: Daily
      
    - metric: "BLOCKER risk age"
      threshold: "<2 days"
      frequency: Daily
      
    - metric: "HIGH risk mitigation progress"
      threshold: "100% have plans"
      frequency: Daily
      
    - metric: "Risk resolution rate"
      threshold: ">2 risks/day"
      frequency: Weekly
      
  alerts:
    - condition: "BLOCKER risk open >2 days"
      action: "Escalate to CTO"
      
    - condition: "HIGH risk open >5 days"
      action: "Escalate to VP Engineering"
      
    - condition: ">10 OPEN risks total"
      action: "Schedule risk review meeting"

# ============================================================================
# LESSONS LEARNED
# ============================================================================

lessons_learned:
  - lesson: "TL schema types should be created early"
    context: "R002 - TL Schema Type Misalignment"
    action: "Always create TL stubs in Phase 2, not Phase 3"
    
  - lesson: "Concurrency risks require testing infrastructure"
    context: "R005 - Race Condition in Pending Sends"
    action: "Set up ThreadSanitizer in CI from Day 1"
    
  - lesson: "Performance profiling should happen early"
    context: "R004 - Database Write Bottleneck"
    action: "Benchmark all database operations before integration"

# ============================================================================
# APPENDIX: RISK SCORING MATRIX
# ============================================================================

risk_scoring:
  methodology: |
    Risk Score = Probability × Impact
    
    Probability:
      - 90-100%: Certain (BLOCKER)
      - 60-89%: Likely (HIGH)
      - 40-59%: Possible (MEDIUM)
      - 10-39%: Unlikely (LOW)
      - 0-9%: Rare (ACCEPT)
      
    Impact:
      - BLOCKER: Cannot implement feature
      - HIGH: Significant redesign required
      - MEDIUM: Workaround possible, impact to quality
      - LOW: Minor inconvenience
      
  scoring_matrix:
    | Probability | Impact | Risk Type | Example |
    |-------------|--------|-----------|---------|
    | 100% | BLOCKER | BLOCKER | Message type missing |
    | 90% | BLOCKER | BLOCKER | TL schema misalignment |
    | 60% | HIGH | HIGH | Message ordering issues |
    | 50% | HIGH | HIGH | Database bottleneck |
    | 50% | MEDIUM | MEDIUM | Deduplication failures |
    | 40% | HIGH | HIGH | Race conditions |
    | 40% | MEDIUM | MEDIUM | Memory leaks |
    | 70% | LOW | LOW | Test data overhead |
