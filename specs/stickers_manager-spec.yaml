# StickersManager Module Specification

## Module Information
module: stickers_manager
crate: rustgram-stickers-manager
type: Manager
complexity: CRITICAL
tdlib_reference: references/td/td/telegram/StickersManager.h
epic: 21

## Overview
StickersManager is the most complex manager in TDLib, responsible for all sticker-related operations including:
- Sticker set management (installed, archived, featured)
- Sticker search and discovery
- Custom emoji handling
- Animated emoji interactions
- Sticker upload and creation
- Recent and favorite stickers
- Emoji search and suggestions

## Public API Methods

### Sticker Information
- **get_sticker_type**
  - TDLib: `get_sticker_type(FileId file_id) const`
  - Rust: `pub fn get_sticker_type(&self, file_id: FileId) -> StickerType`
  - Description: Get the type of sticker (Regular, Mask, CustomEmoji)
  - Dependencies: FileId, StickerType ✅

- **get_sticker_format**
  - TDLib: `get_sticker_format(FileId file_id) const`
  - Rust: `pub fn get_sticker_format(&self, file_id: FileId) -> StickerFormat`
  - Description: Get the format of sticker (Webp, Tgs, Webm)
  - Dependencies: FileId, StickerFormat ✅

- **get_sticker_id**
  - TDLib: `get_sticker_id(FileId sticker_id) const`
  - Rust: `pub fn get_sticker_id(&self, sticker_id: FileId) -> i64`
  - Description: Get the sticker ID from FileId
  - Dependencies: FileId

### Sticker Search
- **get_stickers**
  - TDLib: `get_stickers(StickerType sticker_type, string query, int32 limit, DialogId dialog_id, bool force, Promise<Unit> promise)`
  - Rust: `pub fn get_stickers(&self, sticker_type: StickerType, query: String, limit: i32, dialog_id: DialogId, force: bool) -> impl Future<Output = Result<Vec<FileId>, Error>>`
  - Description: Search for stickers by emoji/keyword
  - Dependencies: StickerType ✅, DialogId ✅

- **search_stickers**
  - TDLib: `search_stickers(StickerType sticker_type, string emoji, const string &query, const vector<string> &input_language_codes, int32 offset, int32 limit, Promise<td_api::object_ptr<td_api::stickers>> promise)`
  - Rust: `pub fn search_stickers(&self, sticker_type: StickerType, emoji: String, query: String, language_codes: Vec<String>, offset: i32, limit: i32) -> impl Future<Output = Result<Stickers, Error>>`
  - Description: Search stickers with language context
  - Dependencies: StickerType ✅

- **get_premium_stickers**
  - TDLib: `get_premium_stickers(int32 limit, Promise<td_api::object_ptr<td_api::stickers>> promise)`
  - Rust: `pub fn get_premium_stickers(&self, limit: i32) -> impl Future<Output = Result<Stickers, Error>>`
  - Description: Get premium sticker suggestions
  - Dependencies: Stickers type

### Sticker Sets
- **get_installed_sticker_sets**
  - TDLib: `get_installed_sticker_sets(StickerType sticker_type, Promise<Unit> promise)`
  - Rust: `pub fn get_installed_sticker_sets(&self, sticker_type: StickerType) -> impl Future<Output = Result<Vec<StickerSetId>, Error>>`
  - Description: Get list of installed sticker sets
  - Dependencies: StickerType ✅, StickerSetId

- **search_sticker_sets**
  - TDLib: `search_sticker_sets(StickerType sticker_type, const string &query, Promise<Unit> promise)`
  - Rust: `pub fn search_sticker_sets(&self, sticker_type: StickerType, query: String) -> impl Future<Output = Result<Vec<StickerSetId>, Error>>`
  - Description: Search for sticker sets by name
  - Dependencies: StickerType ✅

- **get_archived_sticker_sets**
  - TDLib: `get_archived_sticker_sets(StickerType sticker_type, StickerSetId offset_sticker_set_id, int32 limit, bool force, Promise<Unit> promise)`
  - Rust: `pub fn get_archived_sticker_sets(&self, sticker_type: StickerType, offset: StickerSetId, limit: i32, force: bool) -> impl Future<Output = Result<(i32, Vec<StickerSetId>), Error>>`
  - Description: Get archived sticker sets with pagination
  - Dependencies: StickerType ✅, StickerSetId

- **get_featured_sticker_sets**
  - TDLib: `get_featured_sticker_sets(StickerType sticker_type, int32 offset, int32 limit, Promise<Unit> promise)`
  - Rust: `pub fn get_featured_sticker_sets(&self, sticker_type: StickerType, offset: i32, limit: i32) -> impl Future<Output = Result<TrendingStickerSets, Error>>`
  - Description: Get trending/featured sticker sets
  - Dependencies: StickerType ✅

- **change_sticker_set**
  - TDLib: `change_sticker_set(StickerSetId set_id, bool is_installed, bool is_archived, Promise<Unit> promise)`
  - Rust: `pub fn change_sticker_set(&self, set_id: StickerSetId, is_installed: bool, is_archived: bool) -> impl Future<Output = Result<(), Error>>`
  - Description: Install/uninstall/archive a sticker set
  - Dependencies: StickerSetId

- **view_featured_sticker_sets**
  - TDLib: `view_featured_sticker_sets(const vector<StickerSetId> &sticker_set_ids)`
  - Rust: `pub fn view_featured_sticker_sets(&self, sticker_set_ids: Vec<StickerSetId>)`
  - Description: Mark featured sticker sets as viewed
  - Dependencies: StickerSetId

### Custom Emoji
- **get_custom_emoji_stickers**
  - TDLib: `get_custom_emoji_stickers(vector<CustomEmojiId> custom_emoji_ids, bool use_database, Promise<td_api::object_ptr<td_api::stickers>> promise)`
  - Rust: `pub fn get_custom_emoji_stickers(&self, custom_emoji_ids: Vec<CustomEmojiId>, use_database: bool) -> impl Future<Output = Result<Stickers, Error>>`
  - Description: Get custom emoji stickers by IDs
  - Dependencies: CustomEmojiId ✅

- **is_premium_custom_emoji**
  - TDLib: `is_premium_custom_emoji(CustomEmojiId custom_emoji_id, bool default_result) const`
  - Rust: `pub fn is_premium_custom_emoji(&self, custom_emoji_id: CustomEmojiId) -> bool`
  - Description: Check if custom emoji is premium-only
  - Dependencies: CustomEmojiId ✅

- **get_default_custom_emoji_stickers**
  - TDLib: `get_default_custom_emoji_stickers(StickerListType sticker_list_type, bool force_reload, Promise<td_api::object_ptr<td_api::stickers>> promise)`
  - Rust: `pub fn get_default_custom_emoji_stickers(&self, sticker_list_type: StickerListType, force_reload: bool) -> impl Future<Output = Result<Stickers, Error>>`
  - Description: Get default custom emoji stickers for a context
  - Dependencies: StickerListType ✅

### Animated Emoji
- **get_animated_emoji**
  - TDLib: `get_animated_emoji(string emoji, bool is_recursive, Promise<td_api::object_ptr<td_api::animatedEmoji>> promise)`
  - Rust: `pub fn get_animated_emoji(&self, emoji: String, is_recursive: bool) -> impl Future<Output = Result<AnimatedEmoji, Error>>`
  - Description: Get animated emoji for a text emoji
  - Dependencies: AnimatedEmoji type

- **get_animated_emoji_click_sticker**
  - TDLib: `get_animated_emoji_click_sticker(const string &message_text, MessageFullId message_full_id, Promise<td_api::object_ptr<td_api::sticker>> promise)`
  - Rust: `pub fn get_animated_emoji_click_sticker(&self, message_text: String, message_full_id: MessageFullId) -> impl Future<Output = Result<Sticker, Error>>`
  - Description: Get animated emoji for click interaction
  - Dependencies: MessageFullId ✅

- **on_send_animated_emoji_clicks**
  - TDLib: `on_send_animated_emoji_clicks(DialogId dialog_id, const string &emoji)`
  - Rust: `pub fn on_send_animated_emoji_clicks(&self, dialog_id: DialogId, emoji: String)`
  - Description: Track animated emoji clicks
  - Dependencies: DialogId ✅

### Recent & Favorite Stickers
- **get_recent_stickers**
  - TDLib: `get_recent_stickers(bool is_attached, Promise<Unit> promise)`
  - Rust: `pub fn get_recent_stickers(&self, is_attached: bool) -> impl Future<Output = Result<Vec<FileId>, Error>>`
  - Description: Get recent stickers
  - Dependencies: FileId ✅

- **add_recent_sticker**
  - TDLib: `add_recent_sticker(bool is_attached, const td_api::object_ptr<td_api::InputFile> &input_file, Promise<Unit> promise)`
  - Rust: `pub fn add_recent_sticker(&self, is_attached: bool, input_file: InputFile) -> impl Future<Output = Result<(), Error>>`
  - Description: Add sticker to recent
  - Dependencies: InputFile type

- **remove_recent_sticker**
  - TDLib: `remove_recent_sticker(bool is_attached, const td_api::object_ptr<td_api::InputFile> &input_file, Promise<Unit> promise)`
  - Rust: `pub fn remove_recent_sticker(&self, is_attached: bool, input_file: InputFile) -> impl Future<Output = Result<(), Error>>`
  - Description: Remove sticker from recent
  - Dependencies: InputFile type

- **get_favorite_stickers**
  - TDLib: `get_favorite_stickers(Promise<Unit> promise)`
  - Rust: `pub fn get_favorite_stickers(&self) -> impl Future<Output = Result<Vec<FileId>, Error>>`
  - Description: Get favorite stickers
  - Dependencies: FileId ✅

- **add_favorite_sticker**
  - TDLib: `add_favorite_sticker(const td_api::object_ptr<td_api::InputFile> &input_file, Promise<Unit> promise)`
  - Rust: `pub fn add_favorite_sticker(&self, input_file: InputFile) -> impl Future<Output = Result<(), Error>>`
  - Description: Add sticker to favorites
  - Dependencies: InputFile type

- **remove_favorite_sticker**
  - TDLib: `remove_favorite_sticker(const td_api::object_ptr<td_api::InputFile> &input_file, Promise<Unit> promise)`
  - Rust: `pub fn remove_favorite_sticker(&self, input_file: InputFile) -> impl Future<Output = Result<(), Error>>`
  - Description: Remove sticker from favorites
  - Dependencies: InputFile type

### Sticker Set Management
- **create_new_sticker_set**
  - TDLib: `create_new_sticker_set(UserId user_id, string title, string short_name, StickerType sticker_type, bool has_text_color, vector<td_api::object_ptr<td_api::inputSticker>> stickers, string software, Promise<td_api::object_ptr<td_api::stickerSet>> promise)`
  - Rust: `pub fn create_new_sticker_set(&self, user_id: UserId, title: String, short_name: String, sticker_type: StickerType, has_text_color: bool, stickers: Vec<InputSticker>, software: String) -> impl Future<Output = Result<StickerSet, Error>>`
  - Description: Create a new sticker set
  - Dependencies: UserId, StickerType ✅, InputSticker, StickerSet

- **add_sticker_to_set**
  - TDLib: `add_sticker_to_set(UserId user_id, string short_name, td_api::object_ptr<td_api::inputSticker> sticker, td_api::object_ptr<td_api::InputFile> old_sticker, Promise<Unit> promise)`
  - Rust: `pub fn add_sticker_to_set(&self, user_id: UserId, short_name: String, sticker: InputSticker, old_sticker: InputFile) -> impl Future<Output = Result<(), Error>>`
  - Description: Add sticker to existing set
  - Dependencies: UserId, InputSticker, InputFile

- **set_sticker_set_thumbnail**
  - TDLib: `set_sticker_set_thumbnail(UserId user_id, string short_name, td_api::object_ptr<td_api::InputFile> thumbnail, StickerFormat format, Promise<Unit> promise)`
  - Rust: `pub fn set_sticker_set_thumbnail(&self, user_id: UserId, short_name: String, thumbnail: InputFile, format: StickerFormat) -> impl Future<Output = Result<(), Error>>`
  - Description: Set sticker set thumbnail
  - Dependencies: UserId, InputFile, StickerFormat ✅

- **set_sticker_set_title**
  - TDLib: `set_sticker_set_title(string short_name, string title, Promise<Unit> promise)`
  - Rust: `pub fn set_sticker_set_title(&self, short_name: String, title: String) -> impl Future<Output = Result<(), Error>>`
  - Description: Change sticker set title

- **delete_sticker_set**
  - TDLib: `delete_sticker_set(string short_name, Promise<Unit> promise)`
  - Rust: `pub fn delete_sticker_set(&self, short_name: String) -> impl Future<Output = Result<(), Error>>`
  - Description: Delete a sticker set

### Emoji Search
- **search_emojis**
  - TDLib: `search_emojis(const string &text, const vector<string> &input_language_codes, bool force, Promise<Unit> promise)`
  - Rust: `pub fn search_emojis(&self, text: String, language_codes: Vec<String>, force: bool) -> impl Future<Output = Result<Vec<(String, String)>, Error>>`
  - Description: Search for emojis by keyword
  - Dependencies: Returns (emoji, keyword) pairs

- **get_keyword_emojis**
  - TDLib: `get_keyword_emojis(const string &text, const vector<string> &input_language_codes, bool force, Promise<Unit> promise)`
  - Rust: `pub fn get_keyword_emojis(&self, text: String, language_codes: Vec<String>, force: bool) -> impl Future<Output = Result<Vec<String>, Error>>`
  - Description: Get emojis for a keyword

- **get_emoji_groups**
  - TDLib: `get_emoji_groups(EmojiGroupType group_type, Promise<td_api::object_ptr<td_api::emojiCategories>> promise)`
  - Rust: `pub fn get_emoji_groups(&self, group_type: EmojiGroupType) -> impl Future<Output = Result<EmojiCategories, Error>>`
  - Description: Get emoji groups/categories
  - Dependencies: EmojiGroupType

### Sticker Operations
- **set_sticker_position_in_set**
  - TDLib: `set_sticker_position_in_set(const td_api::object_ptr<td_api::InputFile> &sticker, int32 position, Promise<Unit> promise)`
  - Rust: `pub fn set_sticker_position_in_set(&self, sticker: InputFile, position: i32) -> impl Future<Output = Result<(), Error>>`
  - Description: Change sticker position in set
  - Dependencies: InputFile

- **remove_sticker_from_set**
  - TDLib: `remove_sticker_from_set(const td_api::object_ptr<td_api::InputFile> &sticker, Promise<Unit> promise)`
  - Rust: `pub fn remove_sticker_from_set(&self, sticker: InputFile) -> impl Future<Output = Result<(), Error>>`
  - Description: Remove sticker from set
  - Dependencies: InputFile

- **set_sticker_emojis**
  - TDLib: `set_sticker_emojis(const td_api::object_ptr<td_api::InputFile> &sticker, const string &emojis, Promise<Unit> promise)`
  - Rust: `pub fn set_sticker_emojis(&self, sticker: InputFile, emojis: String) -> impl Future<Output = Result<(), Error>>`
  - Description: Change sticker emojis
  - Dependencies: InputFile

- **set_sticker_keywords**
  - TDLib: `set_sticker_keywords(const td_api::object_ptr<td_api::InputFile> &sticker, vector<string> keywords, Promise<Unit> promise)`
  - Rust: `pub fn set_sticker_keywords(&self, sticker: InputFile, keywords: Vec<String>) -> impl Future<Output = Result<(), Error>>`
  - Description: Change sticker keywords
  - Dependencies: InputFile

- **set_sticker_mask_position**
  - TDLib: `set_sticker_mask_position(const td_api::object_ptr<td_api::InputFile> &sticker, td_api::object_ptr<td_api::maskPosition> mask_position, Promise<Unit> promise)`
  - Rust: `pub fn set_sticker_mask_position(&self, sticker: InputFile, mask_position: MaskPosition) -> impl Future<Output = Result<(), Error>>`
  - Description: Change sticker mask position
  - Dependencies: InputFile, MaskPosition

## Required Types

### Existing Types (Verified)
- **FileId** - `rustgram-file-id` - Constructor: `default()`, `from(i64)` ✅
- **DialogId** - `rustgram-dialog-id` - Constructor: `default()`, `from(i64)` ✅
- **StickerType** - `rustgram-sticker-type` - Constructor: `from_i32(i32)` ✅
- **StickerFormat** - `rustgram-sticker-format` - Constructor: `from_i32(i32)` ✅
- **StickerListType** - `rustgram-sticker-list-type` - Constructor: `from_i32(i32)` ✅
- **MessageFullId** - `rustgram-message-full-id` - Constructor: `new(MessageId, DialogId)` ✅
- **CustomEmojiId** - `rustgram-custom-emoji-id` - Constructor: `default()`, `from(i64)` ✅
- **StickerSetId** - `rustgram-sticker-set-id` - Constructor: Need to verify ⚠️

### Types Need Verification
- **UserId** - Need to verify if exists or use DialogId variant
- **StickerMaskPosition** - Need to verify if exists (used for mask stickers)
- **SpecialStickerSetType** - Need to verify if exists (dice, animated emoji, etc.)
- **EmojiGroupType** - Need to verify if exists

### New Types (Requires Implementation)

#### Core Sticker Types
- **Sticker** - Individual sticker data
  - Fields: set_id, alt, dimensions, minithumbnail, thumbnail, format, type, is_premium, mask_position
  - Source: TDLib internal Sticker class

- **StickerSet** - Sticker set information
  - Fields: id, access_hash, title, short_name, sticker_type, sticker_count, hash, thumbnail, sticker_ids, is_installed, is_archived, is_official, is_viewed
  - Source: TDLib internal StickerSet class

- **InputSticker** - Input for creating/uploading stickers
  - Fields: sticker (InputFile), emoji, keywords, mask_position
  - Source: TDLib td_api::inputSticker

- **InputFile** - Input file reference
  - Fields: id, parts, name, md5_hash
  - Source: TDLib td_api::inputFile

#### Result Types
- **Stickers** - List of stickers result
  - Fields: stickers (Vec<Sticker>)
  - Source: TDLib td_api::stickers

- **AnimatedEmoji** - Animated emoji data
  - Fields: sticker, sound_sticker
  - Source: TDLib td_api::animatedEmoji

- **TrendingStickerSets** - Trending sticker sets
  - Fields: sets (Vec<StickerSetInfo>), total_count
  - Source: TDLib td_api::trendingStickerSets

- **StickerSetInfo** - Sticker set summary (for lists)
  - Fields: id, title, short_name, thumbnail, is_installed, is_archived, is_official, sticker_count
  - Source: TDLib td_api::stickerSetInfo

- **EmojiCategories** - Emoji groups/categories
  - Fields: categories (Vec<EmojiCategory>)
  - Source: TDLib td_api::emojiCategories

- **MaskPosition** - Mask sticker position
  - Fields: point, x_shift, y_shift, scale
  - Source: TDLib td_api::maskPosition

#### Revenue Types (if applicable)
- **StarAmount** - Stars currency amount (likely exists)
- **StarGift** - Star gift information (likely exists)

## Dependencies

### External Crates
- **rustgram-file-id** - For FileId type
- **rustgram-dialog-id** - For DialogId type
- **rustgram-sticker-type** - For StickerType enum ✅
- **rustgram-sticker-format** - For StickerFormat enum ✅
- **rustgram-sticker-list-type** - For StickerListType enum ✅
- **rustgram-custom-emoji-id** - For CustomEmojiId type ✅
- **rustgram-sticker-set-id** - For StickerSetId (verify)
- **rustgram-message-full-id** - For MessageFullId ✅
- **rustgram-dimensions** - For Dimensions type (verify)
- **rustgram-types** - For common types
- **tokio** - For async runtime (features: ["sync", "rt", "macros", "fs"])
- **serde** - For serialization (features: ["derive"])
- **async-trait** - For async trait support
- **thiserror** - For error handling
- **tracing** - For logging
- **dashmap** - For concurrent hashmap (WaitFreeHashMap alternative)
- **lru** - For LRU cache

### Internal Data Structures
- **WaitFreeHashMap** - TDLib's lock-free map (use dashmap::DashMap)
- **FlatHashMap** - TDLib's optimized hashmap (use std::collections::HashMap or fxhash)
- **Hints** - TDLib's search hints (use lru::LruCache or custom)

## Error Types

### StickersManagerError
```rust
pub enum StickersManagerError {
    /// Sticker set not found
    StickerSetNotFound,
    /// Invalid sticker format
    InvalidStickerFormat,
    /// Sticker file too large
    StickerFileTooLarge,
    /// Network error
    NetworkError(String),
    /// Rate limited
    RateLimited,
    /// Invalid sticker set name
    InvalidStickerSetName(CheckStickerSetNameResult),
    /// Sticker set name occupied
    StickerSetNameOccupied,
    /// Upload error
    UploadError(String),
    /// Internal error
    Internal(String),
}

pub enum CheckStickerSetNameResult {
    Ok,
    Invalid,
    Occupied,
}
```

## TDLib Alignment Notes

### State Management Complexity
TDLib's StickersManager is the most complex manager with extensive state:

1. **Multiple Caches**:
   - stickers_: WaitFreeHashMap<FileId, Sticker>
   - sticker_sets_: WaitFreeHashMap<StickerSetId, StickerSet>
   - short_name_to_sticker_set_id_: HashMap<String, StickerSetId>
   - installed_sticker_set_ids_: Vec<StickerSetId>[MAX_STICKER_TYPE]
   - featured_sticker_set_ids_: Vec<StickerSetId>[MAX_STICKER_TYPE]
   - recent_sticker_ids_: Vec<FileId>[2]
   - favorite_sticker_ids_: Vec<FileId>
   - found_stickers_: HashMap<String, FoundStickers>[MAX_STICKER_TYPE]
   - custom_emoji_to_sticker_id_: HashMap<CustomEmojiId, FileId>

2. **Loading State**:
   - Multiple load request queues
   - Reload scheduling with delays
   - Hash-based cache invalidation
   - Pending query tracking

3. **Special Sticker Sets**:
   - Dice stickers (animated)
   - Premium gift stickers
   - Animated emojis
   - TON gift stickers

### Constants from TDLib
```rust
const GREAT_MINDS_SET_ID: i64 = 1842540969984001;
const MAX_FOUND_STICKERS: i32 = 100;
const MAX_STICKER_SET_TITLE_LENGTH: usize = 64;
const MAX_STICKER_SET_SHORT_NAME_LENGTH: usize = 64;
const MAX_GET_CUSTOM_EMOJI_STICKERS: usize = 200;
const EMOJI_KEYWORDS_UPDATE_DELAY: i32 = 3600;
const MIN_ANIMATED_EMOJI_CLICK_DELAY: f64 = 0.2;
```

### StickerSet Loading Strategy
- **Two-phase loading**: Load basic info first, then full details
- **Database persistence**: Save loaded sets to database
- **Cache invalidation**: Hash-based cache validation
- **Background reload**: Periodic reload of installed/featured sets

### Emoji Search Complexity
- **Language-specific**: Different keywords per language code
- **Caching**: Cache emoji keywords with TTL
- **Incremental updates**: Load keyword differences periodically
- **Context-aware**: Different results based on message context

### Animated Emoji Interactions
- **Click debouncing**: Minimum delay between clicks (0.2s)
- **Message tracking**: Track which messages use which emoji
- **Sound effects**: Associated sound file IDs
- **Multi-emoji messages**: Track all emojis in a message

### Thread Safety
- **WaitFreeHashMap**: TDLib uses lock-free data structures for performance
- **Actor model**: All operations go through actor mailbox
- **Rust equivalent**: Use `tokio::sync::Mutex` + `Arc` or `dashmap::DashMap`

### File Management Integration
- **FileSourceId**: Track file dependencies
- **FileUploadId**: Track upload progress
- **Thumbnail management**: Separate thumbnail file IDs
- **Premium animations**: Additional premium animation files

## Testing Requirements
- **Unit Tests**: Mock TDlib client, test each operation
- **Integration Tests**: Test against TDLib mock server
- **Cache Tests**: Verify all cache behaviors
- **Emoji Search Tests**: Test language-specific search
- **Animated Emoji Tests**: Test click debouncing, sound loading
- **Concurrent Access Tests**: Thread safety verification
- **Target Test Count**: 70-100 tests (CRITICAL complexity manager)

## Implementation Priority

### Phase 1: Core Infrastructure (600 LOC, 30 tests)
1. Error types and Result aliases
2. Core data structures (Sticker, StickerSet stubs)
3. Cache infrastructure (dashmap, LRU)
4. Basic initialization

### Phase 2: Sticker Information (400 LOC, 20 tests)
5. get_sticker_type
6. get_sticker_format
7. get_sticker_id
8. Sticker object construction

### Phase 3: Sticker Sets (800 LOC, 40 tests)
9. get_installed_sticker_sets
10. search_sticker_sets
11. get_archived_sticker_sets
12. get_featured_sticker_sets
13. change_sticker_set
14. StickerSetInfo type

### Phase 4: Sticker Search (600 LOC, 30 tests)
15. get_stickers
16. search_stickers
17. get_premium_stickers
18. FoundStickers caching

### Phase 5: Custom Emoji (600 LOC, 30 tests)
19. get_custom_emoji_stickers
20. is_premium_custom_emoji
21. get_default_custom_emoji_stickers
22. CustomEmojiId mapping

### Phase 6: Recent & Favorite (400 LOC, 20 tests)
23. get_recent_stickers
24. add_recent_sticker
25. remove_recent_sticker
26. get_favorite_stickers
27. add_favorite_sticker
28. remove_favorite_sticker

### Phase 7: Animated Emoji (500 LOC, 25 tests)
29. get_animated_emoji
30. get_animated_emoji_click_sticker
31. on_send_animated_emoji_clicks
32. AnimatedEmoji click debouncing

### Phase 8: Sticker Set Management (800 LOC, 40 tests)
33. create_new_sticker_set
34. add_sticker_to_set
35. set_sticker_set_thumbnail
36. set_sticker_set_title
37. delete_sticker_set
38. Upload handling

### Phase 9: Sticker Operations (400 LOC, 20 tests)
39. set_sticker_position_in_set
40. remove_sticker_from_set
41. set_sticker_emojis
42. set_sticker_keywords
43. set_sticker_mask_position

### Phase 10: Emoji Search (500 LOC, 25 tests)
44. search_emojis
45. get_keyword_emojis
46. get_emoji_groups
47. Language code handling
48. Keyword caching

### Phase 11: Integration & Optimization (400 LOC, 20 tests)
49. Full integration tests
50. Performance optimization
51. Memory management
52. Final polish

## Estimated Metrics
- **Total LOC**: 4000-6000 (CRITICAL complexity - most complex manager)
- **Tests**: 70-100 minimum
- **Complexity**: CRITICAL (most complex manager in TDLib)
- **Dependencies**: 12+ external crates, 15+ new types
- **Cache Layers**: 10+ different caches
- **API Methods**: 50+ public methods
- **Implementation Phases**: 11 phases

## Special Considerations

### Memory Management
- **Large sticker collections**: Can have 1000s of stickers in cache
- **Memory limits**: Implement cache size limits
- **Lazy loading**: Load sticker details on demand
- **Background cleanup**: Periodic cache cleanup

### Performance
- **Search optimization**: Use Hints/LRU for emoji search
- **Concurrent access**: DashMap for high-contention caches
- **Database batching**: Batch database writes
- **Network efficiency**: Minimize API calls with caching

### Compatibility
- **Sticker format versions**: Support old and new formats
- **TDLib versions**: Handle different TDLib API versions
- **Migration**: Support data migration from old formats

### Testing Strategy
- **Mock TDlib**: Comprehensive mock for unit tests
- **Integration server**: TDLib mock server for integration tests
- **Property-based tests**: Test cache invariants
- **Stress tests**: Test with large sticker collections
