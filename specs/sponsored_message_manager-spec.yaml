# Specification: SponsoredMessageManager
module: sponsored_message_manager
crate: rustgram-sponsored-message-manager
tdlib_reference: references/td/td/telegram/SponsoredMessageManager.h
complexity: MEDIUM
module_type: Manager Type (Actor with Caching)
estimated_loc: 1000-1500
estimated_tests: 45-65

description: |
  Manager for sponsored messages and dialogs.

  SponsoredMessageManager handles Telegram's sponsored content:
  - Sponsored messages in chats
  - Sponsored dialogs (channels/chats with ads)
  - Video message advertisements
  - Ad reporting and interaction tracking

  This manager caches sponsored content with timeouts and provides
  API for viewing, clicking, and reporting sponsored content.

types:
  - name: SponsoredMessageManager
    description: |
      Manager for sponsored messages and dialogs.

      Caches sponsored content with automatic expiration,
      handles user interactions with ads, coordinates
      with Telegram's sponsored content API.
    fields:
      - name: td
        type: *mut Td
        description: Pointer to Td for API access
        optional: false
      - name: parent
        type: ActorShared<()>
        description: Parent actor for lifecycle
        optional: false
      - name: dialog_sponsored_messages
        type: FlatHashMap<DialogId, DialogSponsoredMessages>
        description: Cached sponsored messages per dialog
        optional: false
      - name: search_sponsored_dialogs
        type: FlatHashMap<String, SponsoredDialogs>
        description: Cached search results by query
        optional: false
      - name: local_id_to_search_query
        type: FlatHashMap<i64, String>
        description: Map local_id -> search query
        optional: false
      - name: dialog_infos
        type: FlatHashMap<i64, SponsoredContentInfo>
        description: Dialog content info cache
        optional: false
      - name: video_sponsored_ads
        type: FlatHashMap<MessageFullId, VideoSponsoredMessages>
        description: Video ads by message
        optional: false
      - name: local_id_to_message_full_id
        type: FlatHashMap<i64, MessageFullId>
        description: Map local_id -> message for videos
        optional: false
      - name: video_ad_infos
        type: FlatHashMap<i64, SponsoredContentInfo>
        description: Video ad info cache
        optional: false
      - name: current_sponsored_message_id
        type: MessageId
        description: Current sponsored message ID counter
        optional: false
      - name: current_local_id
        type: i64
        description: Current local ID counter
        optional: false
      - name: delete_cached_sponsored_messages_timeout
        type: MultiTimeout
        description: Timeout for message cache deletion
        optional: false
      - name: delete_cached_sponsored_dialogs_timeout
        type: MultiTimeout
        description: Timeout for dialog cache deletion
        optional: false
      - name: delete_cached_sponsored_videos_timeout
        type: MultiTimeout
        description: Timeout for video cache deletion
        optional: false

  # Internal structs
  - name: SponsoredContentInfo
    description: Information about sponsored content
    fields:
      - name: sponsor
        type: String
        description: Sponsor name/URL
        optional: false
      - name: is_bot
        type: bool
        description: Whether sponsor is a bot
        optional: false
      - name: is_recommended
        type: bool
        description: Whether ad is recommended
        optional: false

  - name: SponsoredMessage
    description: Sponsored message data
    fields:
      - name: message_id
        type: MessageId
        description: Message ID
        optional: false
      - name: sponsor
        type: String
        description: Sponsor information
        optional: false
      - name: text
        type: String
        description: Message text
        optional: false
      - name: is_bot
        type: bool
        description: Whether from bot
        optional: false

  - name: DialogSponsoredMessages
    description: Sponsored messages for a dialog
    fields:
      - name: messages
        type: Vec<SponsoredMessage>
        description: List of sponsored messages
        optional: false
      - name: sponsor_info
        type: SponsoredContentInfo
        description: Sponsor information
        optional: false

  - name: SponsoredDialog
    description: Sponsored dialog entry
    fields:
      - name: local_id
        type: i64
        description: Local dialog ID
        optional: false
      - name: dialog_id
        type: DialogId
        description: Dialog ID
        optional: false
      - name: sponsor
        type: String
        description: Sponsor information
        optional: false

  - name: SponsoredDialogs
    description: List of sponsored dialogs
    fields:
      - name: dialogs
        type: Vec<SponsoredDialog>
        description: Sponsored dialogs
        optional: false

  - name: VideoSponsoredMessages
    description: Video sponsored messages
    fields:
      - name: messages
        type: Vec<SponsoredMessage>
        description: Sponsored messages for video
        optional: false
      - name: sponsor_info
        type: SponsoredContentInfo
        description: Sponsor information
        optional: false

external_dependencies:
  # Core types
  - type: DialogId
    crate: rustgram-dialog-id
    constructor: from_user(UserId)
    verified: true

  - type: MessageId
    crate: rustgram-types
    constructor: from_server_id(i32)
    verified: true

  - type: MessageFullId
    crate: rustgram-message-full-id
    constructor: new(MessageId, DialogId)
    verified: true

  # Actor framework
  - type: Actor
    crate: rustgram-actor
    verified: true

  - type: ActorShared
    crate: rustgram-actor
    constructor: new(ActorId<T>)
    verified: true

  # Promise types
  - type: Promise
    crate: rustgram-promise
    constructor: new()
    verified: true

  # Td API
  - type: Td
    crate: rustgram-td
    constructor: new()
    verified: true

  # TL types (need stubs)
  - type: sponsoredMessages
    crate: TL stub
    verified: false
    notes: Create in src/tl.rs

  - type: sponsoredMessage
    crate: TL stub
    verified: false
    notes: Create in src/tl.rs

  - type: advertisementSponsor
    crate: TL stub
    verified: false
    notes: Create in src/tl.rs

  - type: sponsoredChats
    crate: TL stub
    verified: false
    notes: Create in src/tl.rs

  - type: sponsoredChat
    crate: TL stub
    verified: false
    notes: Create in src/tl.rs

  - type: videoMessageAdvertisements
    crate: TL stub
    verified: false
    notes: Create in src/tl.rs

  - type: videoMessageAdvertisement
    crate: TL stub
    verified: false
    notes: Create in src/tl.rs

  - type: ReportSponsoredResult
    crate: TL stub
    verified: false
    notes: Create in src/tl.rs

  - type: messages_SponsoredMessages
    crate: TL stub
    verified: false
    notes: Create in src/tl.rs

  - type: contacts_SponsoredPeers
    crate: TL stub
    verified: false
    notes: Create in src/tl.rs

  # Utilities
  - type: MultiTimeout
    crate: rustgram-multi-timeout
    verified: false
    notes: |
      CRITICAL: MultiTimeout not implemented.
      Need tokio-based timeout manager.
      Stub location: crates/multi_timeout/src/lib.rs

  - type: FlatHashMap
    crate: std/external
    verified: true
    notes: Use rustc_hash::FxHashMap or std::collections::HashMap

  - type: Unit
    crate: std
    verified: true
    notes: Use () directly

constructors:
  - name: new
    description: Creates new SponsoredMessageManager
    parameters:
      - name: td
        type: *mut Td
      - name: parent
        type: ActorShared<()>
    returns: Self

methods (public_api):
  # Dialog messages
  - name: get_dialog_sponsored_messages
    description: Get sponsored messages for dialog
    parameters:
      - name: dialog_id
        type: DialogId
      - name: promise
        type: Promise<sponsoredMessages>
    returns: ()

  - name: view_sponsored_message
    description: Record that user viewed sponsored message
    parameters:
      - name: dialog_id
        type: DialogId
      - name: sponsored_message_id
        type: MessageId
    returns: ()

  - name: click_sponsored_message
    description: Record that user clicked sponsored message
    parameters:
      - name: dialog_id
        type: DialogId
      - name: sponsored_message_id
        type: MessageId
      - name: is_media_click
        type: bool
      - name: from_fullscreen
        type: bool
      - name: promise
        type: Promise<Unit>
    returns: ()

  - name: report_sponsored_message
    description: Report sponsored message
    parameters:
      - name: dialog_id
        type: DialogId
      - name: sponsored_message_id
        type: MessageId
      - name: option_id
        type: String
      - name: promise
        type: Promise<ReportSponsoredResult>
    returns: ()

  # Sponsored dialogs
  - name: get_search_sponsored_dialogs
    description: Search for sponsored dialogs
    parameters:
      - name: query
        type: String
      - name: promise
        type: Promise<sponsoredChats>
    returns: ()

  - name: view_sponsored_dialog
    description: Record that user viewed sponsored dialog
    parameters:
      - name: local_id
        type: i64
      - name: promise
        type: Promise<Unit>
    returns: ()

  - name: open_sponsored_dialog
    description: Record that user opened sponsored dialog
    parameters:
      - name: local_id
        type: i64
      - name: promise
        type: Promise<Unit>
    returns: ()

  - name: report_sponsored_dialog
    description: Report sponsored dialog
    parameters:
      - name: local_id
        type: i64
      - name: option_id
        type: String
      - name: promise
        type: Promise<ReportSponsoredResult>
    returns: ()

  # Video ads
  - name: get_video_sponsored_messages
    description: Get sponsored messages for video
    parameters:
      - name: message_full_id
        type: MessageFullId
      - name: promise
        type: Promise<videoMessageAdvertisements>
    returns: ()

  - name: view_video_advertisement
    description: Record that user viewed video ad
    parameters:
      - name: local_id
        type: i64
      - name: promise
        type: Promise<Unit>
    returns: ()

  - name: click_video_advertisement
    description: Record that user clicked video ad
    parameters:
      - name: local_id
        type: i64
      - name: promise
        type: Promise<Unit>
    returns: ()

  - name: report_video_advertisement
    description: Report video advertisement
    parameters:
      - name: local_id
        type: i64
      - name: option_id
        type: String
      - name: promise
        type: Promise<ReportSponsoredResult>
    returns: ()

methods (private):
  - name: delete_cached_sponsored_messages
    description: Delete cached messages for dialog
    parameters:
      - name: dialog_id
        type: DialogId
    returns: ()

  - name: delete_cached_sponsored_dialogs
    description: Delete cached dialogs
    parameters:
      - name: local_id
        type: i64
    returns: ()

  - name: delete_cached_sponsored_videos
    description: Delete cached video ads
    parameters:
      - name: local_id
        type: i64
    returns: ()

  - name: get_advertisement_sponsor_object
    description: Convert to TD API object
    parameters:
      - name: sponsored_message
        type: &SponsoredMessage
    returns: advertisementSponsor

  - name: get_sponsored_message_object
    description: Convert message to TD API object
    parameters:
      - name: dialog_id
        type: DialogId
      - name: sponsored_message
        type: &SponsoredMessage
    returns: sponsoredMessage

  - name: get_sponsored_messages_object
    description: Convert to TD API object
    parameters:
      - name: dialog_id
        type: DialogId
      - name: sponsored_messages
        type: &DialogSponsoredMessages
    returns: sponsoredMessages

  - name: get_sponsored_chat_object
    description: Convert dialog to TD API object
    parameters:
      - name: sponsored_dialog
        type: &SponsoredDialog
    returns: sponsoredChat

  - name: get_sponsored_chats_object
    description: Convert to TD API object
    parameters:
      - name: sponsored_dialogs
        type: &SponsoredDialogs
    returns: sponsoredChats

  - name: get_video_message_advertisement_object
    description: Convert video ad to TD API object
    parameters:
      - name: sponsored_message
        type: &SponsoredMessage
    returns: videoMessageAdvertisement

  - name: get_video_message_advertisements_object
    description: Convert to TD API object
    parameters:
      - name: sponsored_messages
        type: &VideoSponsoredMessages
    returns: videoMessageAdvertisements

  - name: on_get_dialog_sponsored_messages
    description: Handle sponsored messages response
    parameters:
      - name: dialog_id
        type: DialogId
      - name: result
        type: Result<messages_SponsoredMessages>
    returns: ()

  - name: on_get_search_sponsored_dialogs
    description: Handle search response
    parameters:
      - name: query
        type: String
      - name: result
        type: Result<contacts_SponsoredPeers>
    returns: ()

  - name: on_get_video_sponsored_messages
    description: Handle video ads response
    parameters:
      - name: message_full_id
        type: MessageFullId
      - name: result
        type: Result<messages_SponsoredMessages>
    returns: ()

methods (callbacks):
  - name: on_delete_cached_sponsored_messages_timeout_callback
    description: Static callback for message cache timeout
    parameters:
      - name: sponsored_message_manager_ptr
        type: *mut c_void
      - name: dialog_id_int
        type: i64
    returns: ()

  - name: on_delete_cached_sponsored_dialogs_timeout_callback
    description: Static callback for dialog cache timeout
    parameters:
      - name: sponsored_message_manager_ptr
        type: *mut c_void
      - name: local_id
        type: i64
    returns: ()

  - name: on_delete_cached_sponsored_videos_timeout_callback
    description: Static callback for video cache timeout
    parameters:
      - name: sponsored_message_manager_ptr
        type: *mut c_void
      - name: local_id
        type: i64
    returns: ()

traits:
  - Actor (from rustgram-actor)

tl_stubs_required:
  - name: sponsoredMessages
    description: |
      ```rust
      #[derive(Debug, Clone, PartialEq)]
      pub struct sponsoredMessages {
          pub messages: Vec<sponsoredMessage>,
      }
      ```

  - name: sponsoredMessage
    description: |
      ```rust
      #[derive(Debug, Clone, PartialEq)]
      pub struct sponsoredMessage {
          pub message_id: MessageId,
          pub sponsor: advertisementSponsor,
          pub text: String,
      }
      ```

  - name: advertisementSponsor
    description: |
      ```rust
      #[derive(Debug, Clone, PartialEq)]
      pub struct advertisementSponsor {
          pub sponsor: String,
          pub is_bot: bool,
          pub is_recommended: bool,
      }
      ```

  - name: sponsoredChats
    description: |
      ```rust
      #[derive(Debug, Clone, PartialEq)]
      pub struct sponsoredChats {
          pub chats: Vec<sponsoredChat>,
      }
      ```

  - name: sponsoredChat
    description: |
      ```rust
      #[derive(Debug, Clone, PartialEq)]
      pub struct sponsoredChat {
          pub dialog_id: DialogId,
          pub sponsor: String,
      }
      ```

  - name: videoMessageAdvertisements
    description: |
      ```rust
      #[derive(Debug, Clone, PartialEq)]
      pub struct videoMessageAdvertisements {
          pub ads: Vec<videoMessageAdvertisement>,
      }
      ```

  - name: videoMessageAdvertisement
    description: |
      ```rust
      #[derive(Debug, Clone, PartialEq)]
      pub struct videoMessageAdvertisement {
          pub local_id: i64,
          pub sponsor: String,
          pub is_recommended: bool,
      }
      ```

  - name: ReportSponsoredResult
    description: |
      ```rust
      #[derive(Debug, Clone, Copy, PartialEq, Eq)]
      pub enum ReportSponsoredResult {
          AdsHidden,
          AdsShown,
          PremiumRequired,
      }
      ```

missing_types_stubs:
  - name: MultiTimeout
    location: crates/multi_timeout/src/lib.rs
    priority: CRITICAL
    description: |
      Multiple timeout manager using tokio.

      ```rust
      use tokio::time::{Duration, Instant, sleep_until};

      /// Multiple timeout manager.
      pub struct MultiTimeout {
          name: String,
          timeout: Option<Instant>,
      }

      impl MultiTimeout {
          pub fn new(name: String) -> Self {
              Self {
                  name,
                  timeout: None,
              }
          }

          pub fn set_timeout(&mut self, delay: Duration) {
              self.timeout = Some(Instant::now() + delay);
          }

          pub fn cancel_timeout(&mut self) {
              self.timeout = None;
          }

          pub async fn next_timeout(&self) -> Option<Instant> {
              self.timeout
          }
      }
      ```

test_plan:
  unit_tests: 45
  doc_tests: 8

  test_categories:
    - name: manager_creation
      cases:
        - test_new_manager
        - test_tear_down
        - test_id_counters

    - name: dialog_messages
      cases:
        - test_get_dialog_sponsored_messages
        - test_view_sponsored_message
        - test_click_sponsored_message
        - test_report_sponsored_message
        - test_message_cache_timeout

    - name: sponsored_dialogs
      cases:
        - test_get_search_sponsored_dialogs
        - test_view_sponsored_dialog
        - test_open_sponsored_dialog
        - test_report_sponsored_dialog
        - test_dialog_cache_timeout

    - name: video_ads
      cases:
        - test_get_video_sponsored_messages
        - test_view_video_advertisement
        - test_click_video_advertisement
        - test_report_video_advertisement
        - test_video_cache_timeout

    - name: caching
      cases:
        - test_cache_invalidation
        - test_multi_timeout_usage
        - test_cache_expiration

    - name: conversions
      cases:
        - test_get_sponsored_message_object
        - test_get_sponsored_chat_object
        - test_get_video_ad_object

risk_register:
  - id: R1
    type: MISSING_DEPENDENCY
    description: MultiTimeout not implemented
    mitigation: Create tokio-based MultiTimeout in rustgram-multi-timeout
    impact: HIGH
    status: TBD

  - id: R2
    type: TL_INCOMPLETE
    description: TL sponsored types incomplete
    mitigation: Create comprehensive TL stubs
    impact: HIGH
    status: TBD

  - id: R3
    type: TIMEOUT_MANAGEMENT
    description: Complex timeout coordination
    mitigation: Use tokio::time for robust timeout handling
    impact: MEDIUM
    status: TBD

  - id: R4
    type: CONCURRENCY
    description: Concurrent cache access
    mitigation: Use Arc<RwLock<T>> for all caches
    impact: MEDIUM
    status: TBD

  - id: R5
    type: ID_GENERATION
    description: ID counter collision risk
    mitigation: Use AtomicU64 for thread-safe counters
    impact: LOW
    status: TBD

  - id: R6
    type: CALLBACK_SAFETY
    description: Static callback safety
    mitigation: Use proper lifetime management and unsafe bounds
    impact: MEDIUM
    status: TBD

implementation_notes: |
  Key Design Decisions:

  1. Caching Strategy:
     - Use FlatHashMap for O(1) cache lookups
     - Separate caches for messages, dialogs, videos
     - Automatic expiration via MultiTimeout

  2. Timeout Management:
     - Three separate MultiTimeout instances for different cache types
     - Static callbacks for timeout expiration
     - Automatic cache cleanup on timeout

  3. ID Generation:
     - Use current_sponsored_message_id for message IDs
     - Use current_local_id for local IDs
     - Incrementing counters ensure uniqueness

  4. Cache Invalidation:
     - Set timeout when cache is populated
     - Cancel timeout when cache is explicitly cleared
     - Callback triggers actual deletion

  5. Thread Safety:
     - Use Arc<RwLock<FlatHashMap>> for caches
     - AtomicU64 for ID counters
     - Proper synchronization for timeout callbacks

  Implementation Order:
  1. Create rustgram-multi-timeout crate with MultiTimeout
  2. Create TL stubs for all sponsored types
  3. Implement SponsoredMessageManager struct with basic fields
  4. Implement dialog message operations (get, view, click, report)
  5. Implement sponsored dialog operations
  6. Implement video ad operations
  7. Implement cache timeout management
  8. Add comprehensive tests

  Testing Strategy:
  - Test cache population and expiration
  - Test timeout callback handling
  - Test ID generation and uniqueness
  - Test concurrent access patterns
  - Test API conversion methods
  - Test error handling for network failures

references:
  - td/telegram/SponsoredMessageManager.h (primary)
  - td/telegram/SponsoredMessageManager.cpp (implementation)
  - td/actor/MultiTimeout.h (timeout utility)
